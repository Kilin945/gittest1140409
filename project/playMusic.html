<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>🎵 YouTube 音樂播放器</title>
        <!-- Font Awesome 圖標庫 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
            .back-button {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 50px;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
                transition: all 0.3s ease;
                font-weight: bold;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }

            .back-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            }

            .control-buttons {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 15px;
                margin: 15px 0;
            }

            .control-btn {
                padding: 12px 16px;
                background: #ff6b35;
                color: white;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 16px;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .control-btn:hover {
                background: #e55a2e;
                transform: scale(1.1);
            }

            .control-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }

            .main-play-btn {
                width: 60px;
                height: 60px;
                font-size: 20px;
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
            }

            .main-play-btn:hover {
                background: linear-gradient(135deg, #e55a2e, #d1512a);
            }
        </style>
    </head>
    <body>
        <!-- 返回音樂系統首頁按鈕 -->
        <button class="back-button" onclick="goBackToMusicSystem()">
            <i class="fas fa-arrow-left"></i>
            返回音樂系統首頁
        </button>

        <div style="max-width: 1200px; margin: 0 auto; padding: 60px 20px 20px; font-family: Arial, sans-serif">
            <div style="text-align: center; margin-bottom: 30px">
                <h1><i class="fas fa-music"></i> YouTube 音樂播放器</h1>
                <p>選擇播放清單，享受音樂時光</p>
            </div>

            <!-- YouTube 認證區域 -->
            <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px">
                <h3><i class="fas fa-key"></i> YouTube 認證</h3>
                <div style="display: flex; gap: 15px; align-items: center; margin: 15px 0">
                    <!-- 簡化按鈕，移除複雜的狀態控制 -->
                    <button
                        onclick="handleAuthClick()"
                        id="auth-btn"
                        style="
                            padding: 10px 20px;
                            background: #ff6b35;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        "
                    >
                        <i class="fas fa-sign-in-alt"></i> 登入 Google 帳號
                    </button>
                    <button
                        onclick="handleSignoutClick()"
                        id="signout-btn"
                        style="
                            display: none;
                            padding: 10px 20px;
                            background: #666;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        "
                    >
                        <i class="fas fa-sign-out-alt"></i> 登出
                    </button>
                    <span id="auth-status" style="color: #666">點擊按鈕登入 Google 帳號</span>
                </div>
            </div>

            <!-- 播放清單選擇 -->
            <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px">
                <h3><i class="fas fa-list"></i> 選擇播放清單</h3>
                <select
                    id="playlist-select"
                    style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px"
                >
                    <option value="">請選擇播放清單...</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px">
                <!-- 左側：播放清單歌曲列表 -->
                <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px">
                    <h3><i class="fas fa-headphones"></i> 待播放歌曲</h3>
                    <div id="songs-list">
                        <div style="text-align: center; padding: 40px; color: #666">
                            <i class="fas fa-music" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3"></i>
                            <p>請先選擇播放清單</p>
                        </div>
                    </div>
                </div>

                <!-- 右側：YouTube 播放器 -->
                <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px">
                    <h3><i class="fas fa-play-circle"></i> 正在播放</h3>

                    <div
                        id="current-song-info"
                        style="
                            display: none;
                            background: #f5f5f5;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 10px 0;
                            border: 1px solid #ddd;
                        "
                    >
                        <div id="current-song-name" style="font-weight: bold; margin-bottom: 5px">歌曲名稱</div>
                        <div id="current-artist-name" style="color: #666">歌手名稱</div>
                        <div id="song-position" style="color: #999; font-size: 12px; margin-top: 5px">
                            第 1 首，共 10 首
                        </div>
                    </div>

                    <div
                        id="youtube-player"
                        style="width: 100%; height: 315px; background: #000; margin: 10px 0; border: 1px solid #ccc"
                    ></div>

                    // 增強的播放控制按鈕
                    <div class="control-buttons">
                        <button onclick="playPreviousSong()" id="prev-btn" class="control-btn" disabled title="上一首">
                            <i class="fas fa-step-backward"></i>
                        </button>

                        <button
                            onclick="togglePlayPause()"
                            id="play-pause-btn"
                            class="control-btn main-play-btn"
                            disabled
                            title="播放/暫停"
                        >
                            <i class="fas fa-play"></i>
                        </button>

                        <button onclick="playNextSong()" id="next-btn" class="control-btn" disabled title="下一首">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>

                    <div
                        id="player-status"
                        style="
                            text-align: center;
                            padding: 10px;
                            background: #f5f5f5;
                            border-radius: 8px;
                            border: 1px solid #ddd;
                        "
                    >
                        請選擇播放清單開始播放
                    </div>
                </div>
            </div>
        </div>

        <!-- Google APIs -->
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <script src="https://apis.google.com/js/api.js" async defer></script>
        <!-- YouTube API -->
        <script src="https://www.youtube.com/iframe_api"></script>

        <script>
            // 修正版本：根據環境自動切換 API 端點
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            console.log("🔍 當前環境檢測:", {
                hostname: currentHostname,
                origin: currentOrigin,
                href: window.location.href,
            });

            // 根據環境設定 API 端點
            let API_BASE;

            if (currentHostname.includes("github.io")) {
                // GitHub Pages 環境
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("☁️ GitHub Pages 環境，使用 Railway 後端");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // 本地開發環境
                API_BASE = "http://localhost:8000/api";
                console.log("🏠 本地開發環境");
            } else if (currentHostname.includes("railway.app")) {
                // 直接訪問 Railway 應用
                API_BASE = currentOrigin + "/api";
                console.log("🚂 Railway 環境，使用相對路徑");
            } else {
                // 其他環境，預設使用 Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("🌐 未知環境，預設使用 Railway 後端");
            }

            console.log("📡 最終 API_BASE:", API_BASE);

            // 🆕 返回音樂系統首頁功能
            function goBackToMusicSystem() {
                console.log("🔙 返回音樂系統首頁");

                // 如果正在播放，詢問是否確認離開
                if (ytPlayer && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                    if (confirm("音樂正在播放中，確定要離開嗎？")) {
                        ytPlayer.pauseVideo();
                        window.location.href = "sidebar.html";
                    }
                } else {
                    window.location.href = "sidebar.html";
                }
            }

            // 🆕 播放上一首歌曲
            function playPreviousSong() {
                console.log("⏮️ 播放上一首");

                if (currentPlaylist.length === 0) {
                    console.log("❌ 播放清單為空");
                    return;
                }

                if (currentSongIndex <= 0) {
                    // 如果已經是第一首，循環到最後一首
                    const newIndex = currentPlaylist.length - 1;
                    console.log(`🔄 循環到最後一首: ${newIndex}`);
                    playSong(newIndex);
                } else {
                    const newIndex = currentSongIndex - 1;
                    console.log(`⏮️ 播放上一首: ${newIndex}`);
                    playSong(newIndex);
                }
            }

            // 🆕 播放下一首歌曲
            function playNextSong() {
                console.log("⏭️ 播放下一首");

                if (currentPlaylist.length === 0) {
                    console.log("❌ 播放清單為空");
                    return;
                }

                if (currentSongIndex >= currentPlaylist.length - 1) {
                    // 如果已經是最後一首，循環到第一首
                    console.log("🔄 循環到第一首: 0");
                    playSong(0);
                } else {
                    const newIndex = currentSongIndex + 1;
                    console.log(`⏭️ 播放下一首: ${newIndex}`);
                    playSong(newIndex);
                }
            }

            // 🆕 更新控制按鈕狀態
            function updateControlButtons() {
                const prevBtn = document.getElementById("prev-btn");
                const nextBtn = document.getElementById("next-btn");
                const playPauseBtn = document.getElementById("play-pause-btn");

                const hasPlaylist = currentPlaylist.length > 0;

                // 只要有播放清單就啟用所有按鈕（支援循環播放）
                prevBtn.disabled = !hasPlaylist;
                nextBtn.disabled = !hasPlaylist;
                playPauseBtn.disabled = !hasPlaylist;
            }

            // 🆕 更新歌曲位置顯示
            function updateSongPosition() {
                const songPosition = document.getElementById("song-position");
                if (currentSongIndex >= 0 && currentPlaylist.length > 0) {
                    songPosition.textContent = `第 ${currentSongIndex + 1} 首，共 ${currentPlaylist.length} 首`;
                } else {
                    songPosition.textContent = "";
                }
            }

            console.log("🎵 YouTube 音樂播放器初始化");

            // 定義google OAuth 客戶端ID
            const CLIENT_ID = "407957494432-ickpd56p77suvnamqdrltgid9djfjvd3.apps.googleusercontent.com";
            const SCOPES = "https://www.googleapis.com/auth/youtube.readonly";
            const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest";

            // 全域變數
            let ytPlayer = null; // YouTube 播放器實例
            let currentPlaylist = []; // 目前的播放清單（歌曲陣列）
            let currentSongIndex = -1; // 目前播放歌曲的索引位置（-1 表示未選擇）
            let allSongsData = []; // 從 API 載入的所有歌曲資料
            let allArtistsData = []; // 從 API 載入的所有歌手資料
            let isPlayerReady = false; // YouTube 播放器是否已準備就緒

            // Google API 變數
            let tokenClient; // OAuth 權杖客戶端實例
            let gapiInited = false; // Google APIs 客戶端是否已初始化
            let gisInited = false; // Google Identity Services 是否已初始化

            // YouTube API 準備完成後的回調
            window.onYouTubeIframeAPIReady = function () {
                console.log("📺 YouTube API 已準備就緒");
                initializeYouTubePlayer();
            };

            // 初始化 YouTube 播放器
            function initializeYouTubePlayer() {
                ytPlayer = new YT.Player("youtube-player", {
                    height: "315",
                    width: "100%",
                    playerVars: {
                        playsinline: 1, // 在 iOS 裝置上內嵌播放（不全螢幕）
                        controls: 1, // 顯示播放控制按鈕（播放/暫停等）
                        rel: 0, // 影片結束後不顯示相關影片建議
                        showinfo: 0, // 不顯示影片標題和上傳者資訊
                        autoplay: 0, // 不自動播放
                        origin: window.location.origin, // 允許嵌入的來源
                        enablejsapi: 1, // 啟用 JavaScript API
                        modestbranding: 1, // 減少 YouTube 品牌標誌
                        fs: 1, // 允許全螢幕按鈕
                    },
                    events: {
                        onReady: onPlayerReady, // 播放器準備完成時觸發
                        onStateChange: onPlayerStateChange, // 播放狀態改變時觸發（播放/暫停/結束等）
                        onError: onPlayerError, // 播放錯誤時觸發
                    },
                });
            }

            // 播放器準備完成，選歌
            function onPlayerReady(event) {
                console.log("✅ YouTube 播放器已準備就緒");
                isPlayerReady = true;
                updatePlayerStatus("播放器已準備就緒，請選擇歌曲"); //更新播放器狀態區域的顯示文字
            }

            // 播放器狀態改變
            function onPlayerStateChange(event) {
                const playPauseBtn = document.getElementById("play-pause-btn");

                switch (event.data) {
                    case YT.PlayerState.ENDED:
                        console.log("🔚 歌曲播放結束");
                        updatePlayerStatus("歌曲播放結束");
                        // 🆕 自動播放下一首
                        setTimeout(() => {
                            playNextSong();
                        }, 1000);
                        break;
                    case YT.PlayerState.PLAYING:
                        console.log("▶️ 正在播放");
                        updatePlayerStatus("正在播放");
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        break;
                    case YT.PlayerState.PAUSED:
                        console.log("⏸️ 已暫停");
                        updatePlayerStatus("已暫停");
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        break;
                    case YT.PlayerState.BUFFERING:
                        console.log("⏳ 緩衝中");
                        updatePlayerStatus("緩衝中...");
                        break;
                }
            }

            // 播放器錯誤處理
            function onPlayerError(event) {
                console.error("❌ YouTube 播放器錯誤:", event.data);

                let errorMessage = "播放錯誤";
                switch (event.data) {
                    case 2:
                        errorMessage = "影片 ID 無效";
                        break;
                    case 5:
                        errorMessage = "HTML5 播放器錯誤";
                        break;
                    case 100:
                        errorMessage = "影片不存在或已被移除";
                        break;
                    case 101:
                    case 150:
                        errorMessage = "影片擁有者不允許嵌入播放";
                        break;
                    default:
                        errorMessage = `未知錯誤 (代碼: ${event.data})`;
                }

                updatePlayerStatus(errorMessage);

                // 🆕 播放錯誤時自動跳到下一首
                setTimeout(() => {
                    console.log("🔄 播放錯誤，嘗試播放下一首");
                    playNextSong();
                }, 2000);
            }

            // Google API 載入 (參考你的Demo)
            function gapiLoaded() {
                console.log("🔄 開始載入 GAPI...");
                gapi.load("client", async () => {
                    await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                    gapiInited = true;
                    console.log("✅ GAPI 已載入");
                });
            }

            // 修改 gisLoaded 函數，加強錯誤處理
            function gisLoaded() {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        ux_mode: "popup",
                        callback: (tokenResponse) => {
                            console.log("🎉 OAuth 回調成功:", tokenResponse);

                            if (tokenResponse.error) {
                                console.error("❌ OAuth 錯誤:", tokenResponse.error);
                                document.getElementById("auth-status").textContent =
                                    "❌ 認證失敗: " + tokenResponse.error;
                                return;
                            }

                            gapi.client.setToken(tokenResponse);
                            document.getElementById("auth-status").textContent = "✅ 已登入";
                            document.getElementById("auth-btn").style.display = "none";
                            document.getElementById("signout-btn").style.display = "inline-block";
                            console.log("✅ 登入成功！");
                        },
                        error_callback: (error) => {
                            console.error("❌ OAuth 初始化錯誤:", error);
                            document.getElementById("auth-status").textContent = "❌ OAuth 初始化失敗";
                        },
                    });
                    gisInited = true;
                    console.log("✅ GIS 已載入");
                } catch (error) {
                    console.error("❌ GIS 載入失敗:", error);
                    document.getElementById("auth-status").textContent = "❌ GIS 載入失敗";
                }
            }

            // 改善的登入處理函數
            function handleAuthClick() {
                console.log("🔑 點擊登入按鈕");

                // 檢查當前環境
                console.log("🌐 當前環境:", {
                    hostname: window.location.hostname,
                    origin: window.location.origin,
                    url: window.location.href,
                });

                // 更新狀態
                document.getElementById("auth-status").textContent = "⏳ 正在開啟登入視窗...";

                // 檢查API是否準備好
                if (!gapiInited || !gisInited) {
                    console.log("⚠️ API 尚未準備好");
                    document.getElementById("auth-status").textContent = "⚠️ API 尚未準備好，請稍候再試";

                    // 等待 API 載入
                    setTimeout(() => {
                        if (gapiInited && gisInited) {
                            console.log("✅ API 現在準備好了，重新嘗試登入");
                            handleAuthClick();
                        } else {
                            console.error("❌ API 載入逾時");
                            document.getElementById("auth-status").textContent = "❌ API 載入失敗，請重新整理頁面";
                        }
                    }, 3000);
                    return;
                }

                if (!tokenClient) {
                    console.error("❌ tokenClient 未初始化");
                    document.getElementById("auth-status").textContent = "❌ 登入客戶端未初始化";
                    return;
                }

                console.log("🚀 開始 OAuth 認證流程");

                try {
                    // 使用 prompt: 'select_account' 讓使用者可以選擇帳號
                    tokenClient.requestAccessToken({
                        prompt: "select_account",
                        include_granted_scopes: true,
                    });
                } catch (error) {
                    console.error("❌ 登入失敗:", error);
                    document.getElementById("auth-status").textContent = "❌ 登入失敗: " + error.message;
                }
            }

            // 處理登出
            function handleSignoutClick() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken("");
                    document.getElementById("auth-status").textContent = "尚未登入";
                    document.getElementById("auth-btn").style.display = "inline-block";
                    document.getElementById("signout-btn").style.display = "none";
                    console.log("🔓 已登出");
                }
            }

            // 🆕 增強版：搜尋 YouTube 影片並自動儲存到資料庫
            async function searchYouTubeVideo(songName, artistName) {
                try {
                    console.log(`🔍 搜尋YouTube影片: ${artistName} - ${songName}`);

                    const token = gapi.client.getToken();
                    if (!token) {
                        throw new Error("請先登入 Google 帳號");
                    }

                    // 🎯 使用多種搜尋關鍵字策略
                    const searchQueries = [
                        `${artistName} ${songName}`,
                        `${songName} ${artistName}`,
                        `${artistName} - ${songName}`,
                        `${songName}`,
                    ];

                    let bestVideo = null;

                    for (const query of searchQueries) {
                        console.log(`🔍 嘗試搜尋關鍵字: "${query}"`);

                        const response = await gapi.client.youtube.search.list({
                            part: "snippet",
                            q: query,
                            type: "video",
                            maxResults: 10, // 增加搜尋結果數量
                            videoEmbeddable: "true",
                            videoSyndicated: "true",
                            videoLicense: "any",
                            order: "relevance",
                            regionCode: "TW", // 🇹🇼 針對台灣地區搜尋
                        });

                        if (response.result.items && response.result.items.length > 0) {
                            console.log(`✅ 找到 ${response.result.items.length} 個搜尋結果`);

                            // 🎯 選擇最相關的影片
                            for (const video of response.result.items) {
                                const videoId = video.id.videoId;
                                const title = video.snippet.title.toLowerCase();
                                const channel = video.snippet.channelTitle.toLowerCase();

                                // 🔍 檢查影片標題是否包含歌曲名稱和歌手名稱
                                const songInTitle = title.includes(songName.toLowerCase());
                                const artistInTitle = title.includes(artistName.toLowerCase()) ||
                                                     channel.includes(artistName.toLowerCase());

                                console.log(`🎵 檢查影片: ${video.snippet.title}`);
                                console.log(`   - 歌曲名稱匹配: ${songInTitle}`);
                                console.log(`   - 歌手名稱匹配: ${artistInTitle}`);

                                // 檢查影片是否可嵌入
                                const isEmbeddable = await checkVideoEmbeddable(videoId);

                                if (isEmbeddable && (songInTitle || artistInTitle)) {
                                    const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;

                                    console.log(`✅ 找到合適的影片:`, {
                                        title: video.snippet.title,
                                        channel: video.snippet.channelTitle,
                                        videoId: videoId,
                                        url: videoUrl,
                                        searchQuery: query
                                    });

                                    return {
                                        videoId: videoId,
                                        videoUrl: videoUrl,
                                        title: video.snippet.title,
                                        channel: video.snippet.channelTitle,
                                    };
                                }
                            }
                        }
                    }

                    // 如果沒有找到完全匹配的，使用第一個可嵌入的影片
                    console.log("⚠️ 沒有找到完全匹配的影片，使用第一個可用的結果");

                    const fallbackResponse = await gapi.client.youtube.search.list({
                        part: "snippet",
                        q: `${artistName} ${songName}`,
                        type: "video",
                        maxResults: 5,
                        videoEmbeddable: "true",
                        order: "relevance",
                    });

                    if (fallbackResponse.result.items && fallbackResponse.result.items.length > 0) {
                        const video = fallbackResponse.result.items[0];
                        const videoId = video.id.videoId;
                        const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;

                        console.log(`📺 使用備選影片: ${video.snippet.title}`);

                        return {
                            videoId: videoId,
                            videoUrl: videoUrl,
                            title: video.snippet.title,
                            channel: video.snippet.channelTitle,
                        };
                    }

                    throw new Error("找不到可播放的影片");

                } catch (searchError) {
                    console.error(`❌ 搜尋失敗:`, searchError);
                    throw searchError;
                }
            }

            // 從MySQL資料庫中取得的YouTube URL
            function extractVideoId(url) {
                const regex =
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }

            // 檢查影片是否可嵌入
            async function checkVideoEmbeddable(videoId) {
                try {
                    const response = await gapi.client.youtube.videos.list({
                        part: "status",
                        id: videoId,
                    });

                    if (response.result.items && response.result.items.length > 0) {
                        const embeddable = response.result.items[0].status.embeddable;
                        console.log(`📺 影片 ${videoId} 可嵌入: ${embeddable}`);
                        return embeddable;
                    }
                    return false;
                } catch (error) {
                    console.log(`⚠️ 無法檢查影片嵌入狀態: ${error}`);
                    return true; // 如果無法檢查，假設可以嵌入
                }
            }

            // 🔧 修正 YouTube URL 更新問題
            async function updateSongYouTubeUrl(songId, youtubeUrl) {
                try {
                    console.log(`📝 開始更新歌曲 ${songId} 的 YouTube URL: ${youtubeUrl}`);

                    const songData = allSongsData.find((s) => s.song_id == songId);
                    if (!songData) {
                        throw new Error(`找不到歌曲 ID: ${songId}`);
                    }

                    // 🎯 特別針對 Railway 環境，使用完整的資料格式
                    const updateData = {
                        table: "songs",
                        song_id: parseInt(songId), // 確保是數字
                        song_name: songData.song_name,
                        artist_id: parseInt(songData.artist_id), // 確保是數字
                        music_category: songData.music_category || "流行",
                        youtube_link: youtubeUrl,
                        state: 0,
                    };

                    // 確保 album_id 正確處理
                    if (songData.album_id && songData.album_id !== null && songData.album_id !== "" && songData.album_id !== "NULL") {
                        updateData.album_id = parseInt(songData.album_id);
                    }

                    console.log("📤 發送到 Railway 的更新資料:", updateData);
                    console.log("🌐 API 端點:", `${API_BASE}/2/update`);

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json",
                        },
                        body: JSON.stringify(updateData),
                    });

                    console.log("🌐 Railway API 回應狀態:", response.status);

                    const responseText = await response.text();
                    console.log("🌐 Railway API 回應內容:", responseText);

                    if (!response.ok) {
                        throw new Error(`Railway API 錯誤 ${response.status}: ${responseText}`);
                    }

                    let result;
                    try {
                        result = responseText ? JSON.parse(responseText) : {};
                    } catch (parseError) {
                        console.log("⚠️ 回應不是 JSON 格式:", responseText);
                        result = { message: responseText };
                    }

                    console.log(`✅ Railway 資料庫更新成功 - 歌曲 ${songId}`);
                    console.log("📋 Railway 更新結果:", result);

                    // 🔄 更新本地快取
                    const songIndex = allSongsData.findIndex((s) => s.song_id == songId);
                    if (songIndex !== -1) {
                        allSongsData[songIndex].youtube_link = youtubeUrl;
                        console.log(`✅ 本地快取已更新`);
                    }

                    // 🔄 更新播放清單快取
                    const playlistSongIndex = currentPlaylist.findIndex((s) => s.song_id == songId);
                    if (playlistSongIndex !== -1) {
                        currentPlaylist[playlistSongIndex].youtube_url = youtubeUrl;
                        console.log(`✅ 播放清單快取已更新`);
                        displayPlaylistSongs(); // 重新顯示以更新圖示
                    }

                    updatePlayerStatus(`✅ YouTube 連結已儲存到 Railway 資料庫：${songData.song_name}`);
                    return result;

                } catch (error) {
                    console.error(`❌ Railway 資料庫更新失敗:`, error);
                    console.error("❌ 錯誤詳情:", {
                        message: error.message,
                        songId: songId,
                        youtubeUrl: youtubeUrl,
                        API_BASE: API_BASE
                    });

                    updatePlayerStatus(`❌ Railway 資料庫更新失敗: ${error.message}`);
                    return null;
                }
            }
            }

            // 播放指定歌曲
            async function playSong(index) {
                console.log(`🎵 嘗試播放歌曲 index: ${index}`);

                if (!isPlayerReady) {
                    console.error("❌ YouTube 播放器尚未準備就緒");
                    return;
                }

                if (index < 0 || index >= currentPlaylist.length) {
                    console.error(`❌ 索引超出範圍: ${index}, 播放清單長度: ${currentPlaylist.length}`);
                    return;
                }

                const song = currentPlaylist[index];
                console.log("🎵 播放歌曲資料:", song);

                // 檢查歌曲資料是否完整
                if (!song || !song.song_name || song.song_name === "未知歌曲") {
                    console.error("❌ 歌曲資料不完整:", song);
                    return;
                }

                currentSongIndex = index;
                updateCurrentSongDisplay();
                updateSongPosition(); // 🆕 更新歌曲位置顯示

                try {
                    let videoId = null;

                    if (song.youtube_url) {
                        videoId = extractVideoId(song.youtube_url);
                        console.log("✅ 使用現有YouTube URL");
                    }

                    // 檢查是否已登入
                    const token = gapi.client.getToken();
                    if (!token) {
                        console.error("❌ 尚未登入Google帳號");
                        updatePlayerStatus("請先登入Google帳號才能搜尋歌曲");
                        return;
                    }

                    if (!videoId) {
                        console.log("🔍 沒有YouTube URL，開始搜尋...");
                        updatePlayerStatus(`🔍 正在搜尋: ${song.song_name} - ${song.artist_name}`);

                        try {
                            const searchResult = await searchYouTubeVideo(song.song_name, song.artist_name);
                            videoId = searchResult.videoId;

                            console.log("💾 搜尋成功，開始儲存到資料庫...");
                            updatePlayerStatus(`💾 正在儲存 YouTube 連結到資料庫...`);

                            // 🎯 重要：呼叫更新資料庫的函數
                            const updateResult = await updateSongYouTubeUrl(song.song_id, searchResult.videoUrl);

                            if (updateResult) {
                                console.log("✅ YouTube 連結已成功儲存到資料庫");
                                updatePlayerStatus(`✅ 已儲存: ${song.song_name} 的 YouTube 連結`);
                            } else {
                                console.warn("⚠️ 儲存到資料庫失敗，但繼續播放");
                                updatePlayerStatus(`⚠️ 播放成功，但儲存連結失敗`);
                            }

                        } catch (searchError) {
                            console.error("❌ 搜尋失敗:", searchError);
                            updatePlayerStatus(`❌ 搜尋失敗: ${searchError.message}`);
                            return;
                        }
                    }

                    if (!videoId) {
                        throw new Error("無法取得有效的影片ID");
                    }

                    ytPlayer.loadVideoById(videoId);
                    updatePlayerStatus(`正在播放: ${song.song_name} - ${song.artist_name}`);
                } catch (error) {
                    console.error("❌ 播放失敗:", error);
                    updatePlayerStatus(`播放失敗`);
                }
            }

            // 修正後的資料載入函數（支援離線模式）
            async function loadPlaylists() {
                try {
                    console.log("🔄 載入播放清單...");

                    // 檢查是否在 GitHub Pages 且沒有雲端後端
                    if (currentHostname.includes("github.io") && API_BASE.includes("localhost")) {
                        console.warn("⚠️ 在 GitHub Pages 環境下無法連接本地資料庫，載入模擬資料");
                        loadMockData();
                        return;
                    }

                    const response = await fetch(`${API_BASE}/playlists`);
                    if (!response.ok) throw new Error(`HTTP錯誤: ${response.status}`);
                    const playlists = await response.json();

                    const playlistSelect = document.getElementById("playlist-select");
                    playlistSelect.innerHTML = '<option value="">請選擇播放清單...</option>';

                    playlists.forEach((playlist) => {
                        const option = document.createElement("option");
                        option.value = playlist.playlist_id;
                        option.textContent = `${playlist.playlist_name} ${playlist.is_public ? "(公開)" : "(私人)"}`;
                        playlistSelect.appendChild(option);
                    });

                    console.log("✅ 播放清單載入完成，數量：", playlists.length);
                } catch (error) {
                    console.error("❌ 載入播放清單失敗:", error);

                    if (currentHostname.includes("github.io")) {
                        console.log("🔄 GitHub Pages 環境，載入模擬資料");
                        loadMockData();
                    } else {
                        throw error;
                    }
                }
            }

            // 模擬資料（供 GitHub Pages 測試用）
            function loadMockData() {
                console.log("📋 載入模擬資料");

                // 模擬播放清單
                const mockPlaylists = [
                    { playlist_id: 1, playlist_name: "我的最愛", is_public: false },
                    { playlist_id: 2, playlist_name: "流行歌曲", is_public: true },
                ];

                const playlistSelect = document.getElementById("playlist-select");
                playlistSelect.innerHTML = '<option value="">請選擇播放清單...</option>';

                mockPlaylists.forEach((playlist) => {
                    const option = document.createElement("option");
                    option.value = playlist.playlist_id;
                    option.textContent = `${playlist.playlist_name} (模擬資料)`;
                    playlistSelect.appendChild(option);
                });

                // 模擬歌曲資料
                allSongsData = [
                    { song_id: 1, song_name: "告白氣球", artist_id: 1, youtube_url: null },
                    { song_id: 2, song_name: "稻香", artist_id: 1, youtube_url: null },
                ];

                allArtistsData = [{ artist_id: 1, artist_name: "周杰倫" }];

                console.log("✅ 模擬資料載入完成");
            }

            // 載入歌手資料
            async function loadArtists() {
                try {
                    console.log("🔄 載入歌手資料...");
                    const response = await fetch(`${API_BASE}/artists`);
                    if (!response.ok) throw new Error(`HTTP錯誤: ${response.status}`);
                    allArtistsData = await response.json();
                    console.log("✅ 歌手資料載入完成，數量：", allArtistsData.length);
                } catch (error) {
                    console.error("❌ 載入歌手失敗:", error);
                    allArtistsData = [];
                    throw error; // 重新拋出錯誤以便上層處理
                }
            }

            // 載入歌曲資料
            async function loadSongs() {
                try {
                    const response = await fetch(`${API_BASE}/songs`);
                    if (!response.ok) throw new Error(`HTTP錯誤: ${response.status}`);
                    allSongsData = await response.json();
                    console.log("✅ 歌曲資料載入完成");
                } catch (error) {
                    console.error("❌ 載入歌曲失敗:", error);
                    allSongsData = [];
                }
            }

            // 在 loadPlaylistSongs 函數開頭加入檢查
            async function loadPlaylistSongs(playlistId) {
                try {
                    console.log("🔄 載入播放清單歌曲:", playlistId);

                    // 🔍 除錯：檢查基礎資料狀態
                    console.log("📊 基礎資料檢查:");
                    console.log("  - allSongsData 數量:", allSongsData.length);
                    console.log("  - allArtistsData 數量:", allArtistsData.length);
                    console.log("  - API_BASE:", API_BASE);

                    if (allSongsData.length === 0) {
                        console.error("❌ 歌曲資料尚未載入！");
                        alert("歌曲資料尚未載入，請重新整理頁面");
                        return;
                    }

                    if (allArtistsData.length === 0) {
                        console.error("❌ 歌手資料尚未載入！");
                        alert("歌手資料尚未載入，請重新整理頁面");
                        return;
                    }

                    // 先測試API端點是否存在
                    const apiUrl = `${API_BASE}/playlist_songs?playlist_id=${playlistId}`;
                    console.log("📡 API URL:", apiUrl);

                    const response = await fetch(apiUrl);
                    console.log("📡 API Response Status:", response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP錯誤: ${response.status}`);
                    }

                    const playlistSongs = await response.json();
                    console.log("📋 原始播放清單歌曲資料:", playlistSongs);
                    console.log("📊 播放清單歌曲數量:", playlistSongs.length);

                    if (playlistSongs.length === 0) {
                        console.log("⚠️ 播放清單沒有歌曲");
                        currentPlaylist = [];
                        displayPlaylistSongs();
                        return;
                    }

                    currentPlaylist = playlistSongs.map((ps) => {
                        const song = allSongsData.find((s) => s.song_id == ps.song_id);
                        const artist = allArtistsData.find((a) => a.artist_id == song?.artist_id);

                        console.log(`🎵 處理歌曲 ${ps.song_id}:`, {
                            songFound: !!song,
                            artistFound: !!artist,
                            songName: song?.song_name,
                            artistName: artist?.artist_name,
                            youtubeUrl: song?.youtube_url,
                        });

                        return {
                            ...ps,
                            song_name: song?.song_name || "未知歌曲",
                            artist_name: artist?.artist_name || "未知歌手",
                            youtube_url: song?.youtube_link || null, // 🔧 修正：使用 youtube_link
                        };
                    });

                    console.log("🎼 最終播放清單:", currentPlaylist);
                    displayPlaylistSongs();
                    console.log("✅ 播放清單歌曲載入完成");
                } catch (error) {
                    console.error("❌ 載入播放清單歌曲失敗:", error);
                    alert(`載入播放清單失敗: ${error.message}`);
                    currentPlaylist = [];
                    displayPlaylistSongs();
                }
            }

            // 顯示播放清單歌曲
            function displayPlaylistSongs() {
                const songsList = document.getElementById("songs-list");

                if (currentPlaylist.length === 0) {
                    songsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-music" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p>此播放清單沒有歌曲</p>
                        </div>
                    `;
                    disableControls();
                    return;
                }

                songsList.innerHTML = "";

                currentPlaylist.forEach((song, index) => {
                    const songItem = document.createElement("div");
                    songItem.style.cssText = `
                        display: flex; align-items: center; padding: 12px; margin-bottom: 8px;
                        border-radius: 8px; cursor: pointer; transition: all 0.3s;
                        border: 2px solid transparent; background: #f5f5f5;
                    `;
                    songItem.dataset.index = index;

                    const hasYouTubeUrl = song.youtube_url && song.youtube_url.trim() !== "";
                    const statusIcon = hasYouTubeUrl
                        ? '<i class="fas fa-play-circle" style="color: green; margin-left: 8px;" title="有YouTube連結"></i>'
                        : '<i class="fas fa-search" style="color: orange; margin-left: 8px;" title="需要搜尋YouTube連結"></i>';

                    songItem.innerHTML = `
                        <div style="width: 30px; text-align: center; font-weight: bold; margin-right: 15px; color: #ff6b35;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 4px;">
                                ${song.song_name}
                                ${statusIcon}
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${song.artist_name}
                            </div>
                        </div>
                    `;

                    songItem.addEventListener("click", () => playSong(index));
                    songItem.addEventListener("mouseenter", () => {
                        songItem.style.background = "#e5e7eb";
                        songItem.style.borderColor = "#ff6b35";
                        songItem.style.transform = "translateX(4px)";
                    });
                    songItem.addEventListener("mouseleave", () => {
                        if (!songItem.classList.contains("playing")) {
                            songItem.style.background = "#f5f5f5";
                            songItem.style.borderColor = "transparent";
                            songItem.style.transform = "translateX(0)";
                        }
                    });

                    songsList.appendChild(songItem);
                });

                enableControls();

                const songsWithUrl = currentPlaylist.filter(
                    (song) => song.youtube_url && song.youtube_url.trim() !== ""
                ).length;
                const songsNeedSearch = currentPlaylist.length - songsWithUrl;

                let statusMessage = `載入了 ${currentPlaylist.length} 首歌曲`;
                if (songsNeedSearch > 0) {
                    statusMessage += `，其中 ${songsNeedSearch} 首需要搜尋YouTube連結`;
                }

                updatePlayerStatus(statusMessage + "，點擊歌曲開始播放");
            }

            // 播放/暫停切換
            function togglePlayPause() {
                if (!ytPlayer || !isPlayerReady) return;

                const state = ytPlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) {
                    ytPlayer.pauseVideo();
                } else if (state === YT.PlayerState.PAUSED) {
                    ytPlayer.playVideo();
                } else if (currentPlaylist.length > 0) {
                    playSong(currentSongIndex >= 0 ? currentSongIndex : 0);
                }
            }

            // 更新當前歌曲顯示
            function updateCurrentSongDisplay() {
                document.querySelectorAll("[data-index]").forEach((item) => {
                    item.classList.remove("playing");
                    item.style.background = "#f5f5f5";
                    item.style.borderColor = "transparent";
                    item.style.transform = "translateX(0)";
                    item.style.color = "";
                });

                if (currentSongIndex >= 0) {
                    const currentSongElement = document.querySelector(`[data-index="${currentSongIndex}"]`);
                    if (currentSongElement) {
                        currentSongElement.classList.add("playing");
                        currentSongElement.style.background = "linear-gradient(135deg, #ff6b35, #e55a2e)";
                        currentSongElement.style.color = "white";
                        currentSongElement.style.borderColor = "#ff6b35";
                    }

                    const song = currentPlaylist[currentSongIndex];
                    document.getElementById("current-song-name").textContent = song.song_name;
                    document.getElementById("current-artist-name").textContent = song.artist_name;
                    document.getElementById("current-song-info").style.display = "block";
                }
            }

            // 重置當前歌曲顯示
            function resetCurrentSongDisplay() {
                document.querySelectorAll("[data-index]").forEach((item) => {
                    item.classList.remove("playing");
                    item.style.background = "#f5f5f5";
                    item.style.color = "";
                    item.style.borderColor = "transparent";
                });
                document.getElementById("current-song-info").style.display = "none";
                currentSongIndex = -1;
                updateSongPosition(); // 🆕 更新歌曲位置顯示

                const playPauseBtn = document.getElementById("play-pause-btn");
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }

            // 更新播放器狀態
            function updatePlayerStatus(status) {
                document.getElementById("player-status").textContent = status;
            }

            // 啟用控制按鈕
            function enableControls() {
                updateControlButtons(); // 🆕 使用新的控制按鈕更新函數
            }

            // 禁用控制按鈕
            function disableControls() {
                const playBtn = document.getElementById("play-pause-btn");
                const prevBtn = document.getElementById("prev-btn");
                const nextBtn = document.getElementById("next-btn");

                playBtn.disabled = true;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            }

            // 移除所有測試相關的程式碼和框框
            // 保持程式碼簡潔，專注於音樂播放功能

            // 在頁面載入後自動執行快速測試 (移除黑色測試框)
            window.addEventListener("load", function () {
                // 移除 GitHub Pages 的測試資訊框
                // 保持程式碼簡潔，不再顯示測試框
                console.log("🚀 YouTube 音樂播放器載入完成");
            });

            // 添加環境檢測函數
            function detectEnvironment() {
                const env = {
                    hostname: window.location.hostname,
                    protocol: window.location.protocol,
                    port: window.location.port,
                    isLocalhost: window.location.hostname === "localhost",
                    isGitHubPages: window.location.hostname.includes("github.io"),
                    isHTTPS: window.location.protocol === "https:",
                };

                console.log("🔍 環境檢測結果:", env);
                return env;
            }

            // 頁面載入完成後初始化
            window.onload = async () => {
                console.log("🚀 頁面載入完成，開始初始化");

                try {
                    // 載入基礎資料
                    console.log("📊 開始載入基礎資料...");

                    await loadArtists();
                    console.log("🎤 歌手資料載入完成");

                    await loadSongs();
                    console.log("🎶 歌曲資料載入完成");

                    await loadPlaylists();
                    console.log("📚 播放清單資料載入完成");
                } catch (error) {
                    console.error("❌ 初始化失敗:", error);
                    document.getElementById("auth-status").textContent = "❌ 初始化失敗: " + error.message;
                }

                // 播放清單選擇事件
                document.getElementById("playlist-select").addEventListener("change", function () {
                    const playlistId = this.value;
                    if (playlistId) {
                        //確保資料載入
                        if (allSongsData.length === 0 || allArtistsData.length === 0) {
                            console.error("資料尚未載入完成");
                            console.error("❌ 資料尚未載入完成，請稍後再試");
                            return;
                        }

                        loadPlaylistSongs(playlistId);
                        resetCurrentSongDisplay();
                    } else {
                        currentPlaylist = [];
                        displayPlaylistSongs();
                    }
                });

                // 載入 Google APIs
                const script1 = document.createElement("script");
                script1.src = "https://apis.google.com/js/api.js"; // Google API Client Library
                script1.onload = gapiLoaded;
                document.body.appendChild(script1);

                const script2 = document.createElement("script");
                script2.src = "https://accounts.google.com/gsi/client"; // Google Identity Services
                script2.onload = gisLoaded;
                document.body.appendChild(script2);
            };
        </script>
    </body>
</html>
