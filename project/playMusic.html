<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ğŸµ YouTube éŸ³æ¨‚æ’­æ”¾å™¨</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
            .back-button {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 50px;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
                transition: all 0.3s ease;
                font-weight: bold;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }

            .back-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            }

            .control-buttons {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 15px;
                margin: 15px 0;
            }

            .control-btn {
                padding: 12px 16px;
                background: #ff6b35;
                color: white;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 16px;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .control-btn:hover {
                background: #e55a2e;
                transform: scale(1.1);
            }

            .control-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }

            .main-play-btn {
                width: 60px;
                height: 60px;
                font-size: 20px;
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
            }

            .main-play-btn:hover {
                background: linear-gradient(135deg, #e55a2e, #d1512a);
            }
        </style>
    </head>
    <body>
        <!-- è¿”å›éŸ³æ¨‚ç³»çµ±é¦–é æŒ‰éˆ• -->
        <button class="back-button" onclick="goBackToMusicSystem()">
            <i class="fas fa-arrow-left"></i>
            è¿”å›éŸ³æ¨‚ç³»çµ±é¦–é 
        </button>

        <div style="max-width: 1200px; margin: 0 auto; padding: 60px 20px 20px; font-family: Arial, sans-serif">
            <div style="text-align: center; margin-bottom: 30px">
                <h1><i class="fas fa-music"></i> YouTube éŸ³æ¨‚æ’­æ”¾å™¨</h1>
                <p>é¸æ“‡æ’­æ”¾æ¸…å–®ï¼Œäº«å—éŸ³æ¨‚æ™‚å…‰</p>
            </div>

            <!-- YouTube èªè­‰å€åŸŸ -->
            <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px">
                <h3><i class="fas fa-key"></i> YouTube èªè­‰</h3>
                <div style="display: flex; gap: 15px; align-items: center; margin: 15px 0">
                    <!-- ç°¡åŒ–æŒ‰éˆ•ï¼Œç§»é™¤è¤‡é›œçš„ç‹€æ…‹æ§åˆ¶ -->
                    <button
                        onclick="handleAuthClick()"
                        id="auth-btn"
                        style="
                            padding: 10px 20px;
                            background: #ff6b35;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        "
                    >
                        <i class="fas fa-sign-in-alt"></i> ç™»å…¥ Google å¸³è™Ÿ
                    </button>
                    <button
                        onclick="handleSignoutClick()"
                        id="signout-btn"
                        style="
                            display: none;
                            padding: 10px 20px;
                            background: #666;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        "
                    >
                        <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                    </button>
                    <span id="auth-status" style="color: #666">é»æ“ŠæŒ‰éˆ•ç™»å…¥ Google å¸³è™Ÿ</span>
                </div>
            </div>

            <!-- æ’­æ”¾æ¸…å–®é¸æ“‡ -->
            <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px">
                <h3><i class="fas fa-list"></i> é¸æ“‡æ’­æ”¾æ¸…å–®</h3>
                <select
                    id="playlist-select"
                    style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px"
                >
                    <option value="">è«‹é¸æ“‡æ’­æ”¾æ¸…å–®...</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px">
                <!-- å·¦å´ï¼šæ’­æ”¾æ¸…å–®æ­Œæ›²åˆ—è¡¨ -->
                <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px">
                    <h3><i class="fas fa-headphones"></i> å¾…æ’­æ”¾æ­Œæ›²</h3>
                    <div id="songs-list">
                        <div style="text-align: center; padding: 40px; color: #666">
                            <i class="fas fa-music" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3"></i>
                            <p>è«‹å…ˆé¸æ“‡æ’­æ”¾æ¸…å–®</p>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šYouTube æ’­æ”¾å™¨ -->
                <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px">
                    <h3><i class="fas fa-play-circle"></i> æ­£åœ¨æ’­æ”¾</h3>

                    <div
                        id="current-song-info"
                        style="
                            display: none;
                            background: #f5f5f5;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 10px 0;
                            border: 1px solid #ddd;
                        "
                    >
                        <div id="current-song-name" style="font-weight: bold; margin-bottom: 5px">æ­Œæ›²åç¨±</div>
                        <div id="current-artist-name" style="color: #666">æ­Œæ‰‹åç¨±</div>
                        <div id="song-position" style="color: #999; font-size: 12px; margin-top: 5px">
                            ç¬¬ 1 é¦–ï¼Œå…± 10 é¦–
                        </div>
                    </div>

                    <div
                        id="youtube-player"
                        style="width: 100%; height: 315px; background: #000; margin: 10px 0; border: 1px solid #ccc"
                    ></div>

                    // å¢å¼·çš„æ’­æ”¾æ§åˆ¶æŒ‰éˆ•
                    <div class="control-buttons">
                        <button onclick="playPreviousSong()" id="prev-btn" class="control-btn" disabled title="ä¸Šä¸€é¦–">
                            <i class="fas fa-step-backward"></i>
                        </button>

                        <button
                            onclick="togglePlayPause()"
                            id="play-pause-btn"
                            class="control-btn main-play-btn"
                            disabled
                            title="æ’­æ”¾/æš«åœ"
                        >
                            <i class="fas fa-play"></i>
                        </button>

                        <button onclick="playNextSong()" id="next-btn" class="control-btn" disabled title="ä¸‹ä¸€é¦–">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>

                    <div
                        id="player-status"
                        style="
                            text-align: center;
                            padding: 10px;
                            background: #f5f5f5;
                            border-radius: 8px;
                            border: 1px solid #ddd;
                        "
                    >
                        è«‹é¸æ“‡æ’­æ”¾æ¸…å–®é–‹å§‹æ’­æ”¾
                    </div>
                </div>
            </div>
        </div>

        <!-- Google APIs -->
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <script src="https://apis.google.com/js/api.js" async defer></script>
        <!-- YouTube API -->
        <script src="https://www.youtube.com/iframe_api"></script>

        <script>
            // ä¿®æ­£ç‰ˆæœ¬ï¼šæ ¹æ“šç’°å¢ƒè‡ªå‹•åˆ‡æ› API ç«¯é»
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            console.log("ğŸ” ç•¶å‰ç’°å¢ƒæª¢æ¸¬:", {
                hostname: currentHostname,
                origin: currentOrigin,
                href: window.location.href,
            });

            // æ ¹æ“šç’°å¢ƒè¨­å®š API ç«¯é»
            let API_BASE;

            if (currentHostname.includes("github.io")) {
                // GitHub Pages ç’°å¢ƒ
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (currentHostname.includes("railway.app")) {
                // ç›´æ¥è¨ªå• Railway æ‡‰ç”¨
                API_BASE = currentOrigin + "/api";
                console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
            } else {
                // å…¶ä»–ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
            }

            console.log("ğŸ“¡ æœ€çµ‚ API_BASE:", API_BASE);

            // ğŸ†• è¿”å›éŸ³æ¨‚ç³»çµ±é¦–é åŠŸèƒ½
            function goBackToMusicSystem() {
                console.log("ğŸ”™ è¿”å›éŸ³æ¨‚ç³»çµ±é¦–é ");

                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œè©¢å•æ˜¯å¦ç¢ºèªé›¢é–‹
                if (ytPlayer && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                    if (confirm("éŸ³æ¨‚æ­£åœ¨æ’­æ”¾ä¸­ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ")) {
                        ytPlayer.pauseVideo();
                        window.location.href = "sidebar.html";
                    }
                } else {
                    window.location.href = "sidebar.html";
                }
            }

            // ğŸ†• æ’­æ”¾ä¸Šä¸€é¦–æ­Œæ›²
            function playPreviousSong() {
                console.log("â®ï¸ æ’­æ”¾ä¸Šä¸€é¦–");

                if (currentPlaylist.length === 0) {
                    console.log("âŒ æ’­æ”¾æ¸…å–®ç‚ºç©º");
                    return;
                }

                if (currentSongIndex <= 0) {
                    // å¦‚æœå·²ç¶“æ˜¯ç¬¬ä¸€é¦–ï¼Œå¾ªç’°åˆ°æœ€å¾Œä¸€é¦–
                    const newIndex = currentPlaylist.length - 1;
                    console.log(`ğŸ”„ å¾ªç’°åˆ°æœ€å¾Œä¸€é¦–: ${newIndex}`);
                    playSong(newIndex);
                } else {
                    const newIndex = currentSongIndex - 1;
                    console.log(`â®ï¸ æ’­æ”¾ä¸Šä¸€é¦–: ${newIndex}`);
                    playSong(newIndex);
                }
            }

            // ğŸ†• æ’­æ”¾ä¸‹ä¸€é¦–æ­Œæ›²
            function playNextSong() {
                console.log("â­ï¸ æ’­æ”¾ä¸‹ä¸€é¦–");

                if (currentPlaylist.length === 0) {
                    console.log("âŒ æ’­æ”¾æ¸…å–®ç‚ºç©º");
                    return;
                }

                if (currentSongIndex >= currentPlaylist.length - 1) {
                    // å¦‚æœå·²ç¶“æ˜¯æœ€å¾Œä¸€é¦–ï¼Œå¾ªç’°åˆ°ç¬¬ä¸€é¦–
                    console.log("ğŸ”„ å¾ªç’°åˆ°ç¬¬ä¸€é¦–: 0");
                    playSong(0);
                } else {
                    const newIndex = currentSongIndex + 1;
                    console.log(`â­ï¸ æ’­æ”¾ä¸‹ä¸€é¦–: ${newIndex}`);
                    playSong(newIndex);
                }
            }

            // ğŸ†• æ›´æ–°æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
            function updateControlButtons() {
                const prevBtn = document.getElementById("prev-btn");
                const nextBtn = document.getElementById("next-btn");
                const playPauseBtn = document.getElementById("play-pause-btn");

                const hasPlaylist = currentPlaylist.length > 0;

                // åªè¦æœ‰æ’­æ”¾æ¸…å–®å°±å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•ï¼ˆæ”¯æ´å¾ªç’°æ’­æ”¾ï¼‰
                prevBtn.disabled = !hasPlaylist;
                nextBtn.disabled = !hasPlaylist;
                playPauseBtn.disabled = !hasPlaylist;
            }

            // ğŸ†• æ›´æ–°æ­Œæ›²ä½ç½®é¡¯ç¤º
            function updateSongPosition() {
                const songPosition = document.getElementById("song-position");
                if (currentSongIndex >= 0 && currentPlaylist.length > 0) {
                    songPosition.textContent = `ç¬¬ ${currentSongIndex + 1} é¦–ï¼Œå…± ${currentPlaylist.length} é¦–`;
                } else {
                    songPosition.textContent = "";
                }
            }

            console.log("ğŸµ YouTube éŸ³æ¨‚æ’­æ”¾å™¨åˆå§‹åŒ–");

            // å®šç¾©google OAuth å®¢æˆ¶ç«¯ID
            const CLIENT_ID = "407957494432-ickpd56p77suvnamqdrltgid9djfjvd3.apps.googleusercontent.com";
            const SCOPES = "https://www.googleapis.com/auth/youtube.readonly";
            const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest";

            // å…¨åŸŸè®Šæ•¸
            let ytPlayer = null; // YouTube æ’­æ”¾å™¨å¯¦ä¾‹
            let currentPlaylist = []; // ç›®å‰çš„æ’­æ”¾æ¸…å–®ï¼ˆæ­Œæ›²é™£åˆ—ï¼‰
            let currentSongIndex = -1; // ç›®å‰æ’­æ”¾æ­Œæ›²çš„ç´¢å¼•ä½ç½®ï¼ˆ-1 è¡¨ç¤ºæœªé¸æ“‡ï¼‰
            let allSongsData = []; // å¾ API è¼‰å…¥çš„æ‰€æœ‰æ­Œæ›²è³‡æ–™
            let allArtistsData = []; // å¾ API è¼‰å…¥çš„æ‰€æœ‰æ­Œæ‰‹è³‡æ–™
            let isPlayerReady = false; // YouTube æ’­æ”¾å™¨æ˜¯å¦å·²æº–å‚™å°±ç·’

            // Google API è®Šæ•¸
            let tokenClient; // OAuth æ¬Šæ–å®¢æˆ¶ç«¯å¯¦ä¾‹
            let gapiInited = false; // Google APIs å®¢æˆ¶ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
            let gisInited = false; // Google Identity Services æ˜¯å¦å·²åˆå§‹åŒ–

            // YouTube API æº–å‚™å®Œæˆå¾Œçš„å›èª¿
            window.onYouTubeIframeAPIReady = function () {
                console.log("ğŸ“º YouTube API å·²æº–å‚™å°±ç·’");
                initializeYouTubePlayer();
            };

            // åˆå§‹åŒ– YouTube æ’­æ”¾å™¨
            function initializeYouTubePlayer() {
                ytPlayer = new YT.Player("youtube-player", {
                    height: "315",
                    width: "100%",
                    playerVars: {
                        playsinline: 1, // åœ¨ iOS è£ç½®ä¸Šå…§åµŒæ’­æ”¾ï¼ˆä¸å…¨è¢å¹•ï¼‰
                        controls: 1, // é¡¯ç¤ºæ’­æ”¾æ§åˆ¶æŒ‰éˆ•ï¼ˆæ’­æ”¾/æš«åœç­‰ï¼‰
                        rel: 0, // å½±ç‰‡çµæŸå¾Œä¸é¡¯ç¤ºç›¸é—œå½±ç‰‡å»ºè­°
                        showinfo: 0, // ä¸é¡¯ç¤ºå½±ç‰‡æ¨™é¡Œå’Œä¸Šå‚³è€…è³‡è¨Š
                        autoplay: 0, // ä¸è‡ªå‹•æ’­æ”¾
                        origin: window.location.origin, // å…è¨±åµŒå…¥çš„ä¾†æº
                        enablejsapi: 1, // å•Ÿç”¨ JavaScript API
                        modestbranding: 1, // æ¸›å°‘ YouTube å“ç‰Œæ¨™èªŒ
                        fs: 1, // å…è¨±å…¨è¢å¹•æŒ‰éˆ•
                    },
                    events: {
                        onReady: onPlayerReady, // æ’­æ”¾å™¨æº–å‚™å®Œæˆæ™‚è§¸ç™¼
                        onStateChange: onPlayerStateChange, // æ’­æ”¾ç‹€æ…‹æ”¹è®Šæ™‚è§¸ç™¼ï¼ˆæ’­æ”¾/æš«åœ/çµæŸç­‰ï¼‰
                        onError: onPlayerError, // æ’­æ”¾éŒ¯èª¤æ™‚è§¸ç™¼
                    },
                });
            }

            // æ’­æ”¾å™¨æº–å‚™å®Œæˆï¼Œé¸æ­Œ
            function onPlayerReady(event) {
                console.log("âœ… YouTube æ’­æ”¾å™¨å·²æº–å‚™å°±ç·’");
                isPlayerReady = true;
                updatePlayerStatus("æ’­æ”¾å™¨å·²æº–å‚™å°±ç·’ï¼Œè«‹é¸æ“‡æ­Œæ›²"); //æ›´æ–°æ’­æ”¾å™¨ç‹€æ…‹å€åŸŸçš„é¡¯ç¤ºæ–‡å­—
            }

            // æ’­æ”¾å™¨ç‹€æ…‹æ”¹è®Š
            function onPlayerStateChange(event) {
                const playPauseBtn = document.getElementById("play-pause-btn");

                switch (event.data) {
                    case YT.PlayerState.ENDED:
                        console.log("ğŸ”š æ­Œæ›²æ’­æ”¾çµæŸ");
                        updatePlayerStatus("æ­Œæ›²æ’­æ”¾çµæŸ");
                        // ğŸ†• è‡ªå‹•æ’­æ”¾ä¸‹ä¸€é¦–
                        setTimeout(() => {
                            playNextSong();
                        }, 1000);
                        break;
                    case YT.PlayerState.PLAYING:
                        console.log("â–¶ï¸ æ­£åœ¨æ’­æ”¾");
                        updatePlayerStatus("æ­£åœ¨æ’­æ”¾");
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        break;
                    case YT.PlayerState.PAUSED:
                        console.log("â¸ï¸ å·²æš«åœ");
                        updatePlayerStatus("å·²æš«åœ");
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        break;
                    case YT.PlayerState.BUFFERING:
                        console.log("â³ ç·©è¡ä¸­");
                        updatePlayerStatus("ç·©è¡ä¸­...");
                        break;
                }
            }

            // æ’­æ”¾å™¨éŒ¯èª¤è™•ç†
            function onPlayerError(event) {
                console.error("âŒ YouTube æ’­æ”¾å™¨éŒ¯èª¤:", event.data);

                let errorMessage = "æ’­æ”¾éŒ¯èª¤";
                switch (event.data) {
                    case 2:
                        errorMessage = "å½±ç‰‡ ID ç„¡æ•ˆ";
                        break;
                    case 5:
                        errorMessage = "HTML5 æ’­æ”¾å™¨éŒ¯èª¤";
                        break;
                    case 100:
                        errorMessage = "å½±ç‰‡ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤";
                        break;
                    case 101:
                    case 150:
                        errorMessage = "å½±ç‰‡æ“æœ‰è€…ä¸å…è¨±åµŒå…¥æ’­æ”¾";
                        break;
                    default:
                        errorMessage = `æœªçŸ¥éŒ¯èª¤ (ä»£ç¢¼: ${event.data})`;
                }

                updatePlayerStatus(errorMessage);

                // ğŸ†• æ’­æ”¾éŒ¯èª¤æ™‚è‡ªå‹•è·³åˆ°ä¸‹ä¸€é¦–
                setTimeout(() => {
                    console.log("ğŸ”„ æ’­æ”¾éŒ¯èª¤ï¼Œå˜—è©¦æ’­æ”¾ä¸‹ä¸€é¦–");
                    playNextSong();
                }, 2000);
            }

            // Google API è¼‰å…¥ (åƒè€ƒä½ çš„Demo)
            function gapiLoaded() {
                console.log("ğŸ”„ é–‹å§‹è¼‰å…¥ GAPI...");
                gapi.load("client", async () => {
                    await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                    gapiInited = true;
                    console.log("âœ… GAPI å·²è¼‰å…¥");
                });
            }

            // ä¿®æ”¹ gisLoaded å‡½æ•¸ï¼ŒåŠ å¼·éŒ¯èª¤è™•ç†
            function gisLoaded() {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        ux_mode: "popup",
                        callback: (tokenResponse) => {
                            console.log("ğŸ‰ OAuth å›èª¿æˆåŠŸ:", tokenResponse);

                            if (tokenResponse.error) {
                                console.error("âŒ OAuth éŒ¯èª¤:", tokenResponse.error);
                                document.getElementById("auth-status").textContent =
                                    "âŒ èªè­‰å¤±æ•—: " + tokenResponse.error;
                                return;
                            }

                            gapi.client.setToken(tokenResponse);
                            document.getElementById("auth-status").textContent = "âœ… å·²ç™»å…¥";
                            document.getElementById("auth-btn").style.display = "none";
                            document.getElementById("signout-btn").style.display = "inline-block";
                            console.log("âœ… ç™»å…¥æˆåŠŸï¼");
                        },
                        error_callback: (error) => {
                            console.error("âŒ OAuth åˆå§‹åŒ–éŒ¯èª¤:", error);
                            document.getElementById("auth-status").textContent = "âŒ OAuth åˆå§‹åŒ–å¤±æ•—";
                        },
                    });
                    gisInited = true;
                    console.log("âœ… GIS å·²è¼‰å…¥");
                } catch (error) {
                    console.error("âŒ GIS è¼‰å…¥å¤±æ•—:", error);
                    document.getElementById("auth-status").textContent = "âŒ GIS è¼‰å…¥å¤±æ•—";
                }
            }

            // æ”¹å–„çš„ç™»å…¥è™•ç†å‡½æ•¸
            function handleAuthClick() {
                console.log("ğŸ”‘ é»æ“Šç™»å…¥æŒ‰éˆ•");

                // æª¢æŸ¥ç•¶å‰ç’°å¢ƒ
                console.log("ğŸŒ ç•¶å‰ç’°å¢ƒ:", {
                    hostname: window.location.hostname,
                    origin: window.location.origin,
                    url: window.location.href,
                });

                // æ›´æ–°ç‹€æ…‹
                document.getElementById("auth-status").textContent = "â³ æ­£åœ¨é–‹å•Ÿç™»å…¥è¦–çª—...";

                // æª¢æŸ¥APIæ˜¯å¦æº–å‚™å¥½
                if (!gapiInited || !gisInited) {
                    console.log("âš ï¸ API å°šæœªæº–å‚™å¥½");
                    document.getElementById("auth-status").textContent = "âš ï¸ API å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦";

                    // ç­‰å¾… API è¼‰å…¥
                    setTimeout(() => {
                        if (gapiInited && gisInited) {
                            console.log("âœ… API ç¾åœ¨æº–å‚™å¥½äº†ï¼Œé‡æ–°å˜—è©¦ç™»å…¥");
                            handleAuthClick();
                        } else {
                            console.error("âŒ API è¼‰å…¥é€¾æ™‚");
                            document.getElementById("auth-status").textContent = "âŒ API è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢";
                        }
                    }, 3000);
                    return;
                }

                if (!tokenClient) {
                    console.error("âŒ tokenClient æœªåˆå§‹åŒ–");
                    document.getElementById("auth-status").textContent = "âŒ ç™»å…¥å®¢æˆ¶ç«¯æœªåˆå§‹åŒ–";
                    return;
                }

                console.log("ğŸš€ é–‹å§‹ OAuth èªè­‰æµç¨‹");

                try {
                    // ä½¿ç”¨ prompt: 'select_account' è®“ä½¿ç”¨è€…å¯ä»¥é¸æ“‡å¸³è™Ÿ
                    tokenClient.requestAccessToken({
                        prompt: "select_account",
                        include_granted_scopes: true,
                    });
                } catch (error) {
                    console.error("âŒ ç™»å…¥å¤±æ•—:", error);
                    document.getElementById("auth-status").textContent = "âŒ ç™»å…¥å¤±æ•—: " + error.message;
                }
            }

            // è™•ç†ç™»å‡º
            function handleSignoutClick() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken("");
                    document.getElementById("auth-status").textContent = "å°šæœªç™»å…¥";
                    document.getElementById("auth-btn").style.display = "inline-block";
                    document.getElementById("signout-btn").style.display = "none";
                    console.log("ğŸ”“ å·²ç™»å‡º");
                }
            }

            // ğŸ†• å¢å¼·ç‰ˆï¼šæœå°‹ YouTube å½±ç‰‡ä¸¦è‡ªå‹•å„²å­˜åˆ°è³‡æ–™åº«
            async function searchYouTubeVideo(songName, artistName) {
                try {
                    console.log(`ğŸ” æœå°‹YouTubeå½±ç‰‡: ${artistName} - ${songName}`);

                    const token = gapi.client.getToken();
                    if (!token) {
                        throw new Error("è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ");
                    }

                    // ğŸ¯ ä½¿ç”¨å¤šç¨®æœå°‹é—œéµå­—ç­–ç•¥
                    const searchQueries = [
                        `${artistName} ${songName}`,
                        `${songName} ${artistName}`,
                        `${artistName} - ${songName}`,
                        `${songName}`,
                    ];

                    let bestVideo = null;

                    for (const query of searchQueries) {
                        console.log(`ğŸ” å˜—è©¦æœå°‹é—œéµå­—: "${query}"`);

                        const response = await gapi.client.youtube.search.list({
                            part: "snippet",
                            q: query,
                            type: "video",
                            maxResults: 10, // å¢åŠ æœå°‹çµæœæ•¸é‡
                            videoEmbeddable: "true",
                            videoSyndicated: "true",
                            videoLicense: "any",
                            order: "relevance",
                            regionCode: "TW", // ğŸ‡¹ğŸ‡¼ é‡å°å°ç£åœ°å€æœå°‹
                        });

                        if (response.result.items && response.result.items.length > 0) {
                            console.log(`âœ… æ‰¾åˆ° ${response.result.items.length} å€‹æœå°‹çµæœ`);

                            // ğŸ¯ é¸æ“‡æœ€ç›¸é—œçš„å½±ç‰‡
                            for (const video of response.result.items) {
                                const videoId = video.id.videoId;
                                const title = video.snippet.title.toLowerCase();
                                const channel = video.snippet.channelTitle.toLowerCase();

                                // ğŸ” æª¢æŸ¥å½±ç‰‡æ¨™é¡Œæ˜¯å¦åŒ…å«æ­Œæ›²åç¨±å’Œæ­Œæ‰‹åç¨±
                                const songInTitle = title.includes(songName.toLowerCase());
                                const artistInTitle = title.includes(artistName.toLowerCase()) ||
                                                     channel.includes(artistName.toLowerCase());

                                console.log(`ğŸµ æª¢æŸ¥å½±ç‰‡: ${video.snippet.title}`);
                                console.log(`   - æ­Œæ›²åç¨±åŒ¹é…: ${songInTitle}`);
                                console.log(`   - æ­Œæ‰‹åç¨±åŒ¹é…: ${artistInTitle}`);

                                // æª¢æŸ¥å½±ç‰‡æ˜¯å¦å¯åµŒå…¥
                                const isEmbeddable = await checkVideoEmbeddable(videoId);

                                if (isEmbeddable && (songInTitle || artistInTitle)) {
                                    const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;

                                    console.log(`âœ… æ‰¾åˆ°åˆé©çš„å½±ç‰‡:`, {
                                        title: video.snippet.title,
                                        channel: video.snippet.channelTitle,
                                        videoId: videoId,
                                        url: videoUrl,
                                        searchQuery: query
                                    });

                                    return {
                                        videoId: videoId,
                                        videoUrl: videoUrl,
                                        title: video.snippet.title,
                                        channel: video.snippet.channelTitle,
                                    };
                                }
                            }
                        }
                    }

                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹å¯åµŒå…¥çš„å½±ç‰‡
                    console.log("âš ï¸ æ²’æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„å½±ç‰‡ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„çµæœ");

                    const fallbackResponse = await gapi.client.youtube.search.list({
                        part: "snippet",
                        q: `${artistName} ${songName}`,
                        type: "video",
                        maxResults: 5,
                        videoEmbeddable: "true",
                        order: "relevance",
                    });

                    if (fallbackResponse.result.items && fallbackResponse.result.items.length > 0) {
                        const video = fallbackResponse.result.items[0];
                        const videoId = video.id.videoId;
                        const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;

                        console.log(`ğŸ“º ä½¿ç”¨å‚™é¸å½±ç‰‡: ${video.snippet.title}`);

                        return {
                            videoId: videoId,
                            videoUrl: videoUrl,
                            title: video.snippet.title,
                            channel: video.snippet.channelTitle,
                        };
                    }

                    throw new Error("æ‰¾ä¸åˆ°å¯æ’­æ”¾çš„å½±ç‰‡");

                } catch (searchError) {
                    console.error(`âŒ æœå°‹å¤±æ•—:`, searchError);
                    throw searchError;
                }
            }

            // å¾MySQLè³‡æ–™åº«ä¸­å–å¾—çš„YouTube URL
            function extractVideoId(url) {
                const regex =
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }

            // æª¢æŸ¥å½±ç‰‡æ˜¯å¦å¯åµŒå…¥
            async function checkVideoEmbeddable(videoId) {
                try {
                    const response = await gapi.client.youtube.videos.list({
                        part: "status",
                        id: videoId,
                    });

                    if (response.result.items && response.result.items.length > 0) {
                        const embeddable = response.result.items[0].status.embeddable;
                        console.log(`ğŸ“º å½±ç‰‡ ${videoId} å¯åµŒå…¥: ${embeddable}`);
                        return embeddable;
                    }
                    return false;
                } catch (error) {
                    console.log(`âš ï¸ ç„¡æ³•æª¢æŸ¥å½±ç‰‡åµŒå…¥ç‹€æ…‹: ${error}`);
                    return true; // å¦‚æœç„¡æ³•æª¢æŸ¥ï¼Œå‡è¨­å¯ä»¥åµŒå…¥
                }
            }

            // ğŸ”§ ä¿®æ­£ YouTube URL æ›´æ–°å•é¡Œ
            async function updateSongYouTubeUrl(songId, youtubeUrl) {
                try {
                    console.log(`ğŸ“ é–‹å§‹æ›´æ–°æ­Œæ›² ${songId} çš„ YouTube URL: ${youtubeUrl}`);

                    const songData = allSongsData.find((s) => s.song_id == songId);
                    if (!songData) {
                        throw new Error(`æ‰¾ä¸åˆ°æ­Œæ›² ID: ${songId}`);
                    }

                    // ğŸ¯ ç‰¹åˆ¥é‡å° Railway ç’°å¢ƒï¼Œä½¿ç”¨å®Œæ•´çš„è³‡æ–™æ ¼å¼
                    const updateData = {
                        table: "songs",
                        song_id: parseInt(songId), // ç¢ºä¿æ˜¯æ•¸å­—
                        song_name: songData.song_name,
                        artist_id: parseInt(songData.artist_id), // ç¢ºä¿æ˜¯æ•¸å­—
                        music_category: songData.music_category || "æµè¡Œ",
                        youtube_link: youtubeUrl,
                        state: 0,
                    };

                    // ç¢ºä¿ album_id æ­£ç¢ºè™•ç†
                    if (songData.album_id && songData.album_id !== null && songData.album_id !== "" && songData.album_id !== "NULL") {
                        updateData.album_id = parseInt(songData.album_id);
                    }

                    console.log("ğŸ“¤ ç™¼é€åˆ° Railway çš„æ›´æ–°è³‡æ–™:", updateData);
                    console.log("ğŸŒ API ç«¯é»:", `${API_BASE}/2/update`);

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json",
                        },
                        body: JSON.stringify(updateData),
                    });

                    console.log("ğŸŒ Railway API å›æ‡‰ç‹€æ…‹:", response.status);

                    const responseText = await response.text();
                    console.log("ğŸŒ Railway API å›æ‡‰å…§å®¹:", responseText);

                    if (!response.ok) {
                        throw new Error(`Railway API éŒ¯èª¤ ${response.status}: ${responseText}`);
                    }

                    let result;
                    try {
                        result = responseText ? JSON.parse(responseText) : {};
                    } catch (parseError) {
                        console.log("âš ï¸ å›æ‡‰ä¸æ˜¯ JSON æ ¼å¼:", responseText);
                        result = { message: responseText };
                    }

                    console.log(`âœ… Railway è³‡æ–™åº«æ›´æ–°æˆåŠŸ - æ­Œæ›² ${songId}`);
                    console.log("ğŸ“‹ Railway æ›´æ–°çµæœ:", result);

                    // ğŸ”„ æ›´æ–°æœ¬åœ°å¿«å–
                    const songIndex = allSongsData.findIndex((s) => s.song_id == songId);
                    if (songIndex !== -1) {
                        allSongsData[songIndex].youtube_link = youtubeUrl;
                        console.log(`âœ… æœ¬åœ°å¿«å–å·²æ›´æ–°`);
                    }

                    // ğŸ”„ æ›´æ–°æ’­æ”¾æ¸…å–®å¿«å–
                    const playlistSongIndex = currentPlaylist.findIndex((s) => s.song_id == songId);
                    if (playlistSongIndex !== -1) {
                        currentPlaylist[playlistSongIndex].youtube_url = youtubeUrl;
                        console.log(`âœ… æ’­æ”¾æ¸…å–®å¿«å–å·²æ›´æ–°`);
                        displayPlaylistSongs(); // é‡æ–°é¡¯ç¤ºä»¥æ›´æ–°åœ–ç¤º
                    }

                    updatePlayerStatus(`âœ… YouTube é€£çµå·²å„²å­˜åˆ° Railway è³‡æ–™åº«ï¼š${songData.song_name}`);
                    return result;

                } catch (error) {
                    console.error(`âŒ Railway è³‡æ–™åº«æ›´æ–°å¤±æ•—:`, error);
                    console.error("âŒ éŒ¯èª¤è©³æƒ…:", {
                        message: error.message,
                        songId: songId,
                        youtubeUrl: youtubeUrl,
                        API_BASE: API_BASE
                    });

                    updatePlayerStatus(`âŒ Railway è³‡æ–™åº«æ›´æ–°å¤±æ•—: ${error.message}`);
                    return null;
                }
            }
            }

            // æ’­æ”¾æŒ‡å®šæ­Œæ›²
            async function playSong(index) {
                console.log(`ğŸµ å˜—è©¦æ’­æ”¾æ­Œæ›² index: ${index}`);

                if (!isPlayerReady) {
                    console.error("âŒ YouTube æ’­æ”¾å™¨å°šæœªæº–å‚™å°±ç·’");
                    return;
                }

                if (index < 0 || index >= currentPlaylist.length) {
                    console.error(`âŒ ç´¢å¼•è¶…å‡ºç¯„åœ: ${index}, æ’­æ”¾æ¸…å–®é•·åº¦: ${currentPlaylist.length}`);
                    return;
                }

                const song = currentPlaylist[index];
                console.log("ğŸµ æ’­æ”¾æ­Œæ›²è³‡æ–™:", song);

                // æª¢æŸ¥æ­Œæ›²è³‡æ–™æ˜¯å¦å®Œæ•´
                if (!song || !song.song_name || song.song_name === "æœªçŸ¥æ­Œæ›²") {
                    console.error("âŒ æ­Œæ›²è³‡æ–™ä¸å®Œæ•´:", song);
                    return;
                }

                currentSongIndex = index;
                updateCurrentSongDisplay();
                updateSongPosition(); // ğŸ†• æ›´æ–°æ­Œæ›²ä½ç½®é¡¯ç¤º

                try {
                    let videoId = null;

                    if (song.youtube_url) {
                        videoId = extractVideoId(song.youtube_url);
                        console.log("âœ… ä½¿ç”¨ç¾æœ‰YouTube URL");
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
                    const token = gapi.client.getToken();
                    if (!token) {
                        console.error("âŒ å°šæœªç™»å…¥Googleå¸³è™Ÿ");
                        updatePlayerStatus("è«‹å…ˆç™»å…¥Googleå¸³è™Ÿæ‰èƒ½æœå°‹æ­Œæ›²");
                        return;
                    }

                    if (!videoId) {
                        console.log("ğŸ” æ²’æœ‰YouTube URLï¼Œé–‹å§‹æœå°‹...");
                        updatePlayerStatus(`ğŸ” æ­£åœ¨æœå°‹: ${song.song_name} - ${song.artist_name}`);

                        try {
                            const searchResult = await searchYouTubeVideo(song.song_name, song.artist_name);
                            videoId = searchResult.videoId;

                            console.log("ğŸ’¾ æœå°‹æˆåŠŸï¼Œé–‹å§‹å„²å­˜åˆ°è³‡æ–™åº«...");
                            updatePlayerStatus(`ğŸ’¾ æ­£åœ¨å„²å­˜ YouTube é€£çµåˆ°è³‡æ–™åº«...`);

                            // ğŸ¯ é‡è¦ï¼šå‘¼å«æ›´æ–°è³‡æ–™åº«çš„å‡½æ•¸
                            const updateResult = await updateSongYouTubeUrl(song.song_id, searchResult.videoUrl);

                            if (updateResult) {
                                console.log("âœ… YouTube é€£çµå·²æˆåŠŸå„²å­˜åˆ°è³‡æ–™åº«");
                                updatePlayerStatus(`âœ… å·²å„²å­˜: ${song.song_name} çš„ YouTube é€£çµ`);
                            } else {
                                console.warn("âš ï¸ å„²å­˜åˆ°è³‡æ–™åº«å¤±æ•—ï¼Œä½†ç¹¼çºŒæ’­æ”¾");
                                updatePlayerStatus(`âš ï¸ æ’­æ”¾æˆåŠŸï¼Œä½†å„²å­˜é€£çµå¤±æ•—`);
                            }

                        } catch (searchError) {
                            console.error("âŒ æœå°‹å¤±æ•—:", searchError);
                            updatePlayerStatus(`âŒ æœå°‹å¤±æ•—: ${searchError.message}`);
                            return;
                        }
                    }

                    if (!videoId) {
                        throw new Error("ç„¡æ³•å–å¾—æœ‰æ•ˆçš„å½±ç‰‡ID");
                    }

                    ytPlayer.loadVideoById(videoId);
                    updatePlayerStatus(`æ­£åœ¨æ’­æ”¾: ${song.song_name} - ${song.artist_name}`);
                } catch (error) {
                    console.error("âŒ æ’­æ”¾å¤±æ•—:", error);
                    updatePlayerStatus(`æ’­æ”¾å¤±æ•—`);
                }
            }

            // ä¿®æ­£å¾Œçš„è³‡æ–™è¼‰å…¥å‡½æ•¸ï¼ˆæ”¯æ´é›¢ç·šæ¨¡å¼ï¼‰
            async function loadPlaylists() {
                try {
                    console.log("ğŸ”„ è¼‰å…¥æ’­æ”¾æ¸…å–®...");

                    // æª¢æŸ¥æ˜¯å¦åœ¨ GitHub Pages ä¸”æ²’æœ‰é›²ç«¯å¾Œç«¯
                    if (currentHostname.includes("github.io") && API_BASE.includes("localhost")) {
                        console.warn("âš ï¸ åœ¨ GitHub Pages ç’°å¢ƒä¸‹ç„¡æ³•é€£æ¥æœ¬åœ°è³‡æ–™åº«ï¼Œè¼‰å…¥æ¨¡æ“¬è³‡æ–™");
                        loadMockData();
                        return;
                    }

                    const response = await fetch(`${API_BASE}/playlists`);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const playlists = await response.json();

                    const playlistSelect = document.getElementById("playlist-select");
                    playlistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ’­æ”¾æ¸…å–®...</option>';

                    playlists.forEach((playlist) => {
                        const option = document.createElement("option");
                        option.value = playlist.playlist_id;
                        option.textContent = `${playlist.playlist_name} ${playlist.is_public ? "(å…¬é–‹)" : "(ç§äºº)"}`;
                        playlistSelect.appendChild(option);
                    });

                    console.log("âœ… æ’­æ”¾æ¸…å–®è¼‰å…¥å®Œæˆï¼Œæ•¸é‡ï¼š", playlists.length);
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ’­æ”¾æ¸…å–®å¤±æ•—:", error);

                    if (currentHostname.includes("github.io")) {
                        console.log("ğŸ”„ GitHub Pages ç’°å¢ƒï¼Œè¼‰å…¥æ¨¡æ“¬è³‡æ–™");
                        loadMockData();
                    } else {
                        throw error;
                    }
                }
            }

            // æ¨¡æ“¬è³‡æ–™ï¼ˆä¾› GitHub Pages æ¸¬è©¦ç”¨ï¼‰
            function loadMockData() {
                console.log("ğŸ“‹ è¼‰å…¥æ¨¡æ“¬è³‡æ–™");

                // æ¨¡æ“¬æ’­æ”¾æ¸…å–®
                const mockPlaylists = [
                    { playlist_id: 1, playlist_name: "æˆ‘çš„æœ€æ„›", is_public: false },
                    { playlist_id: 2, playlist_name: "æµè¡Œæ­Œæ›²", is_public: true },
                ];

                const playlistSelect = document.getElementById("playlist-select");
                playlistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ’­æ”¾æ¸…å–®...</option>';

                mockPlaylists.forEach((playlist) => {
                    const option = document.createElement("option");
                    option.value = playlist.playlist_id;
                    option.textContent = `${playlist.playlist_name} (æ¨¡æ“¬è³‡æ–™)`;
                    playlistSelect.appendChild(option);
                });

                // æ¨¡æ“¬æ­Œæ›²è³‡æ–™
                allSongsData = [
                    { song_id: 1, song_name: "å‘Šç™½æ°£çƒ", artist_id: 1, youtube_url: null },
                    { song_id: 2, song_name: "ç¨»é¦™", artist_id: 1, youtube_url: null },
                ];

                allArtistsData = [{ artist_id: 1, artist_name: "å‘¨æ°å€«" }];

                console.log("âœ… æ¨¡æ“¬è³‡æ–™è¼‰å…¥å®Œæˆ");
            }

            // è¼‰å…¥æ­Œæ‰‹è³‡æ–™
            async function loadArtists() {
                try {
                    console.log("ğŸ”„ è¼‰å…¥æ­Œæ‰‹è³‡æ–™...");
                    const response = await fetch(`${API_BASE}/artists`);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    allArtistsData = await response.json();
                    console.log("âœ… æ­Œæ‰‹è³‡æ–™è¼‰å…¥å®Œæˆï¼Œæ•¸é‡ï¼š", allArtistsData.length);
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ­Œæ‰‹å¤±æ•—:", error);
                    allArtistsData = [];
                    throw error; // é‡æ–°æ‹‹å‡ºéŒ¯èª¤ä»¥ä¾¿ä¸Šå±¤è™•ç†
                }
            }

            // è¼‰å…¥æ­Œæ›²è³‡æ–™
            async function loadSongs() {
                try {
                    const response = await fetch(`${API_BASE}/songs`);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    allSongsData = await response.json();
                    console.log("âœ… æ­Œæ›²è³‡æ–™è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ­Œæ›²å¤±æ•—:", error);
                    allSongsData = [];
                }
            }

            // åœ¨ loadPlaylistSongs å‡½æ•¸é–‹é ­åŠ å…¥æª¢æŸ¥
            async function loadPlaylistSongs(playlistId) {
                try {
                    console.log("ğŸ”„ è¼‰å…¥æ’­æ”¾æ¸…å–®æ­Œæ›²:", playlistId);

                    // ğŸ” é™¤éŒ¯ï¼šæª¢æŸ¥åŸºç¤è³‡æ–™ç‹€æ…‹
                    console.log("ğŸ“Š åŸºç¤è³‡æ–™æª¢æŸ¥:");
                    console.log("  - allSongsData æ•¸é‡:", allSongsData.length);
                    console.log("  - allArtistsData æ•¸é‡:", allArtistsData.length);
                    console.log("  - API_BASE:", API_BASE);

                    if (allSongsData.length === 0) {
                        console.error("âŒ æ­Œæ›²è³‡æ–™å°šæœªè¼‰å…¥ï¼");
                        alert("æ­Œæ›²è³‡æ–™å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                        return;
                    }

                    if (allArtistsData.length === 0) {
                        console.error("âŒ æ­Œæ‰‹è³‡æ–™å°šæœªè¼‰å…¥ï¼");
                        alert("æ­Œæ‰‹è³‡æ–™å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                        return;
                    }

                    // å…ˆæ¸¬è©¦APIç«¯é»æ˜¯å¦å­˜åœ¨
                    const apiUrl = `${API_BASE}/playlist_songs?playlist_id=${playlistId}`;
                    console.log("ğŸ“¡ API URL:", apiUrl);

                    const response = await fetch(apiUrl);
                    console.log("ğŸ“¡ API Response Status:", response.status);

                    if (!response.ok) {
                        throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    }

                    const playlistSongs = await response.json();
                    console.log("ğŸ“‹ åŸå§‹æ’­æ”¾æ¸…å–®æ­Œæ›²è³‡æ–™:", playlistSongs);
                    console.log("ğŸ“Š æ’­æ”¾æ¸…å–®æ­Œæ›²æ•¸é‡:", playlistSongs.length);

                    if (playlistSongs.length === 0) {
                        console.log("âš ï¸ æ’­æ”¾æ¸…å–®æ²’æœ‰æ­Œæ›²");
                        currentPlaylist = [];
                        displayPlaylistSongs();
                        return;
                    }

                    currentPlaylist = playlistSongs.map((ps) => {
                        const song = allSongsData.find((s) => s.song_id == ps.song_id);
                        const artist = allArtistsData.find((a) => a.artist_id == song?.artist_id);

                        console.log(`ğŸµ è™•ç†æ­Œæ›² ${ps.song_id}:`, {
                            songFound: !!song,
                            artistFound: !!artist,
                            songName: song?.song_name,
                            artistName: artist?.artist_name,
                            youtubeUrl: song?.youtube_url,
                        });

                        return {
                            ...ps,
                            song_name: song?.song_name || "æœªçŸ¥æ­Œæ›²",
                            artist_name: artist?.artist_name || "æœªçŸ¥æ­Œæ‰‹",
                            youtube_url: song?.youtube_link || null, // ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨ youtube_link
                        };
                    });

                    console.log("ğŸ¼ æœ€çµ‚æ’­æ”¾æ¸…å–®:", currentPlaylist);
                    displayPlaylistSongs();
                    console.log("âœ… æ’­æ”¾æ¸…å–®æ­Œæ›²è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ’­æ”¾æ¸…å–®æ­Œæ›²å¤±æ•—:", error);
                    alert(`è¼‰å…¥æ’­æ”¾æ¸…å–®å¤±æ•—: ${error.message}`);
                    currentPlaylist = [];
                    displayPlaylistSongs();
                }
            }

            // é¡¯ç¤ºæ’­æ”¾æ¸…å–®æ­Œæ›²
            function displayPlaylistSongs() {
                const songsList = document.getElementById("songs-list");

                if (currentPlaylist.length === 0) {
                    songsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-music" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p>æ­¤æ’­æ”¾æ¸…å–®æ²’æœ‰æ­Œæ›²</p>
                        </div>
                    `;
                    disableControls();
                    return;
                }

                songsList.innerHTML = "";

                currentPlaylist.forEach((song, index) => {
                    const songItem = document.createElement("div");
                    songItem.style.cssText = `
                        display: flex; align-items: center; padding: 12px; margin-bottom: 8px;
                        border-radius: 8px; cursor: pointer; transition: all 0.3s;
                        border: 2px solid transparent; background: #f5f5f5;
                    `;
                    songItem.dataset.index = index;

                    const hasYouTubeUrl = song.youtube_url && song.youtube_url.trim() !== "";
                    const statusIcon = hasYouTubeUrl
                        ? '<i class="fas fa-play-circle" style="color: green; margin-left: 8px;" title="æœ‰YouTubeé€£çµ"></i>'
                        : '<i class="fas fa-search" style="color: orange; margin-left: 8px;" title="éœ€è¦æœå°‹YouTubeé€£çµ"></i>';

                    songItem.innerHTML = `
                        <div style="width: 30px; text-align: center; font-weight: bold; margin-right: 15px; color: #ff6b35;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 4px;">
                                ${song.song_name}
                                ${statusIcon}
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${song.artist_name}
                            </div>
                        </div>
                    `;

                    songItem.addEventListener("click", () => playSong(index));
                    songItem.addEventListener("mouseenter", () => {
                        songItem.style.background = "#e5e7eb";
                        songItem.style.borderColor = "#ff6b35";
                        songItem.style.transform = "translateX(4px)";
                    });
                    songItem.addEventListener("mouseleave", () => {
                        if (!songItem.classList.contains("playing")) {
                            songItem.style.background = "#f5f5f5";
                            songItem.style.borderColor = "transparent";
                            songItem.style.transform = "translateX(0)";
                        }
                    });

                    songsList.appendChild(songItem);
                });

                enableControls();

                const songsWithUrl = currentPlaylist.filter(
                    (song) => song.youtube_url && song.youtube_url.trim() !== ""
                ).length;
                const songsNeedSearch = currentPlaylist.length - songsWithUrl;

                let statusMessage = `è¼‰å…¥äº† ${currentPlaylist.length} é¦–æ­Œæ›²`;
                if (songsNeedSearch > 0) {
                    statusMessage += `ï¼Œå…¶ä¸­ ${songsNeedSearch} é¦–éœ€è¦æœå°‹YouTubeé€£çµ`;
                }

                updatePlayerStatus(statusMessage + "ï¼Œé»æ“Šæ­Œæ›²é–‹å§‹æ’­æ”¾");
            }

            // æ’­æ”¾/æš«åœåˆ‡æ›
            function togglePlayPause() {
                if (!ytPlayer || !isPlayerReady) return;

                const state = ytPlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) {
                    ytPlayer.pauseVideo();
                } else if (state === YT.PlayerState.PAUSED) {
                    ytPlayer.playVideo();
                } else if (currentPlaylist.length > 0) {
                    playSong(currentSongIndex >= 0 ? currentSongIndex : 0);
                }
            }

            // æ›´æ–°ç•¶å‰æ­Œæ›²é¡¯ç¤º
            function updateCurrentSongDisplay() {
                document.querySelectorAll("[data-index]").forEach((item) => {
                    item.classList.remove("playing");
                    item.style.background = "#f5f5f5";
                    item.style.borderColor = "transparent";
                    item.style.transform = "translateX(0)";
                    item.style.color = "";
                });

                if (currentSongIndex >= 0) {
                    const currentSongElement = document.querySelector(`[data-index="${currentSongIndex}"]`);
                    if (currentSongElement) {
                        currentSongElement.classList.add("playing");
                        currentSongElement.style.background = "linear-gradient(135deg, #ff6b35, #e55a2e)";
                        currentSongElement.style.color = "white";
                        currentSongElement.style.borderColor = "#ff6b35";
                    }

                    const song = currentPlaylist[currentSongIndex];
                    document.getElementById("current-song-name").textContent = song.song_name;
                    document.getElementById("current-artist-name").textContent = song.artist_name;
                    document.getElementById("current-song-info").style.display = "block";
                }
            }

            // é‡ç½®ç•¶å‰æ­Œæ›²é¡¯ç¤º
            function resetCurrentSongDisplay() {
                document.querySelectorAll("[data-index]").forEach((item) => {
                    item.classList.remove("playing");
                    item.style.background = "#f5f5f5";
                    item.style.color = "";
                    item.style.borderColor = "transparent";
                });
                document.getElementById("current-song-info").style.display = "none";
                currentSongIndex = -1;
                updateSongPosition(); // ğŸ†• æ›´æ–°æ­Œæ›²ä½ç½®é¡¯ç¤º

                const playPauseBtn = document.getElementById("play-pause-btn");
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }

            // æ›´æ–°æ’­æ”¾å™¨ç‹€æ…‹
            function updatePlayerStatus(status) {
                document.getElementById("player-status").textContent = status;
            }

            // å•Ÿç”¨æ§åˆ¶æŒ‰éˆ•
            function enableControls() {
                updateControlButtons(); // ğŸ†• ä½¿ç”¨æ–°çš„æ§åˆ¶æŒ‰éˆ•æ›´æ–°å‡½æ•¸
            }

            // ç¦ç”¨æ§åˆ¶æŒ‰éˆ•
            function disableControls() {
                const playBtn = document.getElementById("play-pause-btn");
                const prevBtn = document.getElementById("prev-btn");
                const nextBtn = document.getElementById("next-btn");

                playBtn.disabled = true;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            }

            // ç§»é™¤æ‰€æœ‰æ¸¬è©¦ç›¸é—œçš„ç¨‹å¼ç¢¼å’Œæ¡†æ¡†
            // ä¿æŒç¨‹å¼ç¢¼ç°¡æ½”ï¼Œå°ˆæ³¨æ–¼éŸ³æ¨‚æ’­æ”¾åŠŸèƒ½

            // åœ¨é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦ (ç§»é™¤é»‘è‰²æ¸¬è©¦æ¡†)
            window.addEventListener("load", function () {
                // ç§»é™¤ GitHub Pages çš„æ¸¬è©¦è³‡è¨Šæ¡†
                // ä¿æŒç¨‹å¼ç¢¼ç°¡æ½”ï¼Œä¸å†é¡¯ç¤ºæ¸¬è©¦æ¡†
                console.log("ğŸš€ YouTube éŸ³æ¨‚æ’­æ”¾å™¨è¼‰å…¥å®Œæˆ");
            });

            // æ·»åŠ ç’°å¢ƒæª¢æ¸¬å‡½æ•¸
            function detectEnvironment() {
                const env = {
                    hostname: window.location.hostname,
                    protocol: window.location.protocol,
                    port: window.location.port,
                    isLocalhost: window.location.hostname === "localhost",
                    isGitHubPages: window.location.hostname.includes("github.io"),
                    isHTTPS: window.location.protocol === "https:",
                };

                console.log("ğŸ” ç’°å¢ƒæª¢æ¸¬çµæœ:", env);
                return env;
            }

            // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
            window.onload = async () => {
                console.log("ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–");

                try {
                    // è¼‰å…¥åŸºç¤è³‡æ–™
                    console.log("ğŸ“Š é–‹å§‹è¼‰å…¥åŸºç¤è³‡æ–™...");

                    await loadArtists();
                    console.log("ğŸ¤ æ­Œæ‰‹è³‡æ–™è¼‰å…¥å®Œæˆ");

                    await loadSongs();
                    console.log("ğŸ¶ æ­Œæ›²è³‡æ–™è¼‰å…¥å®Œæˆ");

                    await loadPlaylists();
                    console.log("ğŸ“š æ’­æ”¾æ¸…å–®è³‡æ–™è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ åˆå§‹åŒ–å¤±æ•—:", error);
                    document.getElementById("auth-status").textContent = "âŒ åˆå§‹åŒ–å¤±æ•—: " + error.message;
                }

                // æ’­æ”¾æ¸…å–®é¸æ“‡äº‹ä»¶
                document.getElementById("playlist-select").addEventListener("change", function () {
                    const playlistId = this.value;
                    if (playlistId) {
                        //ç¢ºä¿è³‡æ–™è¼‰å…¥
                        if (allSongsData.length === 0 || allArtistsData.length === 0) {
                            console.error("è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ");
                            console.error("âŒ è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦");
                            return;
                        }

                        loadPlaylistSongs(playlistId);
                        resetCurrentSongDisplay();
                    } else {
                        currentPlaylist = [];
                        displayPlaylistSongs();
                    }
                });

                // è¼‰å…¥ Google APIs
                const script1 = document.createElement("script");
                script1.src = "https://apis.google.com/js/api.js"; // Google API Client Library
                script1.onload = gapiLoaded;
                document.body.appendChild(script1);

                const script2 = document.createElement("script");
                script2.src = "https://accounts.google.com/gsi/client"; // Google Identity Services
                script2.onload = gisLoaded;
                document.body.appendChild(script2);
            };
        </script>
    </body>
</html>
