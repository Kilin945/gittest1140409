<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ğŸµ YouTube éŸ³æ¨‚æ’­æ”¾å™¨</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    </head>
    <body>
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif">
            <div style="text-align: center; margin-bottom: 30px">
                <h1><i class="fas fa-music"></i> YouTube éŸ³æ¨‚æ’­æ”¾å™¨</h1>
                <p>é¸æ“‡æ’­æ”¾æ¸…å–®ï¼Œäº«å—éŸ³æ¨‚æ™‚å…‰</p>
            </div>

            <!-- YouTube èªè­‰å€åŸŸ -->
            <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px">
                <h3><i class="fas fa-key"></i> YouTube èªè­‰</h3>
                <div style="display: flex; gap: 15px; align-items: center; margin: 15px 0">
                    <!-- ç°¡åŒ–æŒ‰éˆ•ï¼Œç§»é™¤è¤‡é›œçš„ç‹€æ…‹æ§åˆ¶ -->
                    <button
                        onclick="handleAuthClick()"
                        id="auth-btn"
                        style="
                            padding: 10px 20px;
                            background: #ff6b35;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        "
                    >
                        <i class="fas fa-sign-in-alt"></i> ç™»å…¥ Google å¸³è™Ÿ
                    </button>
                    <button
                        onclick="handleSignoutClick()"
                        id="signout-btn"
                        style="
                            display: none;
                            padding: 10px 20px;
                            background: #666;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        "
                    >
                        <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                    </button>
                    <span id="auth-status" style="color: #666">é»æ“ŠæŒ‰éˆ•ç™»å…¥ Google å¸³è™Ÿ</span>
                </div>
            </div>

            <!-- æ’­æ”¾æ¸…å–®é¸æ“‡ -->
            <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px">
                <h3><i class="fas fa-list"></i> é¸æ“‡æ’­æ”¾æ¸…å–®</h3>
                <select
                    id="playlist-select"
                    style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px"
                >
                    <option value="">è«‹é¸æ“‡æ’­æ”¾æ¸…å–®...</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px">
                <!-- å·¦å´ï¼šæ’­æ”¾æ¸…å–®æ­Œæ›²åˆ—è¡¨ -->
                <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px">
                    <h3><i class="fas fa-headphones"></i> å¾…æ’­æ”¾æ­Œæ›²</h3>
                    <div id="songs-list">
                        <div style="text-align: center; padding: 40px; color: #666">
                            <i class="fas fa-music" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3"></i>
                            <p>è«‹å…ˆé¸æ“‡æ’­æ”¾æ¸…å–®</p>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šYouTube æ’­æ”¾å™¨ -->
                <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px">
                    <h3><i class="fas fa-play-circle"></i> æ­£åœ¨æ’­æ”¾</h3>

                    <div
                        id="current-song-info"
                        style="
                            display: none;
                            background: #f5f5f5;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 10px 0;
                            border: 1px solid #ddd;
                        "
                    >
                        <div id="current-song-name" style="font-weight: bold; margin-bottom: 5px">æ­Œæ›²åç¨±</div>
                        <div id="current-artist-name" style="color: #666">æ­Œæ‰‹åç¨±</div>
                    </div>

                    <div
                        id="youtube-player"
                        style="width: 100%; height: 315px; background: #000; margin: 10px 0; border: 1px solid #ccc"
                    ></div>
                    <div style="display: flex; justify-content: center; gap: 15px; margin: 15px 0">
                        <button
                            onclick="togglePlayPause()"
                            id="play-pause-btn"
                            disabled
                            style="
                                padding: 10px 15px;
                                background: #ff6b35;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                            "
                        >
                            <i class="fas fa-play"></i> æ’­æ”¾
                        </button>
                    </div>

                    <div
                        id="player-status"
                        style="
                            text-align: center;
                            padding: 10px;
                            background: #f5f5f5;
                            border-radius: 8px;
                            border: 1px solid #ddd;
                        "
                    >
                        è«‹é¸æ“‡æ’­æ”¾æ¸…å–®é–‹å§‹æ’­æ”¾
                    </div>
                </div>
            </div>
        </div>

        <!-- Google APIs -->
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <script src="https://apis.google.com/js/api.js" async defer></script>
        <!-- YouTube API -->
        <script src="https://www.youtube.com/iframe_api"></script>

        <script>
            // ä¿®æ­£ç‰ˆæœ¬ï¼šæ ¹æ“šç’°å¢ƒè‡ªå‹•åˆ‡æ› API ç«¯é»
            // æª¢æ¸¬ç•¶å‰ç’°å¢ƒ
            const isLocalhost = window.location.hostname === "localhost";
            const isGitHubPages = window.location.hostname.includes("github.io");

            // æ ¹æ“šç’°å¢ƒè¨­å®š API ç«¯é»
            let API_BASE;
            if (isLocalhost) {
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (isGitHubPages) {
                // GitHub Pages ç’°å¢ƒ - ä½ éœ€è¦å°‡å¾Œç«¯éƒ¨ç½²åˆ°é›²ç«¯
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒ + Railway å¾Œç«¯");
            } else {
                // å…¶ä»–ç’°å¢ƒ
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸŒ å…¶ä»–ç’°å¢ƒ");
            }

            console.log("ğŸµ YouTube éŸ³æ¨‚æ’­æ”¾å™¨åˆå§‹åŒ–");

            // å®šç¾©google OAuth å®¢æˆ¶ç«¯ID
            const CLIENT_ID = "407957494432-ickpd56p77suvnamqdrltgid9djfjvd3.apps.googleusercontent.com";
            const SCOPES = "https://www.googleapis.com/auth/youtube.readonly";
            const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest";

            // å…¨åŸŸè®Šæ•¸
            let ytPlayer = null; // YouTube æ’­æ”¾å™¨å¯¦ä¾‹
            let currentPlaylist = []; // ç›®å‰çš„æ’­æ”¾æ¸…å–®ï¼ˆæ­Œæ›²é™£åˆ—ï¼‰
            let currentSongIndex = -1; // ç›®å‰æ’­æ”¾æ­Œæ›²çš„ç´¢å¼•ä½ç½®ï¼ˆ-1 è¡¨ç¤ºæœªé¸æ“‡ï¼‰
            let allSongsData = []; // å¾ API è¼‰å…¥çš„æ‰€æœ‰æ­Œæ›²è³‡æ–™
            let allArtistsData = []; // å¾ API è¼‰å…¥çš„æ‰€æœ‰æ­Œæ‰‹è³‡æ–™
            let isPlayerReady = false; // YouTube æ’­æ”¾å™¨æ˜¯å¦å·²æº–å‚™å°±ç·’

            // Google API è®Šæ•¸
            let tokenClient; // OAuth æ¬Šæ–å®¢æˆ¶ç«¯å¯¦ä¾‹
            let gapiInited = false; // Google APIs å®¢æˆ¶ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
            let gisInited = false; // Google Identity Services æ˜¯å¦å·²åˆå§‹åŒ–

            // YouTube API æº–å‚™å®Œæˆå¾Œçš„å›èª¿
            window.onYouTubeIframeAPIReady = function () {
                console.log("ğŸ“º YouTube API å·²æº–å‚™å°±ç·’");
                initializeYouTubePlayer();
            };

            // åˆå§‹åŒ– YouTube æ’­æ”¾å™¨
            function initializeYouTubePlayer() {
                ytPlayer = new YT.Player("youtube-player", {
                    height: "315",
                    width: "100%",
                    playerVars: {
                        playsinline: 1, // åœ¨ iOS è£ç½®ä¸Šå…§åµŒæ’­æ”¾ï¼ˆä¸å…¨è¢å¹•ï¼‰
                        controls: 1, // é¡¯ç¤ºæ’­æ”¾æ§åˆ¶æŒ‰éˆ•ï¼ˆæ’­æ”¾/æš«åœç­‰ï¼‰
                        rel: 0, // å½±ç‰‡çµæŸå¾Œä¸é¡¯ç¤ºç›¸é—œå½±ç‰‡å»ºè­°
                        showinfo: 0, // ä¸é¡¯ç¤ºå½±ç‰‡æ¨™é¡Œå’Œä¸Šå‚³è€…è³‡è¨Š
                        autoplay: 0, // ä¸è‡ªå‹•æ’­æ”¾
                        origin: window.location.origin, // å…è¨±åµŒå…¥çš„ä¾†æº
                        enablejsapi: 1, // å•Ÿç”¨ JavaScript API
                        modestbranding: 1, // æ¸›å°‘ YouTube å“ç‰Œæ¨™èªŒ
                        fs: 1, // å…è¨±å…¨è¢å¹•æŒ‰éˆ•
                    },
                    events: {
                        onReady: onPlayerReady, // æ’­æ”¾å™¨æº–å‚™å®Œæˆæ™‚è§¸ç™¼
                        onStateChange: onPlayerStateChange, // æ’­æ”¾ç‹€æ…‹æ”¹è®Šæ™‚è§¸ç™¼ï¼ˆæ’­æ”¾/æš«åœ/çµæŸç­‰ï¼‰
                        onError: onPlayerError, // æ’­æ”¾éŒ¯èª¤æ™‚è§¸ç™¼
                    },
                });
            }

            // æ’­æ”¾å™¨æº–å‚™å®Œæˆï¼Œé¸æ­Œ
            function onPlayerReady(event) {
                console.log("âœ… YouTube æ’­æ”¾å™¨å·²æº–å‚™å°±ç·’");
                isPlayerReady = true;
                updatePlayerStatus("æ’­æ”¾å™¨å·²æº–å‚™å°±ç·’ï¼Œè«‹é¸æ“‡æ­Œæ›²"); //æ›´æ–°æ’­æ”¾å™¨ç‹€æ…‹å€åŸŸçš„é¡¯ç¤ºæ–‡å­—
            }

            // æ’­æ”¾å™¨ç‹€æ…‹æ”¹è®Š
            function onPlayerStateChange(event) {
                const playPauseBtn = document.getElementById("play-pause-btn");

                switch (event.data) {
                    case YT.PlayerState.ENDED:
                        console.log("ğŸ”š æ­Œæ›²æ’­æ”¾çµæŸ");
                        updatePlayerStatus("æ­Œæ›²æ’­æ”¾çµæŸ");
                        break;
                    case YT.PlayerState.PLAYING:
                        console.log("â–¶ï¸ æ­£åœ¨æ’­æ”¾");
                        updatePlayerStatus("æ­£åœ¨æ’­æ”¾");
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš«åœ';
                        break;
                    case YT.PlayerState.PAUSED:
                        console.log("â¸ï¸ å·²æš«åœ");
                        updatePlayerStatus("å·²æš«åœ");
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾';
                        break;
                    case YT.PlayerState.BUFFERING:
                        console.log("â³ ç·©è¡ä¸­");
                        updatePlayerStatus("ç·©è¡ä¸­...");
                        break;
                }
            }

            // æ’­æ”¾å™¨éŒ¯èª¤è™•ç†
            function onPlayerError(event) {
                console.error("âŒ YouTube æ’­æ”¾å™¨éŒ¯èª¤:", event.data);

                let errorMessage = "æ’­æ”¾éŒ¯èª¤";
                switch (event.data) {
                    case 2:
                        errorMessage = "å½±ç‰‡ ID ç„¡æ•ˆ";
                        break;
                    case 5:
                        errorMessage = "HTML5 æ’­æ”¾å™¨éŒ¯èª¤";
                        break;
                    case 100:
                        errorMessage = "å½±ç‰‡ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤";
                        break;
                    case 101:
                    case 150:
                        errorMessage = "å½±ç‰‡æ“æœ‰è€…ä¸å…è¨±åµŒå…¥æ’­æ”¾";
                        break;
                    default:
                        errorMessage = `æœªçŸ¥éŒ¯èª¤ (ä»£ç¢¼: ${event.data})`;
                }

                updatePlayerStatus(errorMessage);
            }

            // Google API è¼‰å…¥ (åƒè€ƒä½ çš„Demo)
            function gapiLoaded() {
                console.log("ğŸ”„ é–‹å§‹è¼‰å…¥ GAPI...");
                gapi.load("client", async () => {
                    await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                    gapiInited = true;
                    console.log("âœ… GAPI å·²è¼‰å…¥");
                });
            }

            // ä¿®æ”¹ gisLoaded å‡½æ•¸ï¼ŒåŠ å¼·éŒ¯èª¤è™•ç†
            function gisLoaded() {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        ux_mode: "popup",
                        callback: (tokenResponse) => {
                            console.log("ğŸ‰ OAuth å›èª¿æˆåŠŸ:", tokenResponse);

                            if (tokenResponse.error) {
                                console.error("âŒ OAuth éŒ¯èª¤:", tokenResponse.error);
                                document.getElementById("auth-status").textContent =
                                    "âŒ èªè­‰å¤±æ•—: " + tokenResponse.error;
                                return;
                            }

                            gapi.client.setToken(tokenResponse);
                            document.getElementById("auth-status").textContent = "âœ… å·²ç™»å…¥";
                            document.getElementById("auth-btn").style.display = "none";
                            document.getElementById("signout-btn").style.display = "inline-block";
                            console.log("âœ… ç™»å…¥æˆåŠŸï¼");
                        },
                        error_callback: (error) => {
                            console.error("âŒ OAuth åˆå§‹åŒ–éŒ¯èª¤:", error);
                            document.getElementById("auth-status").textContent = "âŒ OAuth åˆå§‹åŒ–å¤±æ•—";
                        },
                    });
                    gisInited = true;
                    console.log("âœ… GIS å·²è¼‰å…¥");
                } catch (error) {
                    console.error("âŒ GIS è¼‰å…¥å¤±æ•—:", error);
                    document.getElementById("auth-status").textContent = "âŒ GIS è¼‰å…¥å¤±æ•—";
                }
            }

            // æ”¹å–„çš„ç™»å…¥è™•ç†å‡½æ•¸
            function handleAuthClick() {
                console.log("ğŸ”‘ é»æ“Šç™»å…¥æŒ‰éˆ•");

                // æª¢æŸ¥ç•¶å‰ç’°å¢ƒ
                console.log("ğŸŒ ç•¶å‰ç’°å¢ƒ:", {
                    hostname: window.location.hostname,
                    origin: window.location.origin,
                    url: window.location.href,
                });

                // æ›´æ–°ç‹€æ…‹
                document.getElementById("auth-status").textContent = "â³ æ­£åœ¨é–‹å•Ÿç™»å…¥è¦–çª—...";

                // æª¢æŸ¥APIæ˜¯å¦æº–å‚™å¥½
                if (!gapiInited || !gisInited) {
                    console.log("âš ï¸ API å°šæœªæº–å‚™å¥½");
                    document.getElementById("auth-status").textContent = "âš ï¸ API å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦";

                    // ç­‰å¾… API è¼‰å…¥
                    setTimeout(() => {
                        if (gapiInited && gisInited) {
                            console.log("âœ… API ç¾åœ¨æº–å‚™å¥½äº†ï¼Œé‡æ–°å˜—è©¦ç™»å…¥");
                            handleAuthClick();
                        } else {
                            console.error("âŒ API è¼‰å…¥é€¾æ™‚");
                            document.getElementById("auth-status").textContent = "âŒ API è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢";
                        }
                    }, 3000);
                    return;
                }

                if (!tokenClient) {
                    console.error("âŒ tokenClient æœªåˆå§‹åŒ–");
                    document.getElementById("auth-status").textContent = "âŒ ç™»å…¥å®¢æˆ¶ç«¯æœªåˆå§‹åŒ–";
                    return;
                }

                console.log("ğŸš€ é–‹å§‹ OAuth èªè­‰æµç¨‹");

                try {
                    // ä½¿ç”¨ prompt: 'select_account' è®“ä½¿ç”¨è€…å¯ä»¥é¸æ“‡å¸³è™Ÿ
                    tokenClient.requestAccessToken({
                        prompt: "select_account",
                        include_granted_scopes: true,
                    });
                } catch (error) {
                    console.error("âŒ ç™»å…¥å¤±æ•—:", error);
                    document.getElementById("auth-status").textContent = "âŒ ç™»å…¥å¤±æ•—: " + error.message;
                }
            }

            // è™•ç†ç™»å‡º
            function handleSignoutClick() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken("");
                    document.getElementById("auth-status").textContent = "å°šæœªç™»å…¥";
                    document.getElementById("auth-btn").style.display = "inline-block";
                    document.getElementById("signout-btn").style.display = "none";
                    console.log("ğŸ”“ å·²ç™»å‡º");
                }
            }
            // æ–°å¢ç’°å¢ƒæª¢æ¸¬å’Œé™¤éŒ¯è³‡è¨Š
            function showEnvironmentInfo() {
                const envInfo = {
                    hostname: window.location.hostname,
                    protocol: window.location.protocol,
                    origin: window.location.origin,
                    url: window.location.href,
                    isLocalhost: window.location.hostname === "localhost",
                    isGitHubPages: window.location.hostname.includes("github.io"),
                    userAgent: navigator.userAgent,
                    clientId: CLIENT_ID,
                };

                console.log("ğŸ” ç’°å¢ƒæª¢æ¸¬è³‡è¨Š:", envInfo);

                // åœ¨é é¢ä¸Šé¡¯ç¤ºé™¤éŒ¯è³‡è¨Š
                const debugInfo = document.createElement("div");
                debugInfo.id = "debug-info";
                debugInfo.style.cssText = `
                position: fixed; bottom: 10px; left: 10px; 
                background: rgba(0,0,0,0.8); color: white; 
                padding: 10px; border-radius: 5px; 
                font-size: 11px; z-index: 9999; max-width: 300px;
                `;
                debugInfo.innerHTML = `
                <div><strong>ğŸ” é™¤éŒ¯è³‡è¨Š</strong></div>
                <div>ç’°å¢ƒ: ${envInfo.isLocalhost ? "æœ¬åœ°" : envInfo.isGitHubPages ? "GitHub Pages" : "å…¶ä»–"}</div>
                <div>Origin: ${envInfo.origin}</div>
                <div>Client ID: ${envInfo.clientId.substring(0, 20)}...</div>
                <div style="margin-top: 5px; font-size: 10px; opacity: 0.7;">
                    é»æ“Šå¯é—œé–‰
                </div>
                `;
                debugInfo.addEventListener("click", () => debugInfo.remove());
                document.body.appendChild(debugInfo);
            }

            // åœ¨é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç’°å¢ƒè³‡è¨Š
            window.addEventListener("load", () => {
                setTimeout(showEnvironmentInfo, 1000);
            });
            // æª¢æŸ¥å½±ç‰‡æ˜¯å¦å¯ä»¥åµŒå…¥
            async function checkVideoEmbeddable(videoId) {
                try {
                    console.log(`ğŸ” æª¢æŸ¥å½±ç‰‡ ${videoId} æ˜¯å¦å¯åµŒå…¥`);

                    const response = await gapi.client.youtube.videos.list({
                        part: "status",
                        id: videoId,
                    });

                    if (response.result.items && response.result.items.length > 0) {
                        const video = response.result.items[0];
                        const embeddable = video.status.embeddable;

                        console.log(`ğŸ“º å½±ç‰‡ ${videoId} å¯åµŒå…¥ç‹€æ…‹: ${embeddable}`);
                        return embeddable;
                    }

                    return false;
                } catch (error) {
                    console.error(`âŒ æª¢æŸ¥å½±ç‰‡åµŒå…¥ç‹€æ…‹å¤±æ•—:`, error);
                    return false;
                }
            }

            // æœå°‹ YouTube å½±ç‰‡
            async function searchYouTubeVideo(songName, artistName) {
                try {
                    console.log(`ğŸ” æœå°‹YouTubeå½±ç‰‡: ${artistName} - ${songName}`);

                    const token = gapi.client.getToken();
                    if (!token) {
                        throw new Error("è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ");
                    }
                    const response = await gapi.client.youtube.search.list({
                        part: "snippet", // éœ€è¦çš„éƒ¨åˆ†
                        q: `${artistName} - ${songName}`, // ä½¿ç”¨æœå°‹é—œéµå­—
                        type: "video",
                        maxResults: 5,
                        videoEmbeddable: "true", // åªè¦å¯åµŒå…¥çš„
                        videoSyndicated: "true", // åªè¦å¯åœ¨å¤–éƒ¨æ’­æ”¾çš„
                        videoLicense: "any", // åŒ…å«æ‰€æœ‰æˆæ¬Šé¡å‹çš„å½±ç‰‡,å¢åŠ æœå°‹çµæœæ•¸é‡
                        order: "relevance", // æ ¹æ“šç›¸é—œæ€§æ’åº
                    });

                    if (response.result.items && response.result.items.length > 0) {
                        const video = response.result.items[0];
                        const videoId = video.id.videoId;

                        // ä½¿ç”¨ videos API æª¢æŸ¥åµŒå…¥ç‹€æ…‹
                        const isEmbeddable = await checkVideoEmbeddable(videoId);

                        if (isEmbeddable) {
                            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;

                            console.log(`âœ… æ‰¾åˆ°å½±ç‰‡:`, {
                                title: video.snippet.title,
                                videoId: videoId,
                                url: videoUrl,
                            });

                            return {
                                videoId: videoId,
                                videoUrl: videoUrl,
                                title: video.snippet.title,
                            };
                        }
                    }
                } catch (searchError) {
                    console.log(`âŒ æœå°‹å¤±æ•—:`, searchError);
                    throw searchError;
                }
            }

            // å¾MySQLè³‡æ–™åº«ä¸­å–å¾—çš„YouTube URL
            function extractVideoId(url) {
                const regex =
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }

            // æ›´æ–°æ­Œæ›²çš„ YouTube URL åˆ°è³‡æ–™åº«
            async function updateSongYouTubeUrl(songId, youtubeUrl) {
                try {
                    console.log(`ğŸ“ æ›´æ–°æ­Œæ›² ${songId} çš„ YouTube URL: ${youtubeUrl}`);

                    const songData = allSongsData.find((s) => s.song_id == songId);
                    if (!songData) {
                        throw new Error(`æ‰¾ä¸åˆ°æ­Œæ›² ID: ${songId}`);
                    }

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            table: "songs",
                            song_id: songId,
                            song_name: songData.song_name,
                            artist_id: songData.artist_id,
                            album_id: songData.album_id || "8",
                            music_category: songData.music_category || "æµè¡Œæ­Œ",
                            youtube_url: youtubeUrl,
                            state: 0,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log(`âœ… æˆåŠŸæ›´æ–°æ­Œæ›² ${songId} çš„ YouTube URL`);

                    // åŒæ™‚æ›´æ–°æœ¬åœ°å¿«å–çš„æ­Œæ›²è³‡æ–™
                    const songIndex = allSongsData.findIndex((s) => s.song_id == songId);
                    if (songIndex !== -1) {
                        allSongsData[songIndex].youtube_link = youtubeUrl;
                        console.log(`âœ… æœ¬åœ°å¿«å–ä¹Ÿå·²æ›´æ–°`);
                    }
                    return result;
                } catch (error) {
                    console.error(`âŒ æ›´æ–°æ­Œæ›² ${songId} çš„ YouTube URL å¤±æ•—:`, error);
                    return null;
                }
            }

            // æ’­æ”¾æŒ‡å®šæ­Œæ›²
            async function playSong(index) {
                console.log(`ğŸµ å˜—è©¦æ’­æ”¾æ­Œæ›² index: ${index}`);

                if (!isPlayerReady) {
                    console.error("âŒ YouTube æ’­æ”¾å™¨å°šæœªæº–å‚™å°±ç·’");
                    return;
                }

                if (index < 0 || index >= currentPlaylist.length) {
                    console.error(`âŒ ç´¢å¼•è¶…å‡ºç¯„åœ: ${index}, æ’­æ”¾æ¸…å–®é•·åº¦: ${currentPlaylist.length}`);
                    return;
                }

                const song = currentPlaylist[index];
                console.log("ğŸµ æ’­æ”¾æ­Œæ›²è³‡æ–™:", song);

                // æª¢æŸ¥æ­Œæ›²è³‡æ–™æ˜¯å¦å®Œæ•´
                if (!song || !song.song_name || song.song_name === "æœªçŸ¥æ­Œæ›²") {
                    console.error("âŒ æ­Œæ›²è³‡æ–™ä¸å®Œæ•´:", song);
                    return;
                }

                currentSongIndex = index;
                updateCurrentSongDisplay();

                try {
                    let videoId = null;

                    if (song.youtube_url) {
                        videoId = extractVideoId(song.youtube_url);
                        console.log("âœ… ä½¿ç”¨ç¾æœ‰YouTube URL");
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
                    const token = gapi.client.getToken();
                    if (!token) {
                        console.error("âŒ å°šæœªç™»å…¥Googleå¸³è™Ÿ");
                        updatePlayerStatus("è«‹å…ˆç™»å…¥Googleå¸³è™Ÿæ‰èƒ½æœå°‹æ­Œæ›²");
                        return;
                    }

                    if (!videoId) {
                        console.log("ğŸ” æ²’æœ‰YouTube URLï¼Œé–‹å§‹æœå°‹...");
                        updatePlayerStatus(`æ­£åœ¨æœå°‹: ${song.song_name} - ${song.artist_name}`);

                        try {
                            const searchResult = await searchYouTubeVideo(song.song_name, song.artist_name);
                            videoId = searchResult.videoId;

                            await updateSongYouTubeUrl(song.song_id, searchResult.videoUrl);
                        } catch (searchError) {
                            console.error("âŒ æœå°‹å¤±æ•—:", searchError);
                            return;
                        }
                    }

                    if (!videoId) {
                        throw new Error("ç„¡æ³•å–å¾—æœ‰æ•ˆçš„å½±ç‰‡ID");
                    }

                    ytPlayer.loadVideoById(videoId);
                    updatePlayerStatus(`æ­£åœ¨æ’­æ”¾: ${song.song_name} - ${song.artist_name}`);
                } catch (error) {
                    console.error("âŒ æ’­æ”¾å¤±æ•—:", error);
                    updatePlayerStatus(`æ’­æ”¾å¤±æ•—`);
                }
            }

            // ä¿®æ­£å¾Œçš„è³‡æ–™è¼‰å…¥å‡½æ•¸ï¼ˆæ”¯æ´é›¢ç·šæ¨¡å¼ï¼‰
            async function loadPlaylists() {
                try {
                    // æª¢æŸ¥æ˜¯å¦åœ¨ GitHub Pages ä¸”æ²’æœ‰é›²ç«¯å¾Œç«¯
                    if (isGitHubPages && API_BASE.includes("localhost")) {
                        console.log("âš ï¸ GitHub Pages ç’°å¢ƒä¸‹ç„¡æ³•é€£æ¥æœ¬åœ°è³‡æ–™åº«");
                        // è¼‰å…¥æ¨¡æ“¬è³‡æ–™
                        loadMockData();
                        return;
                    }

                    const response = await fetch(`${API_BASE}/playlists`);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const playlists = await response.json();

                    const playlistSelect = document.getElementById("playlist-select");
                    playlistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ’­æ”¾æ¸…å–®...</option>';

                    playlists.forEach((playlist) => {
                        const option = document.createElement("option");
                        option.value = playlist.playlist_id;
                        option.textContent = `${playlist.playlist_name} ${playlist.is_public ? "(å…¬é–‹)" : "(ç§äºº)"}`;
                        playlistSelect.appendChild(option);
                    });

                    console.log("âœ… æ’­æ”¾æ¸…å–®è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ’­æ”¾æ¸…å–®å¤±æ•—:", error);

                    if (isGitHubPages) {
                        alert("GitHub Pages ç’°å¢ƒä¸‹éœ€è¦é›²ç«¯è³‡æ–™åº«æ‰èƒ½æ­£å¸¸é‹ä½œ");
                    }
                }
            }

            // æ¨¡æ“¬è³‡æ–™ï¼ˆä¾› GitHub Pages æ¸¬è©¦ç”¨ï¼‰
            function loadMockData() {
                console.log("ğŸ“‹ è¼‰å…¥æ¨¡æ“¬è³‡æ–™");

                // æ¨¡æ“¬æ’­æ”¾æ¸…å–®
                const mockPlaylists = [
                    { playlist_id: 1, playlist_name: "æˆ‘çš„æœ€æ„›", is_public: false },
                    { playlist_id: 2, playlist_name: "æµè¡Œæ­Œæ›²", is_public: true },
                ];

                const playlistSelect = document.getElementById("playlist-select");
                playlistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ’­æ”¾æ¸…å–®...</option>';

                mockPlaylists.forEach((playlist) => {
                    const option = document.createElement("option");
                    option.value = playlist.playlist_id;
                    option.textContent = `${playlist.playlist_name} (æ¨¡æ“¬è³‡æ–™)`;
                    playlistSelect.appendChild(option);
                });

                // æ¨¡æ“¬æ­Œæ›²è³‡æ–™
                allSongsData = [
                    { song_id: 1, song_name: "å‘Šç™½æ°£çƒ", artist_id: 1, youtube_url: null },
                    { song_id: 2, song_name: "ç¨»é¦™", artist_id: 1, youtube_url: null },
                ];

                allArtistsData = [{ artist_id: 1, artist_name: "å‘¨æ°å€«" }];

                console.log("âœ… æ¨¡æ“¬è³‡æ–™è¼‰å…¥å®Œæˆ");
            }

            // è¼‰å…¥æ­Œæ‰‹è³‡æ–™
            async function loadArtists() {
                try {
                    const response = await fetch(`${API_BASE}/artists`);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    allArtistsData = await response.json();
                    console.log("âœ… æ­Œæ‰‹è³‡æ–™è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ­Œæ‰‹å¤±æ•—:", error);
                    allArtistsData = [];
                }
            }

            // è¼‰å…¥æ­Œæ›²è³‡æ–™
            async function loadSongs() {
                try {
                    const response = await fetch(`${API_BASE}/songs`);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    allSongsData = await response.json();
                    console.log("âœ… æ­Œæ›²è³‡æ–™è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ­Œæ›²å¤±æ•—:", error);
                    allSongsData = [];
                }
            }

            // è¼‰å…¥æ’­æ”¾æ¸…å–®æ­Œæ›²
            async function loadPlaylistSongs(playlistId) {
                try {
                    console.log("ğŸ”„ è¼‰å…¥æ’­æ”¾æ¸…å–®æ­Œæ›²:", playlistId);

                    // å…ˆæ¸¬è©¦APIç«¯é»æ˜¯å¦å­˜åœ¨
                    const apiUrl = `${API_BASE}/playlist_songs?playlist_id=${playlistId}`;
                    console.log("ğŸ“¡ API URL:", apiUrl);

                    const response = await fetch(apiUrl);
                    console.log("ğŸ“¡ API Response Status:", response.status);

                    if (!response.ok) {
                        throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    }

                    const playlistSongs = await response.json();
                    console.log("ğŸ“‹ åŸå§‹æ’­æ”¾æ¸…å–®æ­Œæ›²è³‡æ–™:", playlistSongs);
                    console.log("ğŸ“Š æ’­æ”¾æ¸…å–®æ­Œæ›²æ•¸é‡:", playlistSongs.length);

                    currentPlaylist = playlistSongs.map((ps) => {
                        const song = allSongsData.find((s) => s.song_id == ps.song_id);
                        const artist = allArtistsData.find((a) => a.artist_id == song?.artist_id);

                        console.log(`ğŸµ è™•ç†æ­Œæ›² ${ps.song_id}:`, {
                            songFound: !!song,
                            artistFound: !!artist,
                            songName: song?.song_name,
                            artistName: artist?.artist_name,
                            youtubeUrl: song?.youtube_url,
                        });

                        return {
                            ...ps,
                            song_name: song?.song_name || "æœªçŸ¥æ­Œæ›²",
                            artist_name: artist?.artist_name || "æœªçŸ¥æ­Œæ‰‹",
                            youtube_url: song?.youtube_url || null,
                        };
                    });

                    console.log("ğŸ¼ æœ€çµ‚æ’­æ”¾æ¸…å–®:", currentPlaylist);
                    displayPlaylistSongs();
                    console.log("âœ… æ’­æ”¾æ¸…å–®æ­Œæ›²è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ è¼‰å…¥æ’­æ”¾æ¸…å–®æ­Œæ›²å¤±æ•—:", error);
                    alert(`è¼‰å…¥æ’­æ”¾æ¸…å–®å¤±æ•—: ${error.message}`);
                    currentPlaylist = [];
                    displayPlaylistSongs();
                }
            }

            // é¡¯ç¤ºæ’­æ”¾æ¸…å–®æ­Œæ›²
            function displayPlaylistSongs() {
                const songsList = document.getElementById("songs-list");

                if (currentPlaylist.length === 0) {
                    songsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-music" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p>æ­¤æ’­æ”¾æ¸…å–®æ²’æœ‰æ­Œæ›²</p>
                        </div>
                    `;
                    disableControls();
                    return;
                }

                songsList.innerHTML = "";

                currentPlaylist.forEach((song, index) => {
                    const songItem = document.createElement("div");
                    songItem.style.cssText = `
                        display: flex; align-items: center; padding: 12px; margin-bottom: 8px;
                        border-radius: 8px; cursor: pointer; transition: all 0.3s;
                        border: 2px solid transparent; background: #f5f5f5;
                    `;
                    songItem.dataset.index = index;

                    const hasYouTubeUrl = song.youtube_url && song.youtube_url.trim() !== "";
                    const statusIcon = hasYouTubeUrl
                        ? '<i class="fas fa-play-circle" style="color: green; margin-left: 8px;" title="æœ‰YouTubeé€£çµ"></i>'
                        : '<i class="fas fa-search" style="color: orange; margin-left: 8px;" title="éœ€è¦æœå°‹YouTubeé€£çµ"></i>';

                    songItem.innerHTML = `
                        <div style="width: 30px; text-align: center; font-weight: bold; margin-right: 15px; color: #ff6b35;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 4px;">
                                ${song.song_name}
                                ${statusIcon}
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${song.artist_name}
                            </div>
                        </div>
                    `;

                    songItem.addEventListener("click", () => playSong(index));
                    songItem.addEventListener("mouseenter", () => {
                        songItem.style.background = "#e5e7eb";
                        songItem.style.borderColor = "#ff6b35";
                        songItem.style.transform = "translateX(4px)";
                    });
                    songItem.addEventListener("mouseleave", () => {
                        if (!songItem.classList.contains("playing")) {
                            songItem.style.background = "#f5f5f5";
                            songItem.style.borderColor = "transparent";
                            songItem.style.transform = "translateX(0)";
                        }
                    });

                    songsList.appendChild(songItem);
                });

                enableControls();

                const songsWithUrl = currentPlaylist.filter(
                    (song) => song.youtube_url && song.youtube_url.trim() !== ""
                ).length;
                const songsNeedSearch = currentPlaylist.length - songsWithUrl;

                let statusMessage = `è¼‰å…¥äº† ${currentPlaylist.length} é¦–æ­Œæ›²`;
                if (songsNeedSearch > 0) {
                    statusMessage += `ï¼Œå…¶ä¸­ ${songsNeedSearch} é¦–éœ€è¦æœå°‹YouTubeé€£çµ`;
                }

                updatePlayerStatus(statusMessage + "ï¼Œé»æ“Šæ­Œæ›²é–‹å§‹æ’­æ”¾");
            }

            // æ’­æ”¾/æš«åœåˆ‡æ›
            function togglePlayPause() {
                if (!ytPlayer || !isPlayerReady) return;

                const state = ytPlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) {
                    ytPlayer.pauseVideo();
                } else if (state === YT.PlayerState.PAUSED) {
                    ytPlayer.playVideo();
                } else if (currentPlaylist.length > 0) {
                    playSong(0);
                }
            }

            // æ›´æ–°ç•¶å‰æ­Œæ›²é¡¯ç¤º
            function updateCurrentSongDisplay() {
                document.querySelectorAll("[data-index]").forEach((item) => {
                    item.classList.remove("playing");
                    item.style.background = "#f5f5f5";
                    item.style.borderColor = "transparent";
                    item.style.transform = "translateX(0)";
                });

                if (currentSongIndex >= 0) {
                    const currentSongElement = document.querySelector(`[data-index="${currentSongIndex}"]`);
                    if (currentSongElement) {
                        currentSongElement.classList.add("playing");
                        currentSongElement.style.background = "linear-gradient(135deg, #ff6b35, #e55a2e)";
                        currentSongElement.style.color = "white";
                        currentSongElement.style.borderColor = "#ff6b35";
                    }

                    const song = currentPlaylist[currentSongIndex];
                    document.getElementById("current-song-name").textContent = song.song_name;
                    document.getElementById("current-artist-name").textContent = song.artist_name;
                    document.getElementById("current-song-info").style.display = "block";
                }
            }

            // é‡ç½®ç•¶å‰æ­Œæ›²é¡¯ç¤º
            function resetCurrentSongDisplay() {
                document.querySelectorAll("[data-index]").forEach((item) => {
                    item.classList.remove("playing");
                    item.style.background = "#f5f5f5";
                    item.style.color = "";
                    item.style.borderColor = "transparent";
                });
                document.getElementById("current-song-info").style.display = "none";
                currentSongIndex = -1;

                const playPauseBtn = document.getElementById("play-pause-btn");
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾';
            }

            // æ›´æ–°æ’­æ”¾å™¨ç‹€æ…‹
            function updatePlayerStatus(status) {
                document.getElementById("player-status").textContent = status;
            }

            // å•Ÿç”¨æ§åˆ¶æŒ‰éˆ•
            function enableControls() {
                const playBtn = document.getElementById("play-pause-btn");
                playBtn.disabled = false;
                playBtn.style.opacity = "1";
                playBtn.style.cursor = "pointer";
            }

            // ç¦ç”¨æ§åˆ¶æŒ‰éˆ•
            function disableControls() {
                const playBtn = document.getElementById("play-pause-btn");
                playBtn.disabled = true;
                playBtn.style.opacity = "0.5";
                playBtn.style.cursor = "not-allowed";
            }

            // å¿«é€Ÿæ¸¬è©¦å‡½æ•¸
            function quickTest() {
                // æ¨¡æ“¬æ’­æ”¾æ¸…å–®è³‡æ–™
                currentPlaylist = [
                    {
                        song_id: 1,
                        song_name: "å‘Šç™½æ°£çƒ",
                        artist_name: "å‘¨æ°å€«",
                        youtube_url: "https://www.youtube.com/watch?v=bu7nU9Mhpyo",
                    },
                    {
                        song_id: 2,
                        song_name: "ç¨»é¦™",
                        artist_name: "å‘¨æ°å€«",
                        youtube_url: "https://www.youtube.com/watch?v=VjXl09n4NT8",
                    },
                ];

                // é¡¯ç¤ºæ¨¡æ“¬æ’­æ”¾æ¸…å–®
                displayPlaylistSongs();

                console.log("ğŸ§ª å¿«é€Ÿæ¸¬è©¦æ¨¡å¼å•Ÿå‹•");
                console.log("ğŸ“ ç•¶å‰ç’°å¢ƒ:", window.location.href);
                console.log("ğŸŒ Origin:", window.location.origin);

                // æ¸¬è©¦ YouTube æ’­æ”¾å™¨
                if (isPlayerReady) {
                    console.log("âœ… YouTube æ’­æ”¾å™¨å·²æº–å‚™å°±ç·’");
                } else {
                    console.log("â³ YouTube æ’­æ”¾å™¨å°šæœªæº–å‚™å°±ç·’");
                }
            }

            // åœ¨é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦
            window.addEventListener("load", function () {
                // å¦‚æœæ˜¯ GitHub Pages ç’°å¢ƒï¼Œç­‰å¾… 5 ç§’å¾ŒåŸ·è¡Œæ¸¬è©¦
                if (window.location.hostname.includes("github.io")) {
                    setTimeout(quickTest, 5000);

                    // é¡¯ç¤ºç’°å¢ƒè³‡è¨Š
                    const envInfo = document.createElement("div");
                    envInfo.style.cssText = `
            position: fixed; top: 10px; right: 10px; 
            background: #333; color: white; padding: 10px; 
            border-radius: 5px; z-index: 9999; font-size: 12px;
        `;
                    envInfo.innerHTML = `
            <div>ğŸŒ GitHub Pages æ¨¡å¼</div>
            <div>ğŸ”— ${window.location.href}</div>
            <div>ğŸ“¡ éœ€è¦é›²ç«¯è³‡æ–™åº«</div>
        `;
                    document.body.appendChild(envInfo);
                }
            });

            // æ·»åŠ ç’°å¢ƒæª¢æ¸¬å‡½æ•¸
            function detectEnvironment() {
                const env = {
                    hostname: window.location.hostname,
                    protocol: window.location.protocol,
                    port: window.location.port,
                    isLocalhost: window.location.hostname === "localhost",
                    isGitHubPages: window.location.hostname.includes("github.io"),
                    isHTTPS: window.location.protocol === "https:",
                };

                console.log("ğŸ” ç’°å¢ƒæª¢æ¸¬çµæœ:", env);
                return env;
            }

            // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– (åƒè€ƒä½ çš„Demo)
            window.onload = () => {
                console.log("ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–");

                // è¼‰å…¥åŸºç¤è³‡æ–™
                Promise.all([loadArtists(), loadSongs(), loadPlaylists()]).then(() => {
                    console.log("âœ… æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆ");
                });

                // æ’­æ”¾æ¸…å–®é¸æ“‡äº‹ä»¶
                document.getElementById("playlist-select").addEventListener("change", function () {
                    const playlistId = this.value;
                    if (playlistId) {
                        loadPlaylistSongs(playlistId);
                        resetCurrentSongDisplay();
                    } else {
                        currentPlaylist = [];
                        displayPlaylistSongs();
                    }
                });

                // è¼‰å…¥ Google APIs
                const script1 = document.createElement("script");
                script1.src = "https://apis.google.com/js/api.js";
                script1.onload = gapiLoaded;
                document.body.appendChild(script1);

                const script2 = document.createElement("script");
                script2.src = "https://accounts.google.com/gsi/client";
                script2.onload = gisLoaded;
                document.body.appendChild(script2);
            };
        </script>
    </body>
</html>
