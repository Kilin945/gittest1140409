<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>新增歌手表單</title>
        <!-- Font Awesome 圖標庫 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            .required {
                color: red;
            }

            .form-hint {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
                font-style: italic;
            }
        </style>
    </head>
    <body>
        <h2>🎤 新增歌手</h2>

        <label for="name">歌手名稱 <span class="required">*</span></label>
        <input type="text" id="name" name="artist_name" placeholder="請輸入歌手姓名" required />

        <label for="gender">性別 <span class="required">*</span></label>
        <select id="gender" required>
            <option value="">請選擇性別</option>
            <option value="M">男</option>
            <option value="F">女</option>
            <option value="other">其他</option>
        </select>

        <label for="country">國家/地區</label>
        <select id="country">
            <option value="">請選擇國家/地區</option>
            <option value="TW">臺灣</option>
            <option value="HK">香港</option>
            <option value="JP">日本</option>
            <option value="MY">馬來西亞</option>
            <option value="CN">中國</option>
            <option value="US">美國</option>
            <option value="SG">新加坡</option>
            <option value="KR">韓國</option>
            <option value="other">其他</option>
        </select>
        <div class="form-hint">國家/地區為選填項目</div>

        <button>新增歌手</button>

        <script>
            console.log("Insert Artist Script 開始執行");

            // 🔧 動態設定 API Base URL - 修正硬編碼問題
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                // GitHub Pages 環境
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("☁️ GitHub Pages 環境，使用 Railway 後端");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // 本地開發環境
                API_BASE = "http://localhost:8000/api";
                console.log("🏠 本地開發環境");
            } else if (currentHostname.includes("railway.app")) {
                // 直接訪問 Railway 應用
                API_BASE = currentOrigin + "/api";
                console.log("🚂 Railway 環境，使用相對路徑");
            } else {
                // 其他環境，預設使用 Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("🌐 未知環境，預設使用 Railway 後端");
            }
            console.log("📡 Insert Artist API_BASE:", API_BASE);

            // 新增歌手函數
            window.insertpost = async function () {
                try {
                    // 取得表單資料並進行驗證
                    let name = document.getElementById("name").value.trim();
                    let gender = document.getElementById("gender").value;
                    let country = document.getElementById("country").value;
                    let state = "0";

                    console.log("=== 欄位值檢查 ===");
                    console.log("name:", `'${name}'`);
                    console.log("gender:", `'${gender}'`);
                    console.log("country:", `'${country}'`);
                    console.log("state:", `'${state}'`);

                    // 檢查必填欄位
                    if (!name) {
                        alert("請輸入歌手名稱！");
                        document.getElementById("name").focus();
                        return;
                    }

                    if (!gender) {
                        alert("請選擇性別！");
                        document.getElementById("gender").focus();
                        return;
                    }

                    console.log("📤 提交資料:", { name, gender, country, state });
                    console.log("使用 API 端點:", `${API_BASE}/2/insert`);

                    const response = await fetch(`${API_BASE}/2/insert`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            table: "artists",
                            artist_name: name,
                            gender: gender,
                            country: country || "", // 如果沒選擇國家，傳送空字串
                            state: state,
                        }),
                    });

                    console.log("Response Status:", response.status);

                    if (response.ok) {
                        // 取得性別顯示文字
                        const genderText =
                            {
                                M: "男",
                                F: "女",
                                other: "其他",
                            }[gender] || gender;

                        // 取得國家顯示文字
                        const countryOptions = {
                            TW: "臺灣",
                            HK: "香港",
                            JP: "日本",
                            MY: "馬來西亞",
                            CN: "中國",
                            US: "美國",
                            SG: "新加坡",
                            KR: "韓國",
                            other: "其他",
                        };
                        const countryText = country ? countryOptions[country] || country : "未填寫";

                        // 創建成功訊息
                        const successMessage = `✅ 歌手新增成功！
🎤 歌手名稱: ${name}
👤 性別: ${genderText}
🌍 國家/地區: ${countryText}`;

                        alert(successMessage);
                        console.log("✅ 歌手新增成功");

                        // 清空表單
                        document.getElementById("name").value = "";
                        document.getElementById("gender").value = "";
                        document.getElementById("country").value = "";
                        document.getElementById("name").focus(); // 焦點回到第一個欄位
                    } else {
                        const errorText = await response.text();
                        console.error("❌ 新增失敗:", response.status, errorText);
                        alert(`❌ 新增失敗: ${errorText}`);
                    }
                } catch (error) {
                    console.error("❌ 請求錯誤:", error);
                    alert(`❌ 新增失敗: ${error.message}`);
                }
            };

            console.log("DOM 載入完成");
            const btn = document.querySelector("button");
            console.log("找到按鈕:", btn);
            if (btn) {
                btn.addEventListener("click", function () {
                    console.log("按鈕點擊事件觸發");
                    window.insertpost();
                });
                console.log("✅ 事件監聽器已綁定");
            } else {
                console.error("❌ 找不到新增歌手按鈕");
            }

            console.log("Script 執行完畢");
        </script>
    </body>
</html>
