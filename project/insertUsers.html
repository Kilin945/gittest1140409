<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>æ–°å¢ç”¨æˆ¶</title>
        <link rel="stylesheet" href="main.css" />
        <style>
            .form-hint {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
                font-style: italic;
            }

            .required {
                color: red;
            }

            .usage-time-display {
                font-size: 11px;
                color: #999;
                margin-top: 3px;
                opacity: 0.7;
            }
        </style>
    </head>
    <body>
        <h2>ğŸ‘¤ æ–°å¢ç”¨æˆ¶</h2>

        <label for="user_name">ç”¨æˆ¶åç¨± <span class="required">*</span></label>
        <input type="text" id="user_name" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åç¨±" required />
        <div class="form-hint">ç”¨æˆ¶åç¨±ä¸å¯é‡è¤‡</div>

        <label for="password">å¯†ç¢¼ <span class="required">*</span></label>
        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required />

        <div class="usage-time-display">ğŸ’¡ ä½¿ç”¨æ™‚é–“çµ±è¨ˆï¼šæ–°ç”¨æˆ¶åˆå§‹ç‚º 00:00:00ï¼Œç³»çµ±æœƒè‡ªå‹•å¾ç™»å…¥é–‹å§‹ç´¯è¨ˆä½¿ç”¨æ™‚é–“</div>

        <button id="submitBtn">æ–°å¢ç”¨æˆ¶</button>

        <script>
            console.log("ğŸš€ æ–°å¢ç”¨æˆ¶é é¢åˆå§‹åŒ–");

            // ğŸ”§ ç¢ºä¿ API_BASE åœ¨å…¨åŸŸå¯ç”¨
            window.API_BASE = (() => {
                const currentHostname = window.location.hostname;
                const currentOrigin = window.location.origin;

                if (currentHostname.includes("github.io")) {
                    console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
                    return "https://1140412connectproject-production.up.railway.app/api";
                } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                    console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
                    return "http://localhost:8000/api";
                } else if (currentHostname.includes("railway.app")) {
                    console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
                    return currentOrigin + "/api";
                } else {
                    console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
                    return "https://1140412connectproject-production.up.railway.app/api";
                }
            })();

            console.log("ğŸ“¡ API_BASE:", window.API_BASE);

            // æ–°å¢ç”¨æˆ¶å‡½æ•¸ - ç¢ºä¿åœ¨å…¨åŸŸ
            window.insertpost = async function () {
                try {
                    const userName = document.getElementById("user_name").value.trim();
                    const password = document.getElementById("password").value.trim();

                    console.log("=== æ–°å¢ç”¨æˆ¶è«‹æ±‚ ===");
                    console.log("ç”¨æˆ¶åç¨±:", userName);
                    console.log("å¯†ç¢¼:", password ? "å·²è¼¸å…¥" : "æœªè¼¸å…¥");
                    console.log("API ç«¯é»:", `${window.API_BASE}/2/insert`);

                    if (!userName || !password) {
                        alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼");
                        return;
                    }

                    const requestData = {
                        table: "users",
                        user_name: userName,
                        password: password,
                        usage_time: "00:00:00",
                        state: "0",
                    };

                    console.log("ğŸ“¤ ç™¼é€è³‡æ–™:", requestData);

                    const response = await fetch(`${window.API_BASE}/2/insert`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    console.log("ğŸ“¡ ä¼ºæœå™¨å›æ‡‰ç‹€æ…‹:", response.status);

                    if (response.ok) {
                        console.log("âœ… ç”¨æˆ¶æ–°å¢æˆåŠŸ");
                        alert(`âœ… ç”¨æˆ¶ã€Œ${userName}ã€æ–°å¢æˆåŠŸï¼`);
                        document.getElementById("user_name").value = "";
                        document.getElementById("password").value = "";
                    } else {
                        const errorText = await response.text();
                        console.error("âŒ æ–°å¢å¤±æ•—:", response.status, errorText);
                        alert(`âŒ æ–°å¢å¤±æ•—: ${errorText}`);
                    }
                } catch (error) {
                    console.error("âŒ è«‹æ±‚éŒ¯èª¤:", error);
                }
            };

            // äº‹ä»¶ç¶å®šç­–ç•¥
            function bindSubmitEvent() {
                const submitBtn = document.getElementById("submitBtn");
                if (submitBtn) {
                    // ğŸ”§ é—œéµä¿®æ­£ï¼šæª¢æŸ¥æ˜¯å¦å·²ç¶“ç¶å®šé
                    if (submitBtn.hasAttribute("data-bound")) {
                        console.log("âš ï¸ æŒ‰éˆ•å·²ç¶“ç¶å®šéäº‹ä»¶ï¼Œè·³é");
                        return true;
                    }

                    // ç¶å®šäº‹ä»¶
                    submitBtn.addEventListener("click", function (e) {
                        e.preventDefault(); // é¿å…è¡¨å–®æäº¤
                        console.log("ğŸ”¥ æŒ‰éˆ•è¢«é»æ“Š");
                        window.insertpost(); // å‘¼å«æ–°å¢ç”¨æˆ¶å‡½æ•¸
                    });

                    // ğŸ”§ æ¨™è¨˜å·²ç¶å®šï¼Œé˜²æ­¢é‡è¤‡
                    submitBtn.setAttribute("data-bound", "true");
                    console.log("âœ… æäº¤æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š");
                    return true;
                } else {
                    console.warn("âš ï¸ æœªæ‰¾åˆ°æäº¤æŒ‰éˆ•");
                    return false;
                }
            }

            // å¤šç¨®è¼‰å…¥æ™‚æ©Ÿç¶å®šäº‹ä»¶
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", bindSubmitEvent);
            } else {
                bindSubmitEvent();
            }

            // Enter éµæäº¤
            document.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    window.insertpost();
                }
            });

            console.log("âœ… æ–°å¢ç”¨æˆ¶é é¢åˆå§‹åŒ–å®Œæˆ");
        </script>
    </body>
</html>
