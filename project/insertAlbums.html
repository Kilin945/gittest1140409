<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>æ–°å¢å°ˆè¼¯</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            .required {
                color: red;
            }

            .form-hint {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
                font-style: italic;
            }

            .date-hint {
                font-size: 11px;
                color: #888;
                margin-top: 2px;
            }
        </style>
    </head>
    <body>
        <h2>ğŸ’¿ æ–°å¢å°ˆè¼¯</h2>

        <label for="artist_id">è«‹é¸æ“‡æ­Œæ‰‹ <span class="required">*</span></label>
        <select id="artist_id" required>
            <option value="">è«‹é¸æ“‡æ­Œæ‰‹</option>
        </select>
        <div class="form-hint">å¿…é ˆå…ˆé¸æ“‡æ­Œæ‰‹æ‰èƒ½æ–°å¢å°ˆè¼¯</div>

        <label for="album_name">å°ˆè¼¯åç¨± <span class="required">*</span></label>
        <input type="text" id="album_name" placeholder="è«‹è¼¸å…¥å°ˆè¼¯åç¨±" required />

        <label for="release_date">å°ˆè¼¯ç™¼è¡Œæ—¥æœŸ</label>
        <input type="date" id="release_date" placeholder="è«‹é¸æ“‡ç™¼è¡Œæ—¥æœŸ" />
        <div class="date-hint">ç™¼è¡Œæ—¥æœŸç‚ºé¸å¡«é …ç›®ï¼Œå¯ç•™ç©º</div>

        <button>æ–°å¢å°ˆè¼¯</button>

        <script>
            console.log("Insert Album Script é–‹å§‹åŸ·è¡Œ");

            // ğŸ”§ å‹•æ…‹è¨­å®š API Base URL - ä¿®æ­£ç¡¬ç·¨ç¢¼å•é¡Œ
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                // GitHub Pages ç’°å¢ƒ
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (currentHostname.includes("railway.app")) {
                // ç›´æ¥è¨ªå• Railway æ‡‰ç”¨
                API_BASE = currentOrigin + "/api";
                console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
            } else {
                // å…¶ä»–ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
            }
            console.log("ğŸ“¡ Insert Album API_BASE:", API_BASE);

            // ä½¿ç”¨å‹•æ…‹ API URL
            const apiArtists = `${API_BASE}/artists`;
            const apiAlbums = `${API_BASE}/albums`;

            // è¼‰å…¥æ­Œæ‰‹æ¸…å–®
            async function artistNameAdd() {
                try {
                    console.log("ğŸ”„ é–‹å§‹è¼‰å…¥æ­Œæ‰‹è³‡æ–™...");
                    const response = await fetch(apiArtists);
                    console.log("APIå›æ‡‰ç‹€æ…‹:", response.status);

                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    const artistSelect = document.getElementById("artist_id");

                    if (!artistSelect) {
                        console.error("æ‰¾ä¸åˆ° artist_id å…ƒç´ ");
                        return;
                    }

                    if (!Array.isArray(data) || data.length === 0) {
                        artistSelect.innerHTML = '<option value="">æ²’æœ‰æ­Œæ‰‹è³‡æ–™</option>';
                        return;
                    }

                    // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™é è¨­é¸é …ï¼‰
                    artistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ­Œæ‰‹</option>';

                    // æŒ‰æ­Œæ‰‹åç¨±æ’åº
                    data.sort((a, b) => a.artist_name.localeCompare(b.artist_name, "zh-Hant"));

                    // æ¯ä¸€åˆ—æ­Œæ‰‹è³‡æ–™
                    data.forEach((row) => {
                        let id = row["artist_id"];
                        let name = row["artist_name"];
                        let option = document.createElement("option");
                        option.value = id;
                        option.textContent = name;
                        artistSelect.appendChild(option);
                    });

                    console.log("âœ… æ­Œæ‰‹è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", data.length, "ä½æ­Œæ‰‹");
                } catch (err) {
                    console.error("âŒ è¼‰å…¥æ­Œæ‰‹å¤±æ•—:", err);
                    const artistSelect = document.getElementById("artist_id");
                    if (artistSelect) {
                        artistSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</option>';
                    }
                }
            }

            // æ–°å¢å°ˆè¼¯å‡½æ•¸
            window.insertpost = async function () {
                try {
                    // å–å¾—æ‰€æœ‰æ¬„ä½çš„å€¼ä¸¦é€²è¡Œæ¸…ç†
                    const album_name = document.getElementById("album_name").value.trim();
                    const artist_id = document.getElementById("artist_id").value;
                    const release_date = document.getElementById("release_date").value;

                    console.log("=== æ¬„ä½å€¼æª¢æŸ¥ ===");
                    console.log("album_name:", `'${album_name}'`);
                    console.log("artist_id:", `'${artist_id}'`);
                    console.log("release_date:", `'${release_date}'`);

                    // æª¢æŸ¥å¿…å¡«æ¬„ä½
                    if (!album_name) {
                        alert("è«‹è¼¸å…¥å°ˆè¼¯åç¨±ï¼");
                        document.getElementById("album_name").focus();
                        return;
                    }

                    if (!artist_id || artist_id === "") {
                        alert("è«‹é¸æ“‡æ­Œæ‰‹ï¼");
                        document.getElementById("artist_id").focus();
                        return;
                    }

                    // æª¢æŸ¥æ—¥æœŸæ ¼å¼ï¼ˆå¦‚æœæœ‰å¡«å¯«ï¼‰
                    if (release_date) {
                        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                        if (!dateRegex.test(release_date)) {
                            alert("è«‹é¸æ“‡æ­£ç¢ºçš„æ—¥æœŸæ ¼å¼ï¼");
                            document.getElementById("release_date").focus();
                            return;
                        }
                    }

                    const requestData = {
                        table: "albums",
                        album_name: album_name,
                        artist_id: artist_id,
                    };

                    // åªæœ‰å¡«å¯«æ—¥æœŸæ™‚æ‰åŠ å…¥
                    if (release_date) {
                        requestData.release_date = release_date;
                    }

                    console.log("ğŸ“¤ æäº¤è³‡æ–™:", requestData);
                    console.log("ä½¿ç”¨ API ç«¯é»:", `${API_BASE}/2/insert`);

                    const response = await fetch(`${API_BASE}/2/insert`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    console.log("APIå›æ‡‰ç‹€æ…‹:", response.status);

                    if (response.ok) {
                        // å–å¾—é¸ä¸­çš„æ­Œæ‰‹åç¨±
                        const selectedArtistName = document.getElementById("artist_id").selectedOptions[0].textContent;

                        // æ ¼å¼åŒ–ç™¼è¡Œæ—¥æœŸ
                        const releaseDateText = release_date
                            ? new Date(release_date).toLocaleDateString("zh-TW", {
                                  year: "numeric",
                                  month: "long",
                                  day: "numeric",
                              })
                            : "æœªå¡«å¯«";

                        // å‰µå»ºæˆåŠŸè¨Šæ¯
                        const successMessage = `âœ… å°ˆè¼¯æ–°å¢æˆåŠŸï¼
ğŸ¤ æ­Œæ‰‹: ${selectedArtistName}
ğŸ’¿ å°ˆè¼¯åç¨±: ${album_name}
ğŸ“… ç™¼è¡Œæ—¥æœŸ: ${releaseDateText}`;

                        alert(successMessage);
                        console.log("âœ… å°ˆè¼¯æ–°å¢æˆåŠŸ");

                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById("album_name").value = "";
                        document.getElementById("artist_id").value = "";
                        document.getElementById("release_date").value = "";
                        document.getElementById("artist_id").focus(); // ç„¦é»å›åˆ°æ­Œæ‰‹é¸æ“‡
                    } else {
                        const errorText = await response.text();
                        console.error("âŒ æ–°å¢å¤±æ•—:", response.status, errorText);
                        alert(`âŒ æ–°å¢å°ˆè¼¯å¤±æ•—: ${errorText}`);
                    }
                } catch (error) {
                    console.error("âŒ æ–°å¢å°ˆè¼¯å¤±æ•—:", error);
                    alert(`âŒ æ–°å¢å°ˆè¼¯å¤±æ•—: ${error.message}`);
                }
            };

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            console.log("ç¶å®šæŒ‰éˆ•äº‹ä»¶");
            const btn = document.querySelector("button");
            console.log("æ‰¾åˆ°æŒ‰éˆ•:", btn);
            if (btn) {
                btn.addEventListener("click", function () {
                    console.log("æŒ‰éˆ•è¢«é»æ“Š");
                    window.insertpost();
                });
                console.log("âœ… æŒ‰éˆ•äº‹ä»¶ç¶å®šæˆåŠŸ");
            } else {
                console.error("âŒ æ‰¾ä¸åˆ°æ–°å¢å°ˆè¼¯æŒ‰éˆ•");
            }

            // è¼‰å…¥æ­Œæ‰‹è³‡æ–™
            artistNameAdd();
            console.log("Insert Album Script åŸ·è¡Œå®Œç•¢");
        </script>
    </body>
</html>
