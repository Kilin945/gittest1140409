<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>æ–°å¢æ’­æ”¾æ¸…å–®</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            .required {
                color: red;
            }

            .form-hint {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
                font-style: italic;
            }

            .user-info {
                background: #e8f4f8;
                border: 1px solid #bee5eb;
                border-radius: 4px;
                padding: 10px;
                margin: 10px 0;
                font-weight: bold;
                color: #0c5460;
            }

            .privacy-hint {
                font-size: 11px;
                color: #888;
                margin-top: 3px;
            }
        </style>
    </head>
    <body>
        <h2>ğŸ“‹ æ–°å¢æ’­æ”¾æ¸…å–®</h2>

        <label for="playlist_name">æ’­æ”¾æ¸…å–®åç¨± <span class="required">*</span></label>
        <input type="text" id="playlist_name" placeholder="è«‹è¼¸å…¥æ’­æ”¾æ¸…å–®åç¨±" required />
        <div class="form-hint">æ’­æ”¾æ¸…å–®åç¨±ä¸å¯é‡è¤‡</div>

        <label for="is_public">éš±ç§è¨­å®š</label>
        <select id="is_public">
            <option value="false">ğŸ”’ ç§äººæ’­æ”¾æ¸…å–®ï¼ˆåƒ…è‡ªå·±å¯è¦‹ï¼‰</option>
            <option value="true">ğŸŒ å…¬é–‹æ’­æ”¾æ¸…å–®ï¼ˆæ‰€æœ‰äººå¯è¦‹ï¼‰</option>
        </select>
        <div class="privacy-hint">ğŸ’¡ å»ºç«‹å¾Œå¯åœ¨è¨­å®šä¸­ä¿®æ”¹éš±ç§æ¬Šé™</div>

        <div class="user-info">ğŸ‘¤ ç•¶å‰ä½¿ç”¨è€…ï¼š<span id="currentUserName">æ¸¬è©¦ä½¿ç”¨è€…</span></div>
        <input type="hidden" id="user_id" value="1" />

        <button>æ–°å¢æ’­æ”¾æ¸…å–®</button>

        <script>
            console.log("Insert Playlists Script é–‹å§‹åŸ·è¡Œ");

            // ğŸ”§ å‹•æ…‹è¨­å®š API Base URL - ä¿®æ­£ç¡¬ç·¨ç¢¼å•é¡Œ
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                // GitHub Pages ç’°å¢ƒ
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (currentHostname.includes("railway.app")) {
                // ç›´æ¥è¨ªå• Railway æ‡‰ç”¨
                API_BASE = currentOrigin + "/api";
                console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
            } else {
                // å…¶ä»–ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
            }
            console.log("ğŸ“¡ Insert Playlist API_BASE:", API_BASE);

            // ä½¿ç”¨å‹•æ…‹ API URL
            const apiPlaylists = `${API_BASE}/playlists`;
            const apiUsers = `${API_BASE}/users`;

            // æ–°å¢æ’­æ”¾æ¸…å–®å‡½æ•¸
            window.insertpost = async function () {
                try {
                    console.log("é–‹å§‹æ–°å¢æ’­æ”¾æ¸…å–®");

                    // å–å¾—è¡¨å–®è³‡æ–™ä¸¦æ¸…ç†
                    const playlistName = document.getElementById("playlist_name").value.trim();
                    const userId = document.getElementById("user_id").value;
                    const isPublicSelect = document.getElementById("is_public");
                    const isPublic = isPublicSelect.value === "true";

                    console.log("=== æ¬„ä½å€¼æª¢æŸ¥ ===");
                    console.log("playlist_name:", `'${playlistName}'`);
                    console.log("user_id:", `'${userId}'`);
                    console.log("is_public:", isPublic);

                    // æª¢æŸ¥å¿…å¡«æ¬„ä½
                    if (!playlistName) {
                        alert("è«‹è¼¸å…¥æ’­æ”¾æ¸…å–®åç¨±ï¼");
                        document.getElementById("playlist_name").focus();
                        return;
                    }

                    if (playlistName.length < 2) {
                        alert("æ’­æ”¾æ¸…å–®åç¨±è‡³å°‘éœ€è¦2å€‹å­—å…ƒï¼");
                        document.getElementById("playlist_name").focus();
                        return;
                    }

                    if (!userId) {
                        alert("ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
                        return;
                    }

                    const requestData = {
                        table: "playlists",
                        playlist_name: playlistName,
                        is_public: isPublic,
                        user_id: userId,
                    };

                    console.log("ğŸ“¤ æäº¤è³‡æ–™:", requestData);
                    console.log("ä½¿ç”¨ API ç«¯é»:", `${API_BASE}/2/insert`);

                    const response = await fetch(`${API_BASE}/2/insert`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    console.log("APIå›æ‡‰ç‹€æ…‹:", response.status);

                    if (response.ok) {
                        // å–å¾—éš±ç§è¨­å®šæ–‡å­—
                        const privacyText = isPublic ? "å…¬é–‹æ’­æ”¾æ¸…å–®" : "ç§äººæ’­æ”¾æ¸…å–®";
                        const privacyIcon = isPublic ? "ğŸŒ" : "ğŸ”’";
                        const currentUser = document.getElementById("currentUserName").textContent;

                        // å‰µå»ºæˆåŠŸè¨Šæ¯
                        const successMessage = `âœ… æ’­æ”¾æ¸…å–®å»ºç«‹æˆåŠŸï¼
ğŸ“‹ æ’­æ”¾æ¸…å–®åç¨±: ${playlistName}
${privacyIcon} éš±ç§è¨­å®š: ${privacyText}
ğŸ‘¤ å»ºç«‹è€…: ${currentUser}`;

                        alert(successMessage);
                        console.log("âœ… æ’­æ”¾æ¸…å–®æ–°å¢æˆåŠŸ");

                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById("playlist_name").value = "";
                        document.getElementById("is_public").value = "false"; // é è¨­ç‚ºç§äºº
                        document.getElementById("playlist_name").focus();
                    } else {
                        const errorText = await response.text();
                        console.error("âŒ æ–°å¢å¤±æ•—:", response.status, errorText);
                        alert(`âŒ æ–°å¢æ’­æ”¾æ¸…å–®å¤±æ•—: ${errorText}`);
                    }
                } catch (error) {
                    console.error("âŒ æ–°å¢æ’­æ”¾æ¸…å–®å¤±æ•—:", error);
                    alert(`âŒ æ–°å¢æ’­æ”¾æ¸…å–®å¤±æ•—: ${error.message}`);
                }
            };

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            console.log("ç¶å®šæ–°å¢æ’­æ”¾æ¸…å–®æŒ‰éˆ•äº‹ä»¶");
            const btn = document.querySelector("button");
            console.log("æ‰¾åˆ°æ–°å¢æ’­æ”¾æ¸…å–®æŒ‰éˆ•:", btn);
            if (btn) {
                btn.addEventListener("click", function () {
                    console.log("é»æ“Šæ–°å¢æ’­æ”¾æ¸…å–®æŒ‰éˆ•");
                    window.insertpost();
                });
                console.log("âœ… æ–°å¢æ’­æ”¾æ¸…å–®äº‹ä»¶ç¶å®šæˆåŠŸ");
            } else {
                console.error("âŒ æ‰¾ä¸åˆ°æ–°å¢æ’­æ”¾æ¸…å–®æŒ‰éˆ•");
            }

            console.log("Insert Playlists Script åŸ·è¡Œå®Œç•¢");
        </script>
    </body>
</html>
