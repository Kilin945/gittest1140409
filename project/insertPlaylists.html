<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>æ–°å¢æ’­æ”¾æ¸…å–®</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            .required {
                color: red;
            }

            .form-hint {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
                font-style: italic;
            }

            .user-info {
                background: #e8f4f8;
                border: 1px solid #bee5eb;
                border-radius: 4px;
                padding: 10px;
                margin: 10px 0;
                font-weight: bold;
                color: #0c5460;
            }

            .privacy-hint {
                font-size: 11px;
                color: #888;
                margin-top: 3px;
            }
        </style>
    </head>
    <body>
        <h2>ğŸ“‹ æ–°å¢æ’­æ”¾æ¸…å–®</h2>

        <label for="playlist_name">æ’­æ”¾æ¸…å–®åç¨± <span class="required">*</span></label>
        <input type="text" id="playlist_name" placeholder="è«‹è¼¸å…¥æ’­æ”¾æ¸…å–®åç¨±" required />
        <div class="form-hint">æ’­æ”¾æ¸…å–®åç¨±ä¸å¯é‡è¤‡</div>

        <label for="is_public">éš±ç§è¨­å®š</label>
        <select id="is_public">
            <option value="false">ğŸ”’ ç§äººæ’­æ”¾æ¸…å–®ï¼ˆåƒ…è‡ªå·±å¯è¦‹ï¼‰</option>
            <option value="true">ğŸŒ å…¬é–‹æ’­æ”¾æ¸…å–®ï¼ˆæ‰€æœ‰äººå¯è¦‹ï¼‰</option>
        </select>
        <div class="privacy-hint">ğŸ’¡ å»ºç«‹å¾Œå¯åœ¨è¨­å®šä¸­ä¿®æ”¹éš±ç§æ¬Šé™</div>

        <div class="user-info">ğŸ‘¤ ç•¶å‰ä½¿ç”¨è€…ï¼š<span id="currentUserName">æ¸¬è©¦ä½¿ç”¨è€…</span></div>
        <input type="hidden" id="user_id" value="1" />

        <button id="submitBtn">æ–°å¢æ’­æ”¾æ¸…å–®</button>

        <script>
            console.log("ğŸš€ æ–°å¢æ’­æ”¾æ¸…å–®é é¢åˆå§‹åŒ–");

            // ğŸ”§ ç¢ºä¿ API_BASE åœ¨å…¨åŸŸå¯ç”¨
            window.API_BASE = (() => {
                const currentHostname = window.location.hostname;
                const currentOrigin = window.location.origin;

                if (currentHostname.includes("github.io")) {
                    console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
                    return "https://1140412connectproject-production.up.railway.app/api";
                } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                    console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
                    return "http://localhost:8000/api";
                } else if (currentHostname.includes("railway.app")) {
                    console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
                    return currentOrigin + "/api";
                } else {
                    console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
                    return "https://1140412connectproject-production.up.railway.app/api";
                }
            })();

            console.log("ğŸ“¡ API_BASE:", window.API_BASE);

            //æª¢æŸ¥é‡è¤‡çš„æ’­æ”¾æ¸…å–®åç¨±
            async function checkPlaylistNameDuplicate(playlistName, userId) {
                try {
                    console.log(`æª¢æŸ¥åç¨±é‡è¤‡: ${playlistName}`);

                    const response = await fetch(`${window.API_BASE}/check-duplicate`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            table: "playlists",
                            playlist_name: playlistName,
                            user_id: userId,
                        }),
                    });
                    if (response.ok) {
                        const result = await response.json();
                        return result.exists; //å›å‚³æ˜¯å¦é‡è¤‡
                    }
                    return false; //æª¢æŸ¥å¤±æ•—å‡è¨­ä¸é‡è¤‡
                } catch (error) {
                    console.error("æª¢æŸ¥é‡è¤‡æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    return false; //ç™¼ç”ŸéŒ¯èª¤æ™‚ä¸é˜»æ“‹ä½¿ç”¨è€…
                }
            }

            // åŸ·è¡Œç‹€æ…‹æª¢æŸ¥
            let isSubmitting = false;

            // æ–°å¢æ’­æ”¾æ¸…å–®å‡½æ•¸
            window.insertpost = async function () {
                if (isSubmitting) {
                    console.log("âš ï¸ æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹å‹¿é‡è¤‡æäº¤");
                    return;
                }

                isSubmitting = true;

                try {
                    console.log("é–‹å§‹æ–°å¢æ’­æ”¾æ¸…å–®");

                    // å–å¾—è¡¨å–®è³‡æ–™ä¸¦æ¸…ç†
                    const playlistName = document.getElementById("playlist_name").value.trim();
                    const userId = document.getElementById("user_id").value;
                    const isPublicSelect = document.getElementById("is_public");
                    const isPublic = isPublicSelect.value === "true";

                    console.log("=== æ¬„ä½å€¼æª¢æŸ¥ ===");
                    console.log("playlist_name:", `'${playlistName}'`);
                    console.log("user_id:", `'${userId}'`);
                    console.log("is_public:", isPublic);

                    // æª¢æŸ¥å¿…å¡«æ¬„ä½
                    if (!playlistName) {
                        alert("è«‹è¼¸å…¥æ’­æ”¾æ¸…å–®åç¨±ï¼");
                        document.getElementById("playlist_name").focus();
                        return;
                    }

                    if (playlistName.length < 2) {
                        alert("æ’­æ”¾æ¸…å–®åç¨±è‡³å°‘éœ€è¦2å€‹å­—å…ƒï¼");
                        document.getElementById("playlist_name").focus();
                        return;
                    }

                    // æª¢æŸ¥é‡è¤‡çš„æ’­æ”¾æ¸…å–®åç¨±
                    const isDuplicate = await checkPlaylistNameDuplicate(playlistName, userId);
                    if (isDuplicate) {
                        alert(`æ’­æ”¾æ¸…å–®åç¨±" + ${playlistName} +"é‡è¤‡å›‰~è«‹æ”¹ç”¨å…¶ä»–åç¨±!`);
                        document.getElementById("playlist_name").focus();
                        return;
                    }

                    if (!userId) {
                        alert("ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
                        return;
                    }

                    const requestData = {
                        table: "playlists",
                        playlist_name: playlistName,
                        is_public: isPublic,
                        user_id: userId,
                    };

                    console.log("ğŸ“¤ æäº¤è³‡æ–™:", requestData);
                    console.log("ä½¿ç”¨ API ç«¯é»:", `${window.API_BASE}/2/insert`);

                    const response = await fetch(`${window.API_BASE}/2/insert`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    console.log("ğŸ“¡ ä¼ºæœå™¨å›æ‡‰ç‹€æ…‹:", response.status);

                    if (response.ok) {
                        // å–å¾—éš±ç§è¨­å®šæ–‡å­—
                        const privacyText = isPublic ? "å…¬é–‹æ’­æ”¾æ¸…å–®" : "ç§äººæ’­æ”¾æ¸…å–®";
                        const privacyIcon = isPublic ? "ğŸŒ" : "ğŸ”’";
                        const currentUser = document.getElementById("currentUserName").textContent;

                        // å‰µå»ºæˆåŠŸè¨Šæ¯
                        const successMessage = `âœ… æ’­æ”¾æ¸…å–®å»ºç«‹æˆåŠŸï¼
            ğŸ“‹ æ’­æ”¾æ¸…å–®åç¨±: ${playlistName}
            ${privacyIcon} éš±ç§è¨­å®š: ${privacyText}
            ğŸ‘¤ å»ºç«‹è€…: ${currentUser}`;

                        alert(successMessage);
                        console.log("âœ… æ’­æ”¾æ¸…å–®æ–°å¢æˆåŠŸ");

                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById("playlist_name").value = "";
                        document.getElementById("is_public").value = "false"; // é è¨­ç‚ºç§äºº
                        document.getElementById("playlist_name").focus();
                    } else {
                        const errorText = await response.text();
                        console.error("âŒ æ–°å¢å¤±æ•—:", response.status, errorText);
                        alert(`âŒ æ–°å¢æ’­æ”¾æ¸…å–®å¤±æ•—: ${errorText}`);
                    }
                } catch (error) {
                    console.error("âŒ æ–°å¢æ’­æ”¾æ¸…å–®å¤±æ•—:", error);
                    alert(`âŒ æ–°å¢æ’­æ”¾æ¸…å–®å¤±æ•—: ${error.message}`);
                } finally {
                    isSubmitting = false; // ç¢ºä¿ç‹€æ…‹é‡ç½®
                }
            };

            // äº‹ä»¶ç¶å®šç­–ç•¥
            function bindSubmitEvent() {
                const submitBtn = document.getElementById("submitBtn");
                if (submitBtn) {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç¶å®šé
                    if (submitBtn.hasAttribute("data-bound")) {
                        console.log("âš ï¸ æŒ‰éˆ•å·²ç¶“ç¶å®šéäº‹ä»¶ï¼Œè·³é");
                        return true;
                    }

                    // ç¶å®šäº‹ä»¶
                    submitBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        console.log("ğŸ”¥ æ–°å¢æ’­æ”¾æ¸…å–®æŒ‰éˆ•è¢«é»æ“Š");
                        window.insertpost();
                    });

                    // æ¨™è¨˜å·²ç¶å®šï¼Œé˜²æ­¢é‡è¤‡
                    submitBtn.setAttribute("data-bound", "true");
                    console.log("âœ… æ–°å¢æ’­æ”¾æ¸…å–®æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š");
                    return true;
                } else {
                    console.warn("âš ï¸ æœªæ‰¾åˆ°æ–°å¢æ’­æ”¾æ¸…å–®æŒ‰éˆ•");
                    return false;
                }
            }

            // å¤šç¨®è¼‰å…¥æ™‚æ©Ÿç¶å®šäº‹ä»¶
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", bindSubmitEvent);
            } else {
                bindSubmitEvent();
            }

            // Enter éµæäº¤ï¼ˆåŠ ä¸Šé˜²é‡è¤‡æ©Ÿåˆ¶ï¼‰
            let enterKeyBound = false;
            if (!enterKeyBound) {
                document.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        window.insertpost();
                    }
                });
                enterKeyBound = true;
            }

            console.log("âœ… æ–°å¢æ’­æ”¾æ¸…å–®é é¢åˆå§‹åŒ–å®Œæˆ");
        </script>
    </body>
</html>
