<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>音樂選單系統 - 資料操作</title>
        <!-- Font Awesome 圖標庫 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="css/main.css" />
        <style>
            .page-title {
                text-align: center;
                margin: 20px 0;
                color: var(--claude-text, #ffffff);
            }

            .tab-btn {
                background: var(--claude-primary, #ff6b35);
                color: white;
                border: none;
                padding: 10px 20px;
                margin: 5px;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .tab-btn:hover {
                background: var(--claude-primary-hover, #e55a2b);
                transform: translateY(-2px);
            }

            .tab-btn:active {
                transform: translateY(0);
            }

            #tableContainer {
                margin: 20px 0;
                padding: 20px;
                background: var(--claude-card, rgba(255, 255, 255, 0.1));
                border-radius: 8px;
                min-height: 200px;
                color: var(--claude-text, #ffffff);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
                overflow: hidden;
            }

            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
                color: #333;
            }

            th {
                background: var(--claude-primary, #ff6b35);
                color: white;
                font-weight: bold;
            }

            tr:hover {
                background: rgba(255, 107, 53, 0.1);
            }

            .delete-btn {
                background: #dc3545;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                transition: background 0.3s ease;
            }

            .delete-btn:hover {
                background: #c82333;
            }

            .loading {
                text-align: center;
                padding: 20px;
                font-style: italic;
                color: var(--claude-text-muted, rgba(255, 255, 255, 0.7));
            }

            .error {
                color: #ff6b6b;
                text-align: center;
                padding: 20px;
            }

            .no-data {
                text-align: center;
                padding: 20px;
                color: var(--claude-text-muted, rgba(255, 255, 255, 0.7));
                font-style: italic;
            }
        </style>
    </head>

    <body>
        <div class="page-title">
            <h1>📊 資料操作管理</h1>
            <p>選擇要查看的資料表</p>
        </div>

        <div style="text-align: center; margin: 20px 0">
            <button class="tab-btn" onclick="loadTable(apiArtists, container, '歌手')">
                <i class="fas fa-microphone"></i> 歌手清單
            </button>
            <button class="tab-btn" onclick="loadTable(apiSongs, container, '歌曲')">
                <i class="fas fa-music"></i> 歌曲清單
            </button>
            <button class="tab-btn" onclick="loadTable(apiAlbums, container, '專輯')">
                <i class="fas fa-compact-disc"></i> 專輯清單
            </button>
            <button class="tab-btn" onclick="loadTable(apiUsers, container, '使用者')">
                <i class="fas fa-users"></i> 使用者清單
            </button>
            <button class="tab-btn" onclick="loadTable(apiPlaylists, container, '播放清單')">
                <i class="fas fa-list"></i> 播放清單
            </button>
            <button class="tab-btn" onclick="loadTable(apiPlaylistSongs, container, '播放歌曲')">
                <i class="fas fa-play-circle"></i> 播放歌曲清單
            </button>
        </div>

        <div>
            <div id="tableContainer">
                <div class="no-data">
                    <i class="fas fa-info-circle"></i>
                    請點選上方按鈕查詢資料
                </div>
            </div>
        </div>

        <script>
            console.log("Data Operations Script 開始執行");

            // 🔧 動態設定 API Base URL - 修正硬編碼問題
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                // GitHub Pages 環境
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("☁️ GitHub Pages 環境，使用 Railway 後端");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // 本地開發環境
                API_BASE = "http://localhost:8000/api";
                console.log("🏠 本地開發環境");
            } else if (currentHostname.includes("railway.app")) {
                // 直接訪問 Railway 應用
                API_BASE = currentOrigin + "/api";
                console.log("🚂 Railway 環境，使用相對路徑");
            } else {
                // 其他環境，預設使用 Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("🌐 未知環境，預設使用 Railway 後端");
            }
            console.log("📡 Data Operations API_BASE:", API_BASE);

            // 使用動態 API URL
            const apiArtists = `${API_BASE}/artists`;
            const apiSongs = `${API_BASE}/songs`;
            const apiAlbums = `${API_BASE}/albums`;
            const apiUsers = `${API_BASE}/users`;
            const apiPlaylists = `${API_BASE}/playlists`;
            const apiPlaylistSongs = `${API_BASE}/playlist_songs`;

            const container = document.getElementById("tableContainer");
            let currenturl = "";
            let currenttodiv = container;
            let currentTableName = "";

            // 載入表格資料
            async function loadTable(url, todiv, displayName) {
                currenturl = url;
                currenttodiv = todiv;
                currentTableName = displayName;

                try {
                    // 顯示載入狀態
                    todiv.innerHTML = `
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            正在載入${displayName}資料...
                        </div>
                    `;

                    console.log(`🔄 開始載入${displayName}資料，URL: ${url}`);

                    let tablename = "";
                    switch (url) {
                        case apiArtists:
                            tablename = "artists";
                            break;
                        case apiSongs:
                            tablename = "songs";
                            break;
                        case apiAlbums:
                            tablename = "albums";
                            break;
                        case apiUsers:
                            tablename = "users";
                            break;
                        case apiPlaylists:
                            tablename = "playlists";
                            break;
                        case apiPlaylistSongs:
                            tablename = "playlist_songs";
                            break;
                        default:
                            throw new Error("未知的 API 端點");
                    }

                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error(`HTTP 錯誤: ${resp.status}`);
                    const data = await resp.json();

                    if (!Array.isArray(data) || data.length === 0) {
                        todiv.innerHTML = `
                            <div class="no-data">
                                <i class="fas fa-inbox"></i>
                                ${displayName}沒有資料
                            </div>
                        `;
                        return;
                    }

                    console.log(`✅ ${displayName}資料載入成功，共 ${data.length} 筆記錄`);

                    // 產生表格 HTML
                    let table = `
                        <div style="margin-bottom: 10px;">
                            <strong>📋 ${displayName}清單</strong> 
                            <span style="color: var(--claude-text-muted, #999); font-size: 14px;">
                                (共 ${data.length} 筆記錄)
                            </span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 80px;">操作</th>
                    `;

                    // 自動產出表頭
                    const keys = Object.keys(data[0]);
                    keys.forEach((k) => {
                        table += `<th>${k}</th>`;
                    });
                    table += `</tr></thead><tbody>`;

                    // 每一列資料
                    data.forEach((row, index) => {
                        const rowData = { ...row, state: -1, table: tablename };
                        const jsonString = JSON.stringify(rowData).replace(/"/g, "&quot;");

                        table += `<tr>`;
                        table += `
                            <td>
                                <button 
                                    class="delete-btn" 
                                    onclick='confirmDelete(${JSON.stringify(rowData)}, "${displayName}", ${index + 1})'
                                    title="刪除這筆記錄">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;

                        keys.forEach((k) => {
                            const value = row[k] !== null && row[k] !== undefined ? row[k] : "";
                            table += `<td>${value}</td>`;
                        });
                        table += `</tr>`;
                    });

                    table += `</tbody></table>`;
                    todiv.innerHTML = table;
                } catch (err) {
                    console.error(`❌ 載入${displayName || "資料"}失敗:`, err);
                    todiv.innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i>
                            載入${displayName || "資料"}失敗：${err.message}
                        </div>
                    `;
                }
            }

            // 確認刪除對話框
            function confirmDelete(rowData, displayName, rowNumber) {
                const confirmMessage = `確定要刪除這筆${displayName}資料嗎？\n\n這是第 ${rowNumber} 筆記錄\n此操作無法復原！`;

                if (confirm(confirmMessage)) {
                    updaterow(rowData, displayName);
                }
            }

            // 更新/刪除資料
            async function updaterow(returnbody, displayName) {
                try {
                    console.log("📤 提交刪除請求:", returnbody);
                    console.log("使用 API 端點:", `${API_BASE}/2/update`);

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(returnbody),
                    });

                    if (response.ok) {
                        console.log(`✅ ${displayName}記錄刪除成功`);
                        alert(`✅ ${displayName}記錄已成功刪除！`);

                        // 重新載入當前表格
                        loadTable(currenturl, currenttodiv, currentTableName);
                    } else {
                        const errorText = await response.text();
                        throw new Error(`刪除失敗: ${errorText}`);
                    }
                } catch (error) {
                    console.error("❌ 刪除操作失敗:", error);
                    alert(`❌ 刪除${displayName}失敗: ${error.message}`);
                }
            }

            console.log("Data Operations Script 執行完畢");
        </script>
    </body>
</html>
