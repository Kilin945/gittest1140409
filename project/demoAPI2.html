<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>éŸ³æ¨‚é¸å–®ç³»çµ± - è³‡æ–™æ“ä½œ</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="css/main.css" />
        <style>
            .page-title {
                text-align: center;
                margin: 20px 0;
                color: var(--claude-text, #ffffff);
            }

            .tab-btn {
                background: var(--claude-primary, #ff6b35);
                color: white;
                border: none;
                padding: 10px 20px;
                margin: 5px;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .tab-btn:hover {
                background: var(--claude-primary-hover, #e55a2b);
                transform: translateY(-2px);
            }

            .tab-btn:active {
                transform: translateY(0);
            }

            #tableContainer {
                margin: 20px 0;
                padding: 20px;
                background: var(--claude-card, rgba(255, 255, 255, 0.1));
                border-radius: 8px;
                min-height: 200px;
                color: var(--claude-text, #ffffff);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
                overflow: hidden;
            }

            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
                color: #333;
            }

            th {
                background: var(--claude-primary, #ff6b35);
                color: white;
                font-weight: bold;
            }

            tr:hover {
                background: rgba(255, 107, 53, 0.1);
            }

            .delete-btn {
                background: #dc3545;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                transition: background 0.3s ease;
            }

            .delete-btn:hover {
                background: #c82333;
            }

            .loading {
                text-align: center;
                padding: 20px;
                font-style: italic;
                color: var(--claude-text-muted, rgba(255, 255, 255, 0.7));
            }

            .error {
                color: #ff6b6b;
                text-align: center;
                padding: 20px;
            }

            .no-data {
                text-align: center;
                padding: 20px;
                color: var(--claude-text-muted, rgba(255, 255, 255, 0.7));
                font-style: italic;
            }
        </style>
    </head>

    <body>
        <div class="page-title">
            <h1>ğŸ“Š è³‡æ–™æ“ä½œç®¡ç†</h1>
            <p>é¸æ“‡è¦æŸ¥çœ‹çš„è³‡æ–™è¡¨</p>
        </div>

        <div style="text-align: center; margin: 20px 0">
            <button class="tab-btn" onclick="loadTable(apiArtists, container, 'æ­Œæ‰‹')">
                <i class="fas fa-microphone"></i> æ­Œæ‰‹æ¸…å–®
            </button>
            <button class="tab-btn" onclick="loadTable(apiSongs, container, 'æ­Œæ›²')">
                <i class="fas fa-music"></i> æ­Œæ›²æ¸…å–®
            </button>
            <button class="tab-btn" onclick="loadTable(apiAlbums, container, 'å°ˆè¼¯')">
                <i class="fas fa-compact-disc"></i> å°ˆè¼¯æ¸…å–®
            </button>
            <button class="tab-btn" onclick="loadTable(apiUsers, container, 'ä½¿ç”¨è€…')">
                <i class="fas fa-users"></i> ä½¿ç”¨è€…æ¸…å–®
            </button>
            <button class="tab-btn" onclick="loadTable(apiPlaylists, container, 'æ’­æ”¾æ¸…å–®')">
                <i class="fas fa-list"></i> æ’­æ”¾æ¸…å–®
            </button>
            <button class="tab-btn" onclick="loadTable(apiPlaylistSongs, container, 'æ’­æ”¾æ­Œæ›²')">
                <i class="fas fa-play-circle"></i> æ’­æ”¾æ­Œæ›²æ¸…å–®
            </button>
        </div>

        <div>
            <div id="tableContainer">
                <div class="no-data">
                    <i class="fas fa-info-circle"></i>
                    è«‹é»é¸ä¸Šæ–¹æŒ‰éˆ•æŸ¥è©¢è³‡æ–™
                </div>
            </div>
        </div>

        <script>
            console.log("Data Operations Script é–‹å§‹åŸ·è¡Œ");

            // ğŸ”§ å‹•æ…‹è¨­å®š API Base URL - ä¿®æ­£ç¡¬ç·¨ç¢¼å•é¡Œ
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                // GitHub Pages ç’°å¢ƒ
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (currentHostname.includes("railway.app")) {
                // ç›´æ¥è¨ªå• Railway æ‡‰ç”¨
                API_BASE = currentOrigin + "/api";
                console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
            } else {
                // å…¶ä»–ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
            }
            console.log("ğŸ“¡ Data Operations API_BASE:", API_BASE);

            // ä½¿ç”¨å‹•æ…‹ API URL
            const apiArtists = `${API_BASE}/artists`;
            const apiSongs = `${API_BASE}/songs`;
            const apiAlbums = `${API_BASE}/albums`;
            const apiUsers = `${API_BASE}/users`;
            const apiPlaylists = `${API_BASE}/playlists`;
            const apiPlaylistSongs = `${API_BASE}/playlist_songs`;

            const container = document.getElementById("tableContainer");
            let currenturl = "";
            let currenttodiv = container;
            let currentTableName = "";

            // è¼‰å…¥è¡¨æ ¼è³‡æ–™
            async function loadTable(url, todiv, displayName) {
                currenturl = url;
                currenttodiv = todiv;
                currentTableName = displayName;

                try {
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    todiv.innerHTML = `
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            æ­£åœ¨è¼‰å…¥${displayName}è³‡æ–™...
                        </div>
                    `;

                    console.log(`ğŸ”„ é–‹å§‹è¼‰å…¥${displayName}è³‡æ–™ï¼ŒURL: ${url}`);

                    let tablename = "";
                    switch (url) {
                        case apiArtists:
                            tablename = "artists";
                            break;
                        case apiSongs:
                            tablename = "songs";
                            break;
                        case apiAlbums:
                            tablename = "albums";
                            break;
                        case apiUsers:
                            tablename = "users";
                            break;
                        case apiPlaylists:
                            tablename = "playlists";
                            break;
                        case apiPlaylistSongs:
                            tablename = "playlist_songs";
                            break;
                        default:
                            throw new Error("æœªçŸ¥çš„ API ç«¯é»");
                    }

                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error(`HTTP éŒ¯èª¤: ${resp.status}`);
                    const data = await resp.json();

                    if (!Array.isArray(data) || data.length === 0) {
                        todiv.innerHTML = `
                            <div class="no-data">
                                <i class="fas fa-inbox"></i>
                                ${displayName}æ²’æœ‰è³‡æ–™
                            </div>
                        `;
                        return;
                    }

                    console.log(`âœ… ${displayName}è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…± ${data.length} ç­†è¨˜éŒ„`);

                    // ç”¢ç”Ÿè¡¨æ ¼ HTML
                    let table = `
                        <div style="margin-bottom: 10px;">
                            <strong>ğŸ“‹ ${displayName}æ¸…å–®</strong> 
                            <span style="color: var(--claude-text-muted, #999); font-size: 14px;">
                                (å…± ${data.length} ç­†è¨˜éŒ„)
                            </span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 80px;">æ“ä½œ</th>
                    `;

                    // è‡ªå‹•ç”¢å‡ºè¡¨é ­
                    const keys = Object.keys(data[0]);
                    keys.forEach((k) => {
                        table += `<th>${k}</th>`;
                    });
                    table += `</tr></thead><tbody>`;

                    // æ¯ä¸€åˆ—è³‡æ–™
                    data.forEach((row, index) => {
                        const rowData = { ...row, state: -1, table: tablename };
                        const jsonString = JSON.stringify(rowData).replace(/"/g, "&quot;");

                        table += `<tr>`;
                        table += `
                            <td>
                                <button 
                                    class="delete-btn" 
                                    onclick='confirmDelete(${JSON.stringify(rowData)}, "${displayName}", ${index + 1})'
                                    title="åˆªé™¤é€™ç­†è¨˜éŒ„">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;

                        keys.forEach((k) => {
                            const value = row[k] !== null && row[k] !== undefined ? row[k] : "";
                            table += `<td>${value}</td>`;
                        });
                        table += `</tr>`;
                    });

                    table += `</tbody></table>`;
                    todiv.innerHTML = table;
                } catch (err) {
                    console.error(`âŒ è¼‰å…¥${displayName || "è³‡æ–™"}å¤±æ•—:`, err);
                    todiv.innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i>
                            è¼‰å…¥${displayName || "è³‡æ–™"}å¤±æ•—ï¼š${err.message}
                        </div>
                    `;
                }
            }

            // ç¢ºèªåˆªé™¤å°è©±æ¡†
            function confirmDelete(rowData, displayName, rowNumber) {
                const confirmMessage = `ç¢ºå®šè¦åˆªé™¤é€™ç­†${displayName}è³‡æ–™å—ï¼Ÿ\n\né€™æ˜¯ç¬¬ ${rowNumber} ç­†è¨˜éŒ„\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;

                if (confirm(confirmMessage)) {
                    updaterow(rowData, displayName);
                }
            }

            // æ›´æ–°/åˆªé™¤è³‡æ–™
            async function updaterow(returnbody, displayName) {
                try {
                    console.log("ğŸ“¤ æäº¤åˆªé™¤è«‹æ±‚:", returnbody);
                    console.log("ä½¿ç”¨ API ç«¯é»:", `${API_BASE}/2/update`);

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(returnbody),
                    });

                    if (response.ok) {
                        console.log(`âœ… ${displayName}è¨˜éŒ„åˆªé™¤æˆåŠŸ`);
                        alert(`âœ… ${displayName}è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ï¼`);

                        // é‡æ–°è¼‰å…¥ç•¶å‰è¡¨æ ¼
                        loadTable(currenturl, currenttodiv, currentTableName);
                    } else {
                        const errorText = await response.text();
                        throw new Error(`åˆªé™¤å¤±æ•—: ${errorText}`);
                    }
                } catch (error) {
                    console.error("âŒ åˆªé™¤æ“ä½œå¤±æ•—:", error);
                    alert(`âŒ åˆªé™¤${displayName}å¤±æ•—: ${error.message}`);
                }
            }

            console.log("Data Operations Script åŸ·è¡Œå®Œç•¢");
        </script>
    </body>
</html>
