<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>個人設定 - Kilin 音樂系統</title>
        <!-- Font Awesome 圖標庫 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

        <style>
            /* Claude 風格完整重置 */
            *,
            *::before,
            *::after {
                box-sizing: border-box !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Claude 風格色彩變數 */
            :root {
                --claude-bg: #0a0f0d !important;
                --claude-bg-secondary: #0f1512 !important;
                --claude-primary: #d97742 !important;
                --claude-primary-hover: #c56a3a !important;
                --claude-accent: #e08856 !important;
                --claude-text: #ffffff !important;
                --claude-text-secondary: #e5e7eb !important;
                --claude-text-muted: #9ca3af !important;
                --claude-card: rgba(217, 119, 66, 0.08) !important;
                --claude-card-hover: rgba(217, 119, 66, 0.12) !important;
                --claude-border: rgba(217, 119, 66, 0.3) !important;
                --claude-shadow: 0 4px 20px rgba(217, 119, 66, 0.15) !important;
                --claude-shadow-strong: 0 8px 32px rgba(217, 119, 66, 0.25) !important;
                --claude-success-green: #22c55e !important;
                --claude-danger-red: #ef4444 !important;
                --border-radius: 16px !important;
                --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            /* 基礎樣式 */
            body {
                background: var(--claude-bg) !important;
                background-image: radial-gradient(circle at 20% 20%, rgba(217, 119, 66, 0.08) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(224, 136, 86, 0.06) 0%, transparent 50%),
                    linear-gradient(135deg, var(--claude-bg) 0%, var(--claude-bg-secondary) 100%) !important;
                background-attachment: fixed !important;
                color: var(--claude-text) !important;
                font-family: "Inter", "Segoe UI", "微軟正黑體", sans-serif !important;
                line-height: 1.6 !important;
                min-height: 100vh !important;
                padding: 20px !important;
            }

            .settings-container {
                max-width: 800px !important;
                margin: 0 auto !important;
                padding: 0 !important;
            }

            /* 頁面標題 */
            .settings-header {
                text-align: center !important;
                margin: 0 0 40px 0 !important;
                padding: 30px 20px !important;
                background: var(--claude-card) !important;
                backdrop-filter: blur(20px) !important;
                border: 1px solid var(--claude-border) !important;
                border-radius: var(--border-radius) !important;
                box-shadow: var(--claude-shadow) !important;
                position: relative !important;
                overflow: hidden !important;
            }

            .settings-header::before {
                content: "" !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: linear-gradient(
                    45deg,
                    transparent 0%,
                    rgba(217, 119, 66, 0.02) 50%,
                    transparent 100%
                ) !important;
                z-index: 0 !important;
            }

            .settings-header-content {
                position: relative !important;
                z-index: 1 !important;
            }

            .settings-title {
                font-size: 2.5rem !important;
                font-weight: 700 !important;
                color: var(--claude-text) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 15px !important;
                margin: 0 0 10px 0 !important;
                font-family: inherit !important;
            }

            .settings-title i {
                color: var(--claude-primary) !important;
                font-size: 2.2rem !important;
            }

            .settings-subtitle {
                color: var(--claude-text-muted) !important;
                font-size: 1.1rem !important;
                margin: 0 !important;
            }

            /* 主要設定卡片 */
            .settings-card {
                background: var(--claude-card) !important;
                backdrop-filter: blur(20px) !important;
                border: 1px solid var(--claude-border) !important;
                border-radius: var(--border-radius) !important;
                padding: 40px !important;
                box-shadow: var(--claude-shadow-strong) !important;
                position: relative !important;
                overflow: hidden !important;
                animation: fadeInUp 0.6s ease-out !important;
            }

            .settings-card::before {
                content: "" !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: linear-gradient(
                    45deg,
                    transparent 0%,
                    rgba(217, 119, 66, 0.02) 50%,
                    transparent 100%
                ) !important;
                z-index: 0 !important;
            }

            .settings-content {
                position: relative !important;
                z-index: 1 !important;
            }

            /* 使用者資訊區塊 */
            .user-info {
                background: var(--claude-primary) !important;
                color: white !important;
                padding: 25px !important;
                border-radius: var(--border-radius) !important;
                margin: 0 0 30px 0 !important;
                text-align: center !important;
                box-shadow: var(--claude-shadow) !important;
            }

            .user-avatar {
                width: 80px !important;
                height: 80px !important;
                background: rgba(255, 255, 255, 0.2) !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                margin: 0 auto 15px auto !important;
                font-size: 2rem !important;
            }

            .user-name {
                font-size: 1.4rem !important;
                font-weight: 700 !important;
                margin: 0 0 5px 0 !important;
            }

            .user-id {
                font-size: 0.9rem !important;
                opacity: 0.8 !important;
                margin: 0 !important;
            }

            /* 表單樣式 */
            .settings-form {
                display: flex !important;
                flex-direction: column !important;
                gap: 25px !important;
            }

            .form-group {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }

            .form-label {
                font-size: 1rem !important;
                font-weight: 600 !important;
                color: var(--claude-text-secondary) !important;
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                margin: 0 !important;
                font-family: inherit !important;
            }

            .form-input,
            .form-select {
                width: 100% !important;
                padding: 16px 20px !important;
                border: 2px solid var(--claude-border) !important;
                border-radius: var(--border-radius) !important;
                background: var(--claude-bg-secondary) !important;
                color: var(--claude-text) !important;
                font-size: 1rem !important;
                transition: var(--transition) !important;
                font-family: inherit !important;
                outline: none !important;
            }

            .form-input::placeholder {
                color: var(--claude-text-muted) !important;
            }

            .form-input:focus,
            .form-select:focus {
                border-color: var(--claude-primary) !important;
                box-shadow: 0 0 0 4px rgba(217, 119, 66, 0.2) !important;
                background: var(--claude-bg) !important;
            }

            .form-input:disabled {
                background: rgba(255, 255, 255, 0.05) !important;
                color: var(--claude-text-muted) !important;
                cursor: not-allowed !important;
            }

            /* 按鈕樣式 */
            .btn-group {
                display: flex !important;
                gap: 15px !important;
                margin: 20px 0 0 0 !important;
                flex-wrap: wrap !important;
            }

            .settings-btn {
                padding: 16px 30px !important;
                border: none !important;
                border-radius: var(--border-radius) !important;
                font-size: 1rem !important;
                font-weight: 600 !important;
                cursor: pointer !important;
                transition: var(--transition) !important;
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                flex: 1 !important;
                min-width: 150px !important;
                justify-content: center !important;
                font-family: inherit !important;
                outline: none !important;
            }

            .btn-save {
                background: linear-gradient(135deg, var(--claude-success-green), #16a34a) !important;
                color: white !important;
                box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3) !important;
            }

            .btn-save:hover {
                background: linear-gradient(135deg, #16a34a, #15803d) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4) !important;
            }

            .btn-reset {
                background: linear-gradient(135deg, var(--claude-text-muted), #6b7280) !important;
                color: white !important;
                box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3) !important;
            }

            .btn-reset:hover {
                background: linear-gradient(135deg, #6b7280, #4b5563) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4) !important;
            }

            .btn-delete {
                background: linear-gradient(135deg, var(--claude-danger-red), #dc2626) !important;
                color: white !important;
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3) !important;
            }

            .btn-delete:hover {
                background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4) !important;
            }

            .settings-btn:disabled {
                background: #666 !important;
                cursor: not-allowed !important;
                transform: none !important;
                opacity: 0.6 !important;
            }

            /* 密碼輸入框特殊樣式 */
            .password-group {
                position: relative !important;
            }

            .password-toggle {
                position: absolute !important;
                right: 15px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                background: none !important;
                border: none !important;
                color: var(--claude-text-muted) !important;
                cursor: pointer !important;
                font-size: 1.1rem !important;
                transition: var(--transition) !important;
                padding: 5px !important;
            }

            .password-toggle:hover {
                color: var(--claude-primary) !important;
            }

            /* 載入和訊息狀態 */
            .loading-overlay {
                display: none !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 9999 !important;
                align-items: center !important;
                justify-content: center !important;
            }

            .loading-content {
                background: var(--claude-card) !important;
                padding: 30px !important;
                border-radius: var(--border-radius) !important;
                text-align: center !important;
                backdrop-filter: blur(20px) !important;
                border: 1px solid var(--claude-border) !important;
            }

            .loading-spinner {
                font-size: 2rem !important;
                color: var(--claude-primary) !important;
                animation: spin 1s linear infinite !important;
                margin: 0 0 15px 0 !important;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }

            .message {
                padding: 15px 20px !important;
                border-radius: var(--border-radius) !important;
                margin: 15px 0 !important;
                display: none !important;
                align-items: center !important;
                gap: 10px !important;
                font-weight: 500 !important;
            }

            .message.success {
                background: rgba(34, 197, 94, 0.1) !important;
                border: 1px solid rgba(34, 197, 94, 0.3) !important;
                color: #4ade80 !important;
            }

            .message.error {
                background: rgba(239, 68, 68, 0.1) !important;
                border: 1px solid rgba(239, 68, 68, 0.3) !important;
                color: #fca5a5 !important;
            }

            .message.show {
                display: flex !important;
                animation: slideIn 0.3s ease-out !important;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(40px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* 響應式設計 */
            @media (max-width: 768px) {
                body {
                    padding: 10px !important;
                }

                .settings-card {
                    padding: 30px 20px !important;
                }

                .settings-title {
                    font-size: 2rem !important;
                    flex-direction: column !important;
                    gap: 10px !important;
                }

                .btn-group {
                    flex-direction: column !important;
                }

                .settings-btn {
                    min-width: auto !important;
                }
            }
        </style>
    </head>

    <body>
        <div class="settings-container">
            <!-- 頁面標題 -->
            <div class="settings-header">
                <div class="settings-header-content">
                    <h1 class="settings-title">
                        <i class="fas fa-user-cog"></i>
                        個人設定
                    </h1>
                    <p class="settings-subtitle">管理您的個人資料和帳戶設定</p>
                </div>
            </div>

            <!-- 主要設定區域 -->
            <div class="settings-card">
                <div class="settings-content">
                    <!-- 使用者資訊展示 -->
                    <div class="user-info" id="userInfo">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-name" id="displayUserName">載入中...</div>
                        <div class="user-id" id="displayUserId">ID: ---</div>
                    </div>

                    <!-- 訊息顯示區域 -->
                    <div class="message success" id="successMessage">
                        <i class="fas fa-check-circle"></i>
                        <span id="successText">操作成功</span>
                    </div>
                    <div class="message error" id="errorMessage">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="errorText">發生錯誤</span>
                    </div>

                    <!-- 設定表單 -->
                    <form class="settings-form" id="settingsForm">
                        <div class="form-group">
                            <label class="form-label" for="userId">
                                <i class="fas fa-id-badge"></i>
                                使用者編號
                            </label>
                            <input type="text" id="userId" class="form-input" disabled placeholder="自動生成" />
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="userName">
                                <i class="fas fa-user"></i>
                                使用者名稱
                            </label>
                            <input
                                type="text"
                                id="userName"
                                class="form-input"
                                placeholder="請輸入使用者名稱"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="password">
                                <i class="fas fa-lock"></i>
                                密碼
                            </label>
                            <div class="password-group">
                                <input
                                    type="password"
                                    id="password"
                                    class="form-input"
                                    placeholder="請輸入新密碼（留空表示不修改）"
                                />
                                <button type="button" class="password-toggle" onclick="togglePassword()">
                                    <i class="fas fa-eye" id="passwordIcon"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="usageTime">
                                <i class="fas fa-clock"></i>
                                累計使用時間
                            </label>
                            <input type="text" id="usageTime" class="form-input" disabled placeholder="00:00:00" />
                        </div>

                        <!-- 按鈕組 -->
                        <div class="btn-group">
                            <button type="submit" class="settings-btn btn-save">
                                <i class="fas fa-save"></i>
                                儲存設定
                            </button>
                            <button type="button" class="settings-btn btn-reset" onclick="resetForm()">
                                <i class="fas fa-undo"></i>
                                重置
                            </button>
                            <button type="button" class="settings-btn btn-delete" onclick="deleteAccount()">
                                <i class="fas fa-trash"></i>
                                刪除帳號
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 載入覆蓋層 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner">
                    <i class="fas fa-spinner"></i>
                </div>
                <p>處理中，請稍候...</p>
            </div>
        </div>

        <script>
            // 全域變數
            let currentUser = null;
            let originalUserData = null;

            // API 基準 URL
            function getApiBase() {
                const currentHostname = window.location.hostname;
                const currentOrigin = window.location.origin;

                if (currentHostname.includes("github.io")) {
                    return "https://1140412connectproject-production.up.railway.app/api";
                } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                    return "https://1140412connectproject-production.up.railway.app/api";
                } else if (currentHostname.includes("railway.app")) {
                    return currentOrigin + "/api";
                } else {
                    return "https://1140412connectproject-production.up.railway.app/api";
                }
            }

            // 初始化
            document.addEventListener("DOMContentLoaded", function () {
                loadUserSettings();
            });

            // 載入使用者設定
            async function loadUserSettings() {
                try {
                    showLoading(true);

                    // 從 localStorage 獲取當前使用者資訊
                    const sessionData = localStorage.getItem("kilin_user_session");
                    const guestData = localStorage.getItem("kilin_guest_session");

                    if (guestData) {
                        showError("遊客模式無法修改個人設定");
                        return;
                    }

                    if (!sessionData) {
                        showError("請先登入後再使用個人設定功能");
                        return;
                    }

                    currentUser = JSON.parse(sessionData);

                    // 從 API 獲取最新的使用者資料
                    const API_BASE = getApiBase();
                    const response = await fetch(`${API_BASE}/users`);

                    if (!response.ok) {
                        throw new Error("無法載入使用者資料");
                    }

                    const users = await response.json();
                    const userData = users.find((u) => u.user_id == currentUser.user_id);

                    if (!userData) {
                        throw new Error("找不到使用者資料");
                    }

                    // 儲存原始資料
                    originalUserData = { ...userData };

                    // 填入表單
                    document.getElementById("userId").value = userData.user_id || "";
                    document.getElementById("userName").value = userData.user_name || "";
                    document.getElementById("usageTime").value = userData.usage_time || "00:00:00";

                    // 更新顯示資訊
                    document.getElementById("displayUserName").textContent = userData.user_name || "未設定";
                    document.getElementById("displayUserId").textContent = `ID: ${userData.user_id || "---"}`;

                    showLoading(false);
                    console.log("✅ 使用者設定載入成功");
                } catch (error) {
                    console.error("❌ 載入使用者設定失敗:", error);
                    showError(error.message);
                    showLoading(false);
                }
            }

            // 處理表單提交
            document.getElementById("settingsForm").addEventListener("submit", async function (e) {
                e.preventDefault();
                await saveSettings();
            });

            // 儲存設定
            async function saveSettings() {
                try {
                    showLoading(true);

                    const formData = {
                        table: "users",
                        user_id: document.getElementById("userId").value,
                        user_name: document.getElementById("userName").value.trim(),
                        usage_time: document.getElementById("usageTime").value,
                        state: "0",
                    };

                    // 只有在輸入新密碼時才更新密碼
                    const newPassword = document.getElementById("password").value.trim();
                    if (newPassword) {
                        formData.password = newPassword;
                    } else {
                        formData.password = originalUserData.password; // 使用原密碼
                    }

                    // 驗證必填欄位
                    if (!formData.user_name) {
                        throw new Error("使用者名稱不能為空");
                    }

                    const API_BASE = getApiBase();
                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(formData),
                    });

                    if (response.ok) {
                        // 更新 localStorage 中的使用者資訊
                        currentUser.user_name = formData.user_name;
                        if (newPassword) {
                            currentUser.password = newPassword;
                        }
                        localStorage.setItem("kilin_user_session", JSON.stringify(currentUser));

                        // 更新顯示資訊
                        document.getElementById("displayUserName").textContent = formData.user_name;

                        // 清空密碼欄位
                        document.getElementById("password").value = "";

                        showSuccess("個人設定更新成功！");
                        console.log("✅ 設定儲存成功");
                    } else {
                        const errorText = await response.text();
                        throw new Error(`更新失敗: ${errorText}`);
                    }
                } catch (error) {
                    console.error("❌ 儲存設定失敗:", error);
                    showError(error.message);
                } finally {
                    showLoading(false);
                }
            }

            // 重置表單
            function resetForm() {
                if (originalUserData) {
                    document.getElementById("userName").value = originalUserData.user_name || "";
                    document.getElementById("password").value = "";
                    showSuccess("表單已重置");
                }
            }

            // 刪除帳號
            async function deleteAccount() {
                const confirmMessage = `⚠️ 警告：此操作將永久刪除您的帳號！\n\n確定要刪除帳號「${currentUser.user_name}」嗎？\n\n此操作無法復原！`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                const secondConfirm = confirm("最後確認：真的要刪除帳號嗎？");
                if (!secondConfirm) {
                    return;
                }

                try {
                    showLoading(true);

                    const deleteData = {
                        table: "users",
                        user_id: currentUser.user_id,
                        user_name: currentUser.user_name,
                        password: originalUserData.password,
                        usage_time: originalUserData.usage_time || "00:00:00",
                        state: "-1", // 設為刪除狀態
                    };

                    const API_BASE = getApiBase();
                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(deleteData),
                    });

                    if (response.ok) {
                        alert("帳號已成功刪除，即將跳轉到登入頁面");

                        // 清除本地會話
                        localStorage.removeItem("kilin_user_session");
                        localStorage.removeItem("kilin_guest_session");

                        // 跳轉到登入頁面
                        window.location.href = "login.html";
                    } else {
                        const errorText = await response.text();
                        throw new Error(`刪除失敗: ${errorText}`);
                    }
                } catch (error) {
                    console.error("❌ 刪除帳號失敗:", error);
                    showError(error.message);
                } finally {
                    showLoading(false);
                }
            }

            // 切換密碼顯示
            function togglePassword() {
                const passwordInput = document.getElementById("password");
                const passwordIcon = document.getElementById("passwordIcon");

                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    passwordIcon.className = "fas fa-eye-slash";
                } else {
                    passwordInput.type = "password";
                    passwordIcon.className = "fas fa-eye";
                }
            }

            // 顯示載入狀態
            function showLoading(show = true) {
                const overlay = document.getElementById("loadingOverlay");
                if (show) {
                    overlay.style.display = "flex";
                } else {
                    overlay.style.display = "none";
                }
            }

            // 顯示成功訊息
            function showSuccess(message) {
                hideAllMessages();
                const successMessage = document.getElementById("successMessage");
                const successText = document.getElementById("successText");
                successText.textContent = message;
                successMessage.classList.add("show");

                // 3秒後自動隱藏
                setTimeout(() => {
                    successMessage.classList.remove("show");
                }, 3000);
            }

            // 顯示錯誤訊息
            function showError(message) {
                hideAllMessages();
                const errorMessage = document.getElementById("errorMessage");
                const errorText = document.getElementById("errorText");
                errorText.textContent = message;
                errorMessage.classList.add("show");

                // 5秒後自動隱藏
                setTimeout(() => {
                    errorMessage.classList.remove("show");
                }, 5000);
            }

            // 隱藏所有訊息
            function hideAllMessages() {
                document.getElementById("successMessage").classList.remove("show");
                document.getElementById("errorMessage").classList.remove("show");
            }

            // 鍵盤快捷鍵
            document.addEventListener("keydown", function (e) {
                // Ctrl/Cmd + S 儲存
                if ((e.ctrlKey || e.metaKey) && e.key === "s") {
                    e.preventDefault();
                    saveSettings();
                }

                // ESC 重置表單
                if (e.key === "Escape") {
                    resetForm();
                }
            });

            console.log("🎵 使用者設定頁面初始化完成");
        </script>
    </body>
</html>
