<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>æ–°å¢æ­Œæ›²</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            .disabled-select {
                background-color: #f5f5f5;
                color: #999;
                cursor: not-allowed;
            }

            .required {
                color: red;
            }
        </style>
    </head>
    <body>
        <h2>ğŸµ æ–°å¢æ­Œæ›²</h2>

        <label for="artist_id">è«‹é¸æ“‡æ­Œæ‰‹</label>
        <select id="artist_id" required>
            <option value="">è«‹é¸æ“‡æ­Œæ‰‹</option>
        </select>

        <label for="album_id">è«‹é¸æ“‡å°ˆè¼¯</label>
        <select id="album_id" disabled class="disabled-select">
            <option value="">è«‹å…ˆé¸æ“‡æ­Œæ‰‹</option>
        </select>

        <label for="category">æ­Œæ›²é¡åˆ¥</label>
        <select id="category">
            <option value="">è«‹é¸æ“‡æ­Œæ›²é¡åˆ¥</option>
            <option value="æŠ’æƒ…">æŠ’æƒ…æ­Œ</option>
            <option value="æ–æ»¾">æ–æ»¾æ¨‚</option>
            <option value="æµè¡Œ">æµè¡Œæ­Œ</option>
            <option value="æ°‘è¬ ">æ°‘è¬ </option>
            <option value="å˜»å“ˆ">å˜»å“ˆ</option>
            <option value="é›»å­">é›»å­éŸ³æ¨‚</option>
            <option value="å¤å…¸">å¤å…¸</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
        </select>

        <label for="ytlink">YouTube é€£çµ</label>
        <input type="url" id="ytlink" placeholder="https://www.youtube.com/watch?v=..." />

        <label for="song_name">æ­Œæ›²åç¨± <span class="required">*</span></label>
        <input type="text" id="song_name" placeholder="è«‹è¼¸å…¥æ­Œæ›²åç¨±" required />
        <button>æ–°å¢æ­Œæ›²</button>

        <script>
            console.log("Insert Songs Script é–‹å§‹åŸ·è¡Œ");
            const apiArtists = "http://localhost:8000/api/artists";
            const apiAlbums = "http://localhost:8000/api/albums";
            let allAlbumsData = [];

            async function artistNameAdd() {
                try {
                    console.log("ğŸ”„ é–‹å§‹è¼‰å…¥æ­Œæ‰‹è³‡æ–™...");
                    const response = await fetch(apiArtists);

                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    const artistSelect = document.getElementById("artist_id");

                    if (!artistSelect) {
                        console.error("æ‰¾ä¸åˆ° artist_id å…ƒç´ ");
                        return;
                    }

                    if (!Array.isArray(data) || data.length === 0) {
                        artistSelect.innerHTML = '<option value="">æ²’æœ‰æ­Œæ‰‹è³‡æ–™</option>';
                        return;
                    }

                    artistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ­Œæ‰‹</option>';

                    data.forEach((row) => {
                        let id = row["artist_id"];
                        let name = row["artist_name"];
                        let op = document.createElement("option");
                        op.value = id;
                        op.textContent = name;
                        artistSelect.appendChild(op);
                    });

                    console.log("âœ… æ­Œæ‰‹è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", data.length, "ä½æ­Œæ‰‹");
                } catch (err) {
                    console.error("âŒ è¼‰å…¥æ­Œæ‰‹å¤±æ•—", err);
                    const artistSelect = document.getElementById("artist_id");
                    if (artistSelect) {
                        artistSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                    }
                }
            }

            // è¼‰å…¥æ‰€æœ‰å°ˆè¼¯æ¸…å–®ï¼ˆå„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼‰
            async function albumNameAdd() {
                try {
                    console.log("ğŸ”„ é–‹å§‹è¼‰å…¥å°ˆè¼¯è³‡æ–™...");
                    const response = await fetch(apiAlbums);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    if (!Array.isArray(data)) {
                        console.error("å°ˆè¼¯è³‡æ–™æ ¼å¼éŒ¯èª¤");
                        return;
                    }

                    // å„²å­˜æ‰€æœ‰å°ˆè¼¯è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
                    allAlbumsData = data;

                    console.log("âœ… å°ˆè¼¯è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", data.length, "å¼µå°ˆè¼¯");
                    console.log("ğŸ“‹ å°ˆè¼¯è³‡æ–™:", data);
                } catch (err) {
                    console.error("âŒ è¼‰å…¥å°ˆè¼¯å¤±æ•—", err);
                    allAlbumsData = [];
                }
            }

            // ğŸ¯ é—œéµåŠŸèƒ½ï¼šç•¶æ­Œæ‰‹é¸æ“‡æ”¹è®Šæ™‚è§¸ç™¼
            function onArtistChange() {
                console.log("onArtistChange è¢«è§¸ç™¼");
                console.log("allAlbumsData é•·åº¦:", allAlbumsData.length);

                const artistSelect = document.getElementById("artist_id");
                const albumSelect = document.getElementById("album_id");
                const selectedArtistId = artistSelect.value;
                const selectedArtistName = artistSelect.selectedOptions[0]?.textContent || "æœªçŸ¥æ­Œæ‰‹";

                console.log("ğŸ¤ æ­Œæ‰‹é¸æ“‡æ”¹è®Š:", selectedArtistId, "-", selectedArtistName);

                if (!selectedArtistId) {
                    // æ²’æœ‰é¸æ“‡æ­Œæ‰‹ï¼Œç¦ç”¨å°ˆè¼¯é¸å–®
                    albumSelect.disabled = true;
                    albumSelect.className = "disabled-select";
                    albumSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ­Œæ‰‹</option>';
                    console.log("ğŸ”’ å°ˆè¼¯é¸å–®å·²ç¦ç”¨");
                    return;
                }

                // å•Ÿç”¨å°ˆè¼¯é¸å–®
                albumSelect.disabled = false;
                albumSelect.className = "";

                // ç¯©é¸è©²æ­Œæ‰‹çš„å°ˆè¼¯
                const artistAlbums = allAlbumsData.filter((album) => album.artist_id == selectedArtistId);

                console.log(
                    `ğŸ’¿ æ‰¾åˆ° ${artistAlbums.length} å¼µå°ˆè¼¯å±¬æ–¼æ­Œæ‰‹ã€Œ${selectedArtistName}ã€(ID: ${selectedArtistId})`
                );

                // é‡æ–°å»ºç«‹å°ˆè¼¯é¸å–®
                albumSelect.innerHTML = `<option value="">é¸æ“‡${selectedArtistName}çš„å°ˆè¼¯ï¼ˆå¯ç•™ç©ºï¼‰</option>`;

                if (artistAlbums.length === 0) {
                    // è©²æ­Œæ‰‹æ²’æœ‰å°ˆè¼¯
                    const option = document.createElement("option");
                    option.value = "";
                    option.textContent = `${selectedArtistName} å°šç„¡å°ˆè¼¯è³‡æ–™ï¼Œå°‡åˆ†é¡åˆ°ã€Œæœªåˆ†é¡ã€`;
                    option.disabled = true;
                    option.style.fontStyle = "italic";
                    option.style.color = "#888";
                    albumSelect.appendChild(option);

                    console.log(`ğŸ“ ${selectedArtistName} æ²’æœ‰å°ˆè¼¯ï¼Œæ­Œæ›²å°‡åˆ†é¡åˆ°ã€Œæœªåˆ†é¡ã€`);
                } else {
                    // åŠ å…¥è©²æ­Œæ‰‹çš„å°ˆè¼¯ï¼ŒæŒ‰ç™¼è¡Œæ—¥æœŸæ’åº
                    artistAlbums
                        .sort((a, b) => {
                            const dateA = new Date(a.release_date || "1900-01-01");
                            const dateB = new Date(b.release_date || "1900-01-01");
                            return dateB - dateA; // æ–°å°ˆè¼¯åœ¨å‰
                        })
                        .forEach((album) => {
                            const option = document.createElement("option");
                            option.value = album.album_id;

                            // æ ¼å¼åŒ–ç™¼è¡Œæ—¥æœŸ
                            const releaseYear = album.release_date
                                ? new Date(album.release_date).getFullYear()
                                : "å¹´ä»½æœªçŸ¥";

                            option.textContent = `${album.album_name} (${releaseYear})`;

                            // å¦‚æœæ˜¯æœ€æ–°å°ˆè¼¯ï¼ŒåŠ ä¸Šæ¨™è¨˜
                            if (artistAlbums.indexOf(album) === 0 && artistAlbums.length > 1) {
                                option.textContent += " ğŸ†•";
                                option.style.fontWeight = "bold";
                            }

                            albumSelect.appendChild(option);
                        });

                    console.log(
                        `ğŸ“‹ å·²è¼‰å…¥ ${selectedArtistName} çš„å°ˆè¼¯æ¸…å–®:`,
                        artistAlbums.map((a) => a.album_name).join(", ")
                    );
                }
            }

            // æ–°å¢æ­Œæ›²
            async function insertpost() {
                try {
                    const song_name = document.getElementById("song_name").value.trim();
                    const artist_id = document.getElementById("artist_id").value;
                    const album_id = document.getElementById("album_id").value;
                    const category = document.getElementById("category").value;
                    const ytlink = document.getElementById("ytlink").value.trim();

                    console.log("=== æ¬„ä½å€¼æª¢æŸ¥ ===");
                    console.log("song_name:", `'${song_name}'`);
                    console.log("artist_id:", `'${artist_id}'`);
                    console.log("album_id:", `'${album_id}'`);
                    console.log("category:", `'${category}'`);
                    console.log("ytlink:", `'${ytlink}'`);

                    // æª¢æŸ¥å¿…å¡«æ¬„ä½
                    if (!song_name) {
                        alert("è«‹è¼¸å…¥æ­Œæ›²åç¨±ï¼");
                        document.getElementById("song_name").focus();
                        return;
                    }

                    if (!artist_id || artist_id === "") {
                        alert("è«‹é¸æ“‡æ­Œæ‰‹ï¼");
                        document.getElementById("artist_id").focus();
                        return;
                    }

                    // ğŸ”’ é¡å¤–é©—è­‰ï¼šå¦‚æœæœ‰é¸æ“‡å°ˆè¼¯ï¼Œç¢ºä¿å°ˆè¼¯å±¬æ–¼æ‰€é¸æ­Œæ‰‹
                    if (album_id) {
                        const selectedAlbum = allAlbumsData.find(
                            (album) => album.album_id == album_id && album.artist_id == artist_id
                        );

                        if (!selectedAlbum) {
                            alert("æ‰€é¸å°ˆè¼¯ä¸å±¬æ–¼è©²æ­Œæ‰‹ï¼Œè«‹é‡æ–°é¸æ“‡ï¼");
                            console.error("FK é©—è­‰å¤±æ•—: å°ˆè¼¯ä¸å±¬æ–¼è©²æ­Œæ‰‹");
                            return;
                        }

                        console.log("âœ… FK é©—è­‰é€šé: å°ˆè¼¯å±¬æ–¼è©²æ­Œæ‰‹");
                    }

                    const requestData = {
                        table: "songs",
                        artist_id: artist_id,
                        song_name: song_name,
                        music_category: category || "",
                        youtube_link: ytlink || "",
                    };

                    // å°ˆè¼¯IDæª¢æŸ¥
                    if (album_id && album_id !== "") requestData.album_id = album_id;

                    console.log("ğŸ“¤ æäº¤è³‡æ–™:", requestData);

                    const response = await fetch("http://localhost:8000/api/2/insert", {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (response.ok) {
                        const selectedArtistName = document.getElementById("artist_id").selectedOptions[0].textContent;
                        const selectedAlbumOption = document.getElementById("album_id").selectedOptions[0];
                        const selectedAlbumName =
                            selectedAlbumOption && selectedAlbumOption.value
                                ? selectedAlbumOption.textContent
                                : "æœªåˆ†é¡";

                        // å‰µå»ºæˆåŠŸè¨Šæ¯
                        const successMessage = `âœ… æ­Œæ›²æ–°å¢æˆåŠŸï¼
                            ğŸ¤ æ­Œæ‰‹: ${selectedArtistName}
                            ğŸ’¿ å°ˆè¼¯: ${selectedAlbumName}
                            ğŸµ æ­Œæ›²: ${song_name}
                            ğŸ­ é¡å‹: ${category || "æœªåˆ†é¡"}`;

                        alert(successMessage);

                        // æ¸…ç©ºè¼¸å…¥æ¬„ä½
                        document.getElementById("song_name").value = "";
                        document.getElementById("artist_id").value = "";
                        document.getElementById("category").value = "";
                        document.getElementById("ytlink").value = "";
                        document.getElementById("song_name").focus();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error("éŒ¯èª¤è™•ç†:", error);
                    alert("âŒ æ–°å¢æ­Œæ›²å¤±æ•—: " + error.message);
                    return;
                }
            }

            console.log("åˆå§‹åŒ–é é¢è³‡æ–™");

            // ä¸»è¦è¼‰å…¥
            artistNameAdd();
            albumNameAdd();

            // å‚™ç”¨è¼‰å…¥æ©Ÿåˆ¶
            setTimeout(() => {
                const artistSelect = document.getElementById("artist_id");
                if (artistSelect) {
                    artistSelect.addEventListener("change", onArtistChange);
                    console.log("âœ… äº‹ä»¶ç›£è½å™¨å·²ç¶å®š");
                } else {
                    console.error("âŒ æ‰¾ä¸åˆ° artist_id å…ƒç´ ");
                }
            }, 100);

            const btn = document.querySelector("button");
            if (btn) {
                btn.addEventListener("click", function () {
                    console.log("é»æ“Šæ–°å¢æ­Œæ›²æŒ‰éˆ•");
                    insertpost();
                });
                console.log("âœ… æ–°å¢æ­Œæ›²æŒ‰éˆ•äº‹ä»¶ç¶å®šæˆåŠŸ");
            } else {
                console.error("âŒ æ‰¾ä¸åˆ°æ–°å¢æ­Œæ›²æŒ‰éˆ•");
            }
        </script>
    </body>
</html>
