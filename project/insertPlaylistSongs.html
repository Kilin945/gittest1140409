<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            .disabled-select {
                background-color: #f5f5f5;
                color: #999;
                cursor: not-allowed;
            }

            .required {
                color: red;
            }

            .selection-info {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 8px 12px;
                margin: 8px 0;
                font-size: 13px;
                color: #495057;
            }

            .loading-info {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 4px;
                padding: 8px 12px;
                margin: 8px 0;
                font-size: 13px;
                color: #856404;
            }
        </style>
    </head>
    <body>
        <h2>ğŸµ æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²</h2>

        <div class="loading-info" id="loading-status">â³ æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</div>

        <label for="playlist_id">é¸æ“‡æ’­æ”¾æ¸…å–® <span class="required">*</span></label>
        <select id="playlist_id" required disabled>
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <div class="selection-info" id="playlist-info" style="display: none"></div>

        <label for="song_id">é¸æ“‡æ­Œæ›² <span class="required">*</span></label>
        <select id="song_id" required disabled>
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <div class="selection-info" id="song-info" style="display: none"></div>

        <button disabled>è¼‰å…¥ä¸­...</button>

        <script>
            console.log("ğŸš€ æ–°å¢æ­Œæ›²é é¢åˆå§‹åŒ–");

            // ğŸ”§ ç¢ºä¿ API_BASE åœ¨å…¨åŸŸå¯ç”¨
            window.API_BASE = (() => {
                const currentHostname = window.location.hostname;
                const currentOrigin = window.location.origin;

                if (currentHostname.includes("github.io")) {
                    console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
                    return "https://1140412connectproject-production.up.railway.app/api";
                } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                    console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
                    return "http://localhost:8000/api";
                } else if (currentHostname.includes("railway.app")) {
                    console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
                    return currentOrigin + "/api";
                } else {
                    console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
                    return "https://1140412connectproject-production.up.railway.app/api";
                }
            })();

            console.log("ğŸ“¡ API_BASE:", window.API_BASE);

            // ä½¿ç”¨å‹•æ…‹ API URL
            const apiArtists = `${window.API_BASE}/artists`;
            const apiAlbums = `${window.API_BASE}/albums`;

            // è¼‰å…¥æ­Œæ‰‹æ¸…å–®
            async function artistNameAdd() {
                try {
                    console.log("ğŸ”„ é–‹å§‹è¼‰å…¥æ­Œæ‰‹è³‡æ–™...");
                    const response = await fetch(apiArtists);
                    console.log("APIå›æ‡‰ç‹€æ…‹:", response.status);

                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    const artistSelect = document.getElementById("artist_id");

                    if (!artistSelect) {
                        console.error("æ‰¾ä¸åˆ° artist_id å…ƒç´ ");
                        return;
                    }

                    if (!Array.isArray(data) || data.length === 0) {
                        artistSelect.innerHTML = '<option value="">æ²’æœ‰æ­Œæ‰‹è³‡æ–™</option>';
                        return;
                    }

                    // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™é è¨­é¸é …ï¼‰
                    artistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ­Œæ‰‹</option>';

                    // æŒ‰æ­Œæ‰‹åç¨±æ’åº
                    data.sort((a, b) => a.artist_name.localeCompare(b.artist_name, "zh-Hant"));

                    // æ¯ä¸€åˆ—æ­Œæ‰‹è³‡æ–™
                    data.forEach((row) => {
                        let id = row["artist_id"];
                        let name = row["artist_name"];
                        let option = document.createElement("option");
                        option.value = id;
                        option.textContent = name;
                        artistSelect.appendChild(option);
                    });

                    console.log("âœ… æ­Œæ‰‹è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", data.length, "ä½æ­Œæ‰‹");
                } catch (err) {
                    console.error("âŒ è¼‰å…¥æ­Œæ‰‹å¤±æ•—:", err);
                    const artistSelect = document.getElementById("artist_id");
                    if (artistSelect) {
                        artistSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</option>';
                    }
                }
            }

            // è¼‰å…¥å°ˆè¼¯æ¸…å–®ï¼ˆæ ¹æ“šé¸æ“‡çš„æ­Œæ‰‹ï¼‰
            async function loadAlbumsByArtist(artistId) {
                try {
                    const albumSelect = document.getElementById("album_id");

                    if (!artistId) {
                        albumSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ­Œæ‰‹</option>';
                        albumSelect.disabled = true;
                        albumSelect.classList.add("disabled-select");
                        return;
                    }

                    // å•Ÿç”¨å°ˆè¼¯é¸æ“‡
                    albumSelect.disabled = false;
                    albumSelect.classList.remove("disabled-select");

                    console.log("ğŸ”„ è¼‰å…¥æ­Œæ‰‹å°ˆè¼¯è³‡æ–™...", artistId);
                    const response = await fetch(apiAlbums);

                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    // éæ¿¾è©²æ­Œæ‰‹çš„å°ˆè¼¯
                    const artistAlbums = data.filter((album) => album.artist_id == artistId);

                    // æ¸…ç©ºç¾æœ‰é¸é …
                    albumSelect.innerHTML = '<option value="">è«‹é¸æ“‡å°ˆè¼¯</option>';
                    albumSelect.innerHTML += '<option value="8">æœªåˆ†é¡</option>'; // é è¨­å°ˆè¼¯

                    if (artistAlbums.length > 0) {
                        // æŒ‰å°ˆè¼¯åç¨±æ’åº
                        artistAlbums.sort((a, b) => a.album_name.localeCompare(b.album_name, "zh-Hant"));

                        artistAlbums.forEach((album) => {
                            let option = document.createElement("option");
                            option.value = album.album_id;
                            option.textContent = album.album_name;
                            albumSelect.appendChild(option);
                        });
                    }

                    console.log("âœ… å°ˆè¼¯è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", artistAlbums.length, "å¼µå°ˆè¼¯");
                } catch (err) {
                    console.error("âŒ è¼‰å…¥å°ˆè¼¯å¤±æ•—:", err);
                    const albumSelect = document.getElementById("album_id");
                    albumSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                }
            }

            // åŸ·è¡Œç‹€æ…‹æª¢æŸ¥
            let isSubmitting = false;

            // æ–°å¢æ­Œæ›²å‡½æ•¸
            window.insertpost = async function () {
                if (isSubmitting) {
                    console.log("âš ï¸ æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹å‹¿é‡è¤‡æäº¤");
                    return;
                }

                isSubmitting = true;

                try {
                    // å–å¾—æ‰€æœ‰æ¬„ä½çš„å€¼ä¸¦é€²è¡Œæ¸…ç†
                    const song_name = document.getElementById("song_name").value.trim();
                    const artist_id = document.getElementById("artist_id").value;
                    const album_id = document.getElementById("album_id").value;
                    const music_category = document.getElementById("category").value; // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ ID
                    const youtube_link = document.getElementById("ytlink").value.trim(); // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ ID

                    console.log("=== æ¬„ä½å€¼æª¢æŸ¥ ===");
                    console.log("song_name:", `'${song_name}'`);
                    console.log("artist_id:", `'${artist_id}'`);
                    console.log("album_id:", `'${album_id}'`);
                    console.log("music_category:", `'${music_category}'`);
                    console.log("youtube_link:", `'${youtube_link}'`);

                    // æª¢æŸ¥å¿…å¡«æ¬„ä½
                    if (!song_name) {
                        alert("è«‹è¼¸å…¥æ­Œæ›²åç¨±ï¼");
                        document.getElementById("song_name").focus();
                        return;
                    }

                    if (!artist_id || artist_id === "") {
                        alert("è«‹é¸æ“‡æ­Œæ‰‹ï¼");
                        document.getElementById("artist_id").focus();
                        return;
                    }

                    const requestData = {
                        table: "songs",
                        song_name: song_name,
                        artist_id: artist_id,
                        music_category: music_category || "",
                        youtube_link: youtube_link || "",
                    };

                    // åªæœ‰é¸æ“‡å°ˆè¼¯æ™‚æ‰åŠ å…¥
                    if (album_id && album_id !== "") {
                        requestData.album_id = album_id;
                    }

                    console.log("ğŸ“¤ æäº¤è³‡æ–™:", requestData);
                    console.log("ä½¿ç”¨ API ç«¯é»:", `${window.API_BASE}/2/insert`);

                    const response = await fetch(`${window.API_BASE}/2/insert`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    console.log("ğŸ“¡ ä¼ºæœå™¨å›æ‡‰ç‹€æ…‹:", response.status);

                    if (response.ok) {
                        // å–å¾—é¸ä¸­çš„æ­Œæ‰‹åç¨±
                        const selectedArtistName = document.getElementById("artist_id").selectedOptions[0].textContent;

                        // å–å¾—é¸ä¸­çš„å°ˆè¼¯åç¨±
                        const albumSelect = document.getElementById("album_id");
                        const selectedAlbumName = albumSelect.selectedOptions[0]
                            ? albumSelect.selectedOptions[0].textContent
                            : "æœªåˆ†é¡";

                        // å‰µå»ºæˆåŠŸè¨Šæ¯
                        const successMessage = `âœ… æ­Œæ›²æ–°å¢æˆåŠŸï¼
ğŸ¤ æ­Œæ‰‹: ${selectedArtistName}
ğŸµ æ­Œæ›²åç¨±: ${song_name}
ğŸ’¿ å°ˆè¼¯: ${selectedAlbumName}
ğŸ¶ éŸ³æ¨‚é¡å‹: ${music_category || "æœªå¡«å¯«"}
ğŸ”— YouTubeé€£çµ: ${youtube_link || "æœªå¡«å¯«"}`;

                        alert(successMessage);
                        console.log("âœ… æ­Œæ›²æ–°å¢æˆåŠŸ");

                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById("song_name").value = "";
                        document.getElementById("artist_id").value = "";
                        const albumSelectElement = document.getElementById("album_id");
                        albumSelectElement.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ­Œæ‰‹</option>';
                        albumSelectElement.disabled = true;
                        albumSelectElement.classList.add("disabled-select");
                        document.getElementById("category").value = "";
                        document.getElementById("ytlink").value = "";
                        document.getElementById("artist_id").focus();
                    } else {
                        const errorText = await response.text();
                        console.error("âŒ æ–°å¢å¤±æ•—:", response.status, errorText);
                        alert(`âŒ æ–°å¢æ­Œæ›²å¤±æ•—: ${errorText}`);
                    }
                } catch (error) {
                    console.error("âŒ æ–°å¢æ­Œæ›²å¤±æ•—:", error);
                    alert(`âŒ æ–°å¢æ­Œæ›²å¤±æ•—: ${error.message}`);
                } finally {
                    isSubmitting = false; // ç¢ºä¿ç‹€æ…‹é‡ç½®
                }
            };

            // äº‹ä»¶ç¶å®šç­–ç•¥
            function bindSubmitEvent() {
                const submitBtn = document.querySelector("button");
                if (submitBtn) {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç¶å®šé
                    if (submitBtn.hasAttribute("data-bound")) {
                        console.log("âš ï¸ æŒ‰éˆ•å·²ç¶“ç¶å®šéäº‹ä»¶ï¼Œè·³é");
                        return true;
                    }

                    // ç¶å®šäº‹ä»¶
                    submitBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        console.log("ğŸ”¥ æ–°å¢æ­Œæ›²æŒ‰éˆ•è¢«é»æ“Š");
                        window.insertpost();
                    });

                    // æ¨™è¨˜å·²ç¶å®šï¼Œé˜²æ­¢é‡è¤‡
                    submitBtn.setAttribute("data-bound", "true");
                    console.log("âœ… æ–°å¢æ­Œæ›²æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š");
                    return true;
                } else {
                    console.warn("âš ï¸ æœªæ‰¾åˆ°æ–°å¢æ­Œæ›²æŒ‰éˆ•");
                    return false;
                }
            }

            // ç¶å®šæ­Œæ‰‹é¸æ“‡è®Šæ›´äº‹ä»¶
            function bindArtistChangeEvent() {
                const artistSelect = document.getElementById("artist_id");
                if (artistSelect && !artistSelect.hasAttribute("data-change-bound")) {
                    artistSelect.addEventListener("change", function () {
                        const selectedArtistId = this.value;
                        loadAlbumsByArtist(selectedArtistId);
                    });
                    artistSelect.setAttribute("data-change-bound", "true");
                    console.log("âœ… æ­Œæ‰‹é¸æ“‡è®Šæ›´äº‹ä»¶å·²ç¶å®š");
                }
            }

            // å¤šç¨®è¼‰å…¥æ™‚æ©Ÿç¶å®šäº‹ä»¶
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", function () {
                    bindSubmitEvent();
                    bindArtistChangeEvent();
                    artistNameAdd();
                });
            } else {
                bindSubmitEvent();
                bindArtistChangeEvent();
                artistNameAdd();
            }

            // Enter éµæäº¤ï¼ˆåŠ ä¸Šé˜²é‡è¤‡æ©Ÿåˆ¶ï¼‰
            let enterKeyBound = false;
            if (!enterKeyBound) {
                document.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        window.insertpost();
                    }
                });
                enterKeyBound = true;
            }

            console.log("âœ… æ–°å¢æ­Œæ›²é é¢åˆå§‹åŒ–å®Œæˆ");
        </script>
    </body>
</html>
