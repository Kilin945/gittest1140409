<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            .disabled-select {
                background-color: #f5f5f5;
                color: #999;
                cursor: not-allowed;
            }

            .required {
                color: red;
            }

            .selection-info {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 8px 12px;
                margin: 8px 0;
                font-size: 13px;
                color: #495057;
            }

            .loading-info {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 4px;
                padding: 8px 12px;
                margin: 8px 0;
                font-size: 13px;
                color: #856404;
            }
        </style>
    </head>
    <body>
        <h2>ğŸµ æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²</h2>

        <div class="loading-info" id="loading-status">â³ æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</div>

        <label for="playlist_id">é¸æ“‡æ’­æ”¾æ¸…å–® <span class="required">*</span></label>
        <select id="playlist_id" required disabled>
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <div class="selection-info" id="playlist-info" style="display: none"></div>

        <label for="song_id">é¸æ“‡æ­Œæ›² <span class="required">*</span></label>
        <select id="song_id" required disabled>
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <div class="selection-info" id="song-info" style="display: none"></div>

        <button disabled>è¼‰å…¥ä¸­...</button>

        <script>
            console.log("Insert Playlist Songs Script é–‹å§‹åŸ·è¡Œ");

            // ğŸ”§ å‹•æ…‹è¨­å®š API Base URL - ä¿®æ­£ç¡¬ç·¨ç¢¼å•é¡Œ
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                // GitHub Pages ç’°å¢ƒ
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                // æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (currentHostname.includes("railway.app")) {
                // ç›´æ¥è¨ªå• Railway æ‡‰ç”¨
                API_BASE = currentOrigin + "/api";
                console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
            } else {
                // å…¶ä»–ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
            }
            console.log("ğŸ“¡ Insert Playlist Songs API_BASE:", API_BASE);

            // ä½¿ç”¨å‹•æ…‹ API URL
            const apiPlaylists = `${API_BASE}/playlists`;
            const apiSongs = `${API_BASE}/songs`;
            const apiArtists = `${API_BASE}/artists`;

            let allSongsData = [];
            let allArtistsData = [];

            // è¼‰å…¥æ’­æ”¾æ¸…å–®è³‡æ–™
            async function loadPlaylists() {
                try {
                    console.log("ğŸ”„ é–‹å§‹è¼‰å…¥æ’­æ”¾æ¸…å–®è³‡æ–™...");
                    const response = await fetch(apiPlaylists);

                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    const playlistSelect = document.getElementById("playlist_id");

                    if (!playlistSelect) {
                        console.error("æ‰¾ä¸åˆ° playlist_id å…ƒç´ ");
                        return;
                    }

                    if (!Array.isArray(data) || data.length === 0) {
                        playlistSelect.innerHTML = '<option value="">æ²’æœ‰æ’­æ”¾æ¸…å–®è³‡æ–™</option>';
                        return;
                    }

                    playlistSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ’­æ”¾æ¸…å–®</option>';

                    // æŒ‰æ’­æ”¾æ¸…å–®åç¨±æ’åº
                    data.sort((a, b) => a.playlist_name.localeCompare(b.playlist_name, "zh-Hant"));

                    data.forEach((playlist) => {
                        const option = document.createElement("option");
                        option.value = playlist.playlist_id;
                        const privacyIcon = playlist.is_public ? "ğŸŒ" : "ğŸ”’";
                        option.textContent = `${privacyIcon} ${playlist.playlist_name}`;
                        playlistSelect.appendChild(option);
                    });

                    // å•Ÿç”¨é¸å–®
                    playlistSelect.disabled = false;
                    console.log("âœ… æ’­æ”¾æ¸…å–®è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", data.length, "å€‹æ’­æ”¾æ¸…å–®");
                } catch (err) {
                    console.error("âŒ è¼‰å…¥æ’­æ”¾æ¸…å–®å¤±æ•—", err);
                    const playlistSelect = document.getElementById("playlist_id");
                    if (playlistSelect) {
                        playlistSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</option>';
                    }
                }
            }

            // è¼‰å…¥æ­Œæ‰‹è³‡æ–™
            async function loadArtists() {
                try {
                    console.log("ğŸ”„ é–‹å§‹è¼‰å…¥æ­Œæ‰‹è³‡æ–™...");
                    const response = await fetch(apiArtists);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    if (!Array.isArray(data)) {
                        console.error("æ­Œæ‰‹è³‡æ–™æ ¼å¼éŒ¯èª¤");
                        return;
                    }

                    allArtistsData = data;
                    console.log("âœ… æ­Œæ‰‹è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", data.length, "ä½æ­Œæ‰‹");
                } catch (err) {
                    console.error("âŒ è¼‰å…¥æ­Œæ‰‹å¤±æ•—", err);
                    allArtistsData = [];
                }
            }

            // è¼‰å…¥æ­Œæ›²è³‡æ–™
            async function loadSongs() {
                try {
                    console.log("ğŸ”„ é–‹å§‹è¼‰å…¥æ­Œæ›²è³‡æ–™...");
                    const response = await fetch(apiSongs);
                    if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                    const data = await response.json();

                    if (!Array.isArray(data)) {
                        console.error("æ­Œæ›²è³‡æ–™æ ¼å¼éŒ¯èª¤");
                        return;
                    }

                    allSongsData = data;

                    const songSelect = document.getElementById("song_id");
                    songSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ­Œæ›²</option>';

                    // æŒ‰æ­Œæ‰‹åˆ†çµ„é¡¯ç¤ºæ­Œæ›²
                    const songsByArtist = {};
                    data.forEach((song) => {
                        const artistId = song.artist_id;
                        if (!songsByArtist[artistId]) {
                            songsByArtist[artistId] = [];
                        }
                        songsByArtist[artistId].push(song);
                    });

                    // æŒ‰æ­Œæ‰‹åç¨±æ’åº
                    const sortedArtistIds = Object.keys(songsByArtist).sort((a, b) => {
                        const artistA = allArtistsData.find((artist) => artist.artist_id == a);
                        const artistB = allArtistsData.find((artist) => artist.artist_id == b);
                        const nameA = artistA ? artistA.artist_name : `æ­Œæ‰‹ID:${a}`;
                        const nameB = artistB ? artistB.artist_name : `æ­Œæ‰‹ID:${b}`;
                        return nameA.localeCompare(nameB, "zh-Hant");
                    });

                    // ç‚ºæ¯å€‹æ­Œæ‰‹å»ºç«‹optgroup
                    sortedArtistIds.forEach((artistId) => {
                        const artist = allArtistsData.find((a) => a.artist_id == artistId);
                        const artistName = artist ? artist.artist_name : `æ­Œæ‰‹ID:${artistId}`;

                        const optgroup = document.createElement("optgroup");
                        optgroup.label = `ğŸ¤ ${artistName} (${songsByArtist[artistId].length}é¦–)`;

                        // æŒ‰æ­Œæ›²åç¨±æ’åº
                        songsByArtist[artistId]
                            .sort((a, b) => a.song_name.localeCompare(b.song_name, "zh-Hant"))
                            .forEach((song) => {
                                const option = document.createElement("option");
                                option.value = song.song_id;
                                option.textContent = song.song_name;
                                optgroup.appendChild(option);
                            });

                        songSelect.appendChild(optgroup);
                    });

                    // å•Ÿç”¨é¸å–®
                    songSelect.disabled = false;
                    console.log("âœ… æ­Œæ›²è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œå…±", data.length, "é¦–æ­Œæ›²");
                } catch (err) {
                    console.error("âŒ è¼‰å…¥æ­Œæ›²å¤±æ•—", err);
                    const songSelect = document.getElementById("song_id");
                    if (songSelect) {
                        songSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</option>';
                    }
                }
            }

            // æ’­æ”¾æ¸…å–®é¸æ“‡æ”¹è®Šæ™‚çš„è™•ç†
            function onPlaylistChange() {
                const playlistSelect = document.getElementById("playlist_id");
                const playlistInfo = document.getElementById("playlist-info");
                const selectedValue = playlistSelect.value;

                if (selectedValue) {
                    const selectedText = playlistSelect.selectedOptions[0].textContent;
                    playlistInfo.textContent = `âœ… å·²é¸æ“‡æ’­æ”¾æ¸…å–®: ${selectedText}`;
                    playlistInfo.style.display = "block";
                } else {
                    playlistInfo.style.display = "none";
                }
            }

            // æ­Œæ›²é¸æ“‡æ”¹è®Šæ™‚çš„è™•ç†
            function onSongChange() {
                const songSelect = document.getElementById("song_id");
                const songInfo = document.getElementById("song-info");
                const selectedValue = songSelect.value;

                if (selectedValue) {
                    const song = allSongsData.find((s) => s.song_id == selectedValue);
                    const artist = allArtistsData.find((a) => a.artist_id == song.artist_id);

                    const songName = song ? song.song_name : "æœªçŸ¥æ­Œæ›²";
                    const artistName = artist ? artist.artist_name : "æœªçŸ¥æ­Œæ‰‹";

                    songInfo.textContent = `âœ… å·²é¸æ“‡æ­Œæ›²: ğŸµ ${songName} - ğŸ¤ ${artistName}`;
                    songInfo.style.display = "block";
                } else {
                    songInfo.style.display = "none";
                }
            }

            // æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²
            async function insertPlaylistSong() {
                try {
                    const playlist_id = document.getElementById("playlist_id").value;
                    const song_id = document.getElementById("song_id").value;

                    console.log("=== æ¬„ä½å€¼æª¢æŸ¥ ===");
                    console.log("playlist_id:", `'${playlist_id}'`);
                    console.log("song_id:", `'${song_id}'`);

                    // æª¢æŸ¥å¿…å¡«æ¬„ä½
                    if (!playlist_id || playlist_id === "") {
                        alert("è«‹é¸æ“‡æ’­æ”¾æ¸…å–®ï¼");
                        document.getElementById("playlist_id").focus();
                        return;
                    }

                    if (!song_id || song_id === "") {
                        alert("è«‹é¸æ“‡æ­Œæ›²ï¼");
                        document.getElementById("song_id").focus();
                        return;
                    }

                    const requestData = {
                        table: "playlist_songs",
                        playlist_id: playlist_id,
                        song_id: song_id,
                        // state æœƒåœ¨å¾Œç«¯è‡ªå‹•è¨­å®šç‚º 0
                    };

                    console.log("ğŸ“¤ æäº¤è³‡æ–™:", requestData);
                    console.log("ä½¿ç”¨ API ç«¯é»:", `${API_BASE}/2/insert`);

                    const response = await fetch(`${API_BASE}/2/insert`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (response.ok) {
                        const selectedPlaylistName =
                            document.getElementById("playlist_id").selectedOptions[0].textContent;
                        const song = allSongsData.find((s) => s.song_id == song_id);
                        const artist = allArtistsData.find((a) => a.artist_id == song.artist_id);

                        const songName = song ? song.song_name : "æœªçŸ¥æ­Œæ›²";
                        const artistName = artist ? artist.artist_name : "æœªçŸ¥æ­Œæ‰‹";

                        // å‰µå»ºæˆåŠŸè¨Šæ¯
                        const successMessage = `âœ… æ­Œæ›²æ–°å¢åˆ°æ’­æ”¾æ¸…å–®æˆåŠŸï¼
ğŸ“‹ æ’­æ”¾æ¸…å–®: ${selectedPlaylistName}
ğŸµ æ­Œæ›²: ${songName}
ğŸ¤ æ­Œæ‰‹: ${artistName}
ğŸ“Š æ’­æ”¾ç‹€æ…‹: æœªæ’­æ”¾`;

                        alert(successMessage);
                        console.log("âœ… æ’­æ”¾æ¸…å–®æ­Œæ›²æ–°å¢æˆåŠŸ");

                        // æ¸…ç©ºé¸æ“‡
                        document.getElementById("playlist_id").value = "";
                        document.getElementById("song_id").value = "";

                        // éš±è—è³‡è¨Šæ¡†
                        document.getElementById("playlist-info").style.display = "none";
                        document.getElementById("song-info").style.display = "none";

                        document.getElementById("playlist_id").focus();
                    } else {
                        const errorText = await response.text();
                        console.error("âŒ æ–°å¢å¤±æ•—:", response.status, errorText);
                        alert(`âŒ æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²å¤±æ•—: ${errorText}`);
                    }
                } catch (error) {
                    console.error("âŒ æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²å¤±æ•—:", error);
                    alert(`âŒ æ–°å¢æ’­æ”¾æ¸…å–®æ­Œæ›²å¤±æ•—: ${error.message}`);
                }
            }

            // åˆå§‹åŒ–
            console.log("åˆå§‹åŒ–é é¢è³‡æ–™");

            // è¼‰å…¥è³‡æ–™
            async function initializeData() {
                try {
                    const loadingStatus = document.getElementById("loading-status");

                    loadingStatus.textContent = "â³ æ­£åœ¨è¼‰å…¥æ­Œæ‰‹è³‡æ–™...";
                    await loadArtists();

                    loadingStatus.textContent = "â³ æ­£åœ¨è¼‰å…¥æ’­æ”¾æ¸…å–®è³‡æ–™...";
                    await loadPlaylists();

                    loadingStatus.textContent = "â³ æ­£åœ¨è¼‰å…¥æ­Œæ›²è³‡æ–™...";
                    await loadSongs();

                    // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œå•Ÿç”¨æŒ‰éˆ•
                    loadingStatus.style.display = "none";
                    const btn = document.querySelector("button");
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = "æ–°å¢åˆ°æ’­æ”¾æ¸…å–®";
                    }

                    console.log("âœ… æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆ");
                } catch (error) {
                    console.error("âŒ åˆå§‹åŒ–å¤±æ•—:", error);
                    const loadingStatus = document.getElementById("loading-status");
                    loadingStatus.textContent = "âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢";
                    loadingStatus.style.background = "#f8d7da";
                    loadingStatus.style.borderColor = "#f5c6cb";
                    loadingStatus.style.color = "#721c24";
                }
            }

            initializeData();

            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            setTimeout(() => {
                const playlistSelect = document.getElementById("playlist_id");
                const songSelect = document.getElementById("song_id");
                const btn = document.querySelector("button");

                if (playlistSelect) {
                    playlistSelect.addEventListener("change", onPlaylistChange);
                    console.log("âœ… æ’­æ”¾æ¸…å–®é¸æ“‡äº‹ä»¶ç›£è½å™¨å·²ç¶å®š");
                }

                if (songSelect) {
                    songSelect.addEventListener("change", onSongChange);
                    console.log("âœ… æ­Œæ›²é¸æ“‡äº‹ä»¶ç›£è½å™¨å·²ç¶å®š");
                }

                if (btn) {
                    btn.addEventListener("click", function () {
                        console.log("é»æ“Šæ–°å¢åˆ°æ’­æ”¾æ¸…å–®æŒ‰éˆ•");
                        insertPlaylistSong();
                    });
                    console.log("âœ… æ–°å¢æŒ‰éˆ•äº‹ä»¶ç¶å®šæˆåŠŸ");
                } else {
                    console.error("âŒ æ‰¾ä¸åˆ°æ–°å¢æŒ‰éˆ•");
                }
            }, 100);

            console.log("Insert Playlist Songs Script åŸ·è¡Œå®Œç•¢");
        </script>
    </body>
</html>
