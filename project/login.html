<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ğŸµ Kilin éŸ³æ¨‚ç³»çµ± - ç™»å…¥</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
            /* Claude é¢¨æ ¼å®Œæ•´é‡ç½® */
            *,
            *::before,
            *::after {
                box-sizing: border-box !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Claude é¢¨æ ¼è‰²å½©è®Šæ•¸ */
            :root {
                --claude-bg: #0a0f0d !important;
                --claude-bg-secondary: #0f1512 !important;
                --claude-primary: #d97742 !important;
                --claude-primary-hover: #c56a3a !important;
                --claude-accent: #e08856 !important;
                --claude-text: #ffffff !important;
                --claude-text-secondary: #e5e7eb !important;
                --claude-text-muted: #9ca3af !important;
                --claude-card: rgba(217, 119, 66, 0.08) !important;
                --claude-card-hover: rgba(217, 119, 66, 0.12) !important;
                --claude-border: rgba(217, 119, 66, 0.3) !important;
                --claude-shadow: 0 4px 20px rgba(217, 119, 66, 0.15) !important;
                --claude-shadow-strong: 0 8px 32px rgba(217, 119, 66, 0.25) !important;
                --claude-danger-red: #ef4444 !important;
                --claude-success-green: #22c55e !important;
                --border-radius: 16px !important;
                --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            /* å¼·åˆ¶è¦†è“‹ body æ¨£å¼ */
            html,
            body {
                height: 100% !important;
                background: var(--claude-bg) !important;
                background-image: radial-gradient(circle at 20% 20%, rgba(217, 119, 66, 0.08) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(224, 136, 86, 0.06) 0%, transparent 50%),
                    linear-gradient(135deg, var(--claude-bg) 0%, var(--claude-bg-secondary) 100%) !important;
                background-attachment: fixed !important;
                color: var(--claude-text) !important;
                font-family: "Inter", "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif !important;
                overflow: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* ä¸»å®¹å™¨ */
            .login-container {
                height: 100vh !important;
                width: 100% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                position: relative !important;
                background: transparent !important;
                padding: 20px !important;
            }

            /* èƒŒæ™¯å‹•ç•« */
            .login-container::before {
                content: "" !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: radial-gradient(circle at 15% 25%, rgba(217, 119, 66, 0.1) 0%, transparent 60%),
                    radial-gradient(circle at 85% 75%, rgba(224, 136, 86, 0.08) 0%, transparent 60%) !important;
                z-index: 0 !important;
                animation: backgroundPulse 8s ease-in-out infinite !important;
            }

            @keyframes backgroundPulse {
                0%,
                100% {
                    opacity: 0.3;
                }
                50% {
                    opacity: 0.6;
                }
            }

            /* ç™»å…¥å¡ç‰‡ */
            .login-card {
                background: var(--claude-card) !important;
                backdrop-filter: blur(20px) !important;
                border: 1px solid var(--claude-border) !important;
                border-radius: var(--border-radius) !important;
                padding: 50px 40px !important;
                box-shadow: var(--claude-shadow-strong) !important;
                position: relative !important;
                z-index: 1 !important;
                width: 100% !important;
                max-width: 450px !important;
                overflow: hidden !important;
                animation: cardSlideIn 0.8s ease-out !important;
            }

            .login-card::before {
                content: "" !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: linear-gradient(
                    45deg,
                    transparent 0%,
                    rgba(217, 119, 66, 0.03) 50%,
                    transparent 100%
                ) !important;
                z-index: 0 !important;
            }

            .login-content {
                position: relative !important;
                z-index: 1 !important;
            }

            @keyframes cardSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(50px) scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            /* ç™»å…¥æ¨™é¡Œ */
            .login-header {
                text-align: center !important;
                margin: 0 0 40px 0 !important;
            }

            .login-title {
                font-size: 2.2rem !important;
                font-weight: 700 !important;
                color: var(--claude-text) !important;
                margin: 0 0 10px 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 15px !important;
                font-family: inherit !important;
            }

            .login-title i {
                color: var(--claude-primary) !important;
                font-size: 2.5rem !important;
                animation: iconBounce 2s ease-in-out infinite !important;
            }

            @keyframes iconBounce {
                0%,
                100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-8px);
                }
            }

            .login-subtitle {
                font-size: 1.1rem !important;
                color: var(--claude-text-muted) !important;
                margin: 0 !important;
                font-family: inherit !important;
            }

            /* è¡¨å–®æ¨£å¼ */
            .login-form {
                display: flex !important;
                flex-direction: column !important;
                gap: 25px !important;
            }

            .form-group {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }

            .form-label {
                font-size: 1rem !important;
                font-weight: 600 !important;
                color: var(--claude-text-secondary) !important;
                margin: 0 !important;
                font-family: inherit !important;
            }

            .form-input {
                width: 100% !important;
                padding: 16px 20px !important;
                border: 2px solid var(--claude-border) !important;
                border-radius: var(--border-radius) !important;
                background: var(--claude-bg-secondary) !important;
                color: var(--claude-text) !important;
                font-size: 1rem !important;
                transition: var(--transition) !important;
                font-family: inherit !important;
                outline: none !important;
            }

            .form-input::placeholder {
                color: var(--claude-text-muted) !important;
            }

            .form-input:focus {
                border-color: var(--claude-primary) !important;
                box-shadow: 0 0 0 4px rgba(217, 119, 66, 0.2) !important;
                background: var(--claude-bg) !important;
            }

            /* å¯†ç¢¼è¼¸å…¥æ¡†ç‰¹æ®Šæ¨£å¼ */
            .password-input {
                position: relative !important;
            }

            .password-toggle {
                position: absolute !important;
                right: 15px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                background: none !important;
                border: none !important;
                color: var(--claude-text-muted) !important;
                cursor: pointer !important;
                font-size: 1.1rem !important;
                transition: var(--transition) !important;
                padding: 5px !important;
            }

            .password-toggle:hover {
                color: var(--claude-primary) !important;
            }

            /* ç™»å…¥æŒ‰éˆ• */
            .login-btn {
                width: 100% !important;
                padding: 18px 25px !important;
                background: linear-gradient(135deg, var(--claude-primary), var(--claude-accent)) !important;
                color: white !important;
                border: none !important;
                border-radius: var(--border-radius) !important;
                font-size: 1.1rem !important;
                font-weight: 600 !important;
                cursor: pointer !important;
                transition: var(--transition) !important;
                box-shadow: var(--claude-shadow) !important;
                position: relative !important;
                overflow: hidden !important;
                font-family: inherit !important;
                outline: none !important;
                margin: 10px 0 0 0 !important;
            }

            .login-btn::before {
                content: "" !important;
                position: absolute !important;
                top: 0 !important;
                left: -100% !important;
                width: 100% !important;
                height: 100% !important;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent) !important;
                transition: left 0.6s !important;
            }

            .login-btn:hover {
                background: linear-gradient(135deg, var(--claude-primary-hover), var(--claude-primary)) !important;
                transform: translateY(-2px) !important;
                box-shadow: var(--claude-shadow-strong) !important;
            }

            .login-btn:hover::before {
                left: 100% !important;
            }

            .login-btn:active {
                transform: translateY(0) !important;
            }

            .login-btn:disabled {
                background: #666 !important;
                cursor: not-allowed !important;
                transform: none !important;
            }

            /* éŒ¯èª¤è¨Šæ¯ */
            .error-message {
                background: rgba(239, 68, 68, 0.1) !important;
                border: 1px solid rgba(239, 68, 68, 0.3) !important;
                color: #fca5a5 !important;
                padding: 15px 20px !important;
                border-radius: var(--border-radius) !important;
                font-size: 0.95rem !important;
                font-weight: 500 !important;
                margin: 15px 0 0 0 !important;
                display: none !important;
                align-items: center !important;
                gap: 10px !important;
                backdrop-filter: blur(10px) !important;
                animation: errorSlideIn 0.3s ease-out !important;
                font-family: inherit !important;
            }

            .error-message.show {
                display: flex !important;
            }

            @keyframes errorSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .error-message i {
                font-size: 1.1rem !important;
                color: var(--claude-danger-red) !important;
            }

            /* è¼‰å…¥ç‹€æ…‹ */
            .loading {
                display: none !important;
                align-items: center !important;
                gap: 10px !important;
                color: var(--claude-text-muted) !important;
                font-size: 0.95rem !important;
                margin: 10px 0 0 0 !important;
                font-family: inherit !important;
            }

            .loading.show {
                display: flex !important;
            }

            .loading i {
                animation: spin 1s linear infinite !important;
                color: var(--claude-primary) !important;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }

            /* è¿”å›é¦–é é€£çµ */
            .back-link {
                text-align: center !important;
                margin: 30px 0 0 0 !important;
            }

            .back-link a {
                color: var(--claude-text-muted) !important;
                text-decoration: none !important;
                font-size: 0.95rem !important;
                transition: var(--transition) !important;
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                font-family: inherit !important;
            }

            .back-link a:hover {
                color: var(--claude-primary) !important;
                transform: translateX(-5px) !important;
            }

            /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
            @media (max-width: 768px) {
                .login-container {
                    padding: 15px !important;
                }

                .login-card {
                    padding: 40px 30px !important;
                    max-width: 100% !important;
                }

                .login-title {
                    font-size: 2rem !important;
                    flex-direction: column !important;
                    gap: 10px !important;
                }

                .login-title i {
                    font-size: 2.2rem !important;
                }

                .form-input {
                    padding: 14px 18px !important;
                    font-size: 0.95rem !important;
                }

                .login-btn {
                    padding: 16px 22px !important;
                    font-size: 1rem !important;
                }
            }

            @media (max-width: 480px) {
                .login-card {
                    padding: 35px 25px !important;
                }

                .login-title {
                    font-size: 1.8rem !important;
                }

                .form-input {
                    padding: 12px 16px !important;
                }
            }

            /* æ–°å¢çš„ CSS æ¨£å¼ */
            .guest-section {
                margin: 20px 0 0 0 !important;
            }

            .divider {
                text-align: center !important;
                margin: 20px 0 !important;
                position: relative !important;
            }

            .divider::before {
                content: "" !important;
                position: absolute !important;
                top: 50% !important;
                left: 0 !important;
                right: 0 !important;
                height: 1px !important;
                background: var(--claude-border) !important;
            }

            .divider span {
                background: var(--claude-bg) !important;
                padding: 0 15px !important;
                color: var(--claude-text-muted) !important;
                font-size: 0.9rem !important;
                position: relative !important;
            }

            .guest-btn {
                width: 100% !important;
                padding: 16px 25px !important;
                background: linear-gradient(135deg, #6c757d, #495057) !important;
                color: white !important;
                border: none !important;
                border-radius: var(--border-radius) !important;
                font-size: 1rem !important;
                font-weight: 600 !important;
                cursor: pointer !important;
                transition: var(--transition) !important;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3) !important;
                font-family: inherit !important;
                outline: none !important;
            }

            .guest-btn:hover {
                background: linear-gradient(135deg, #5a6268, #495057) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4) !important;
            }

            .guest-btn:active {
                transform: translateY(0) !important;
            }
        </style>
    </head>

    <body>
        <div class="login-container">
            <div class="login-card">
                <div class="login-content">
                    <div class="login-header">
                        <h1 class="login-title">
                            <i class="fas fa-music"></i>
                            Kilin éŸ³æ¨‚ç³»çµ±
                        </h1>
                        <p class="login-subtitle">è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿå¯†ç¢¼ä»¥é€²å…¥éŸ³æ¨‚ä¸–ç•Œ</p>
                    </div>

                    <form class="login-form" id="loginForm">
                        <div class="form-group">
                            <label class="form-label" for="username"> <i class="fas fa-user"></i> ä½¿ç”¨è€…åç¨± </label>
                            <input
                                type="text"
                                id="username"
                                name="username"
                                class="form-input"
                                placeholder="è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±"
                                required
                                autocomplete="username"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="password"> <i class="fas fa-lock"></i> å¯†ç¢¼ </label>
                            <div class="password-input">
                                <input
                                    type="password"
                                    id="password"
                                    name="password"
                                    class="form-input"
                                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                                    required
                                    autocomplete="current-password"
                                />
                                <button type="button" class="password-toggle" onclick="togglePassword()">
                                    <i class="fas fa-eye" id="passwordIcon"></i>
                                </button>
                            </div>
                        </div>

                        <!-- åœ¨ç™»å…¥æŒ‰éˆ•å¾Œé¢æ–°å¢é€™æ®µ HTML -->
                        <div class="guest-section">
                            <div class="divider">
                                <span>æˆ–</span>
                            </div>
                            <button type="button" class="guest-btn" id="guestBtn" onclick="handleGuestLogin()">
                                <i class="fas fa-user-secret"></i>
                                ä»¥éŠå®¢èº«åˆ†ç€è¦½
                            </button>
                        </div>

                        <button type="submit" class="login-btn" id="loginBtn">
                            <i class="fas fa-sign-in-alt"></i>
                            é€²å…¥éŸ³æ¨‚ç³»çµ±
                        </button>

                        <div class="loading" id="loadingMessage">
                            <i class="fas fa-spinner"></i>
                            æ­£åœ¨é©—è­‰ç™»å…¥è³‡è¨Š...
                        </div>

                        <div class="error-message" id="errorMessage">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="errorText">éŒ¯èª¤è¨Šæ¯</span>
                        </div>
                    </form>

                    <div class="back-link">
                        <a href="index.html">
                            <i class="fas fa-arrow-left"></i>
                            è¿”å›å€‹äººé¦–é 
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <script>
            console.log("ğŸµ Kilin éŸ³æ¨‚ç³»çµ±ç™»å…¥é é¢è¼‰å…¥å®Œæˆ");

            // å‹•æ…‹è¨­å®š API Base URL
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒ");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (currentHostname.includes("railway.app")) {
                API_BASE = currentOrigin + "/api";
                console.log("ğŸš‚ Railway ç’°å¢ƒ");
            } else {
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("ğŸŒ é è¨­ç’°å¢ƒ");
            }

            console.log("ğŸ“¡ API_BASE:", API_BASE);

            function getApiBase() {
                const currentHostname = window.location.hostname;
                const currentOrigin = window.location.origin;

                if (currentHostname.includes("github.io")) {
                    return "https://1140412connectproject-production.up.railway.app/api";
                } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                    // æœ¬åœ°é–‹ç™¼æ™‚ï¼Œå„ªå…ˆå˜—è©¦é ç«¯ API
                    return "https://1140412connectproject-production.up.railway.app/api";
                } else if (currentHostname.includes("railway.app")) {
                    return currentOrigin + "/api";
                } else {
                    return "https://1140412connectproject-production.up.railway.app/api";
                }
            }

            // å¯†ç¢¼é¡¯ç¤º/éš±è—åˆ‡æ›
            function togglePassword() {
                const passwordInput = document.getElementById("password");
                const passwordIcon = document.getElementById("passwordIcon");

                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    passwordIcon.className = "fas fa-eye-slash";
                } else {
                    passwordInput.type = "password";
                    passwordIcon.className = "fas fa-eye";
                }
            }

            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            function showError(message) {
                const errorMessage = document.getElementById("errorMessage");
                const errorText = document.getElementById("errorText");
                errorText.textContent = message;
                errorMessage.classList.add("show");

                // 3ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    errorMessage.classList.remove("show");
                }, 3000);
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            function showLoading(show = true) {
                const loadingMessage = document.getElementById("loadingMessage");
                const loginBtn = document.getElementById("loginBtn");

                if (show) {
                    loadingMessage.classList.add("show");
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é©—è­‰ä¸­...';
                } else {
                    loadingMessage.classList.remove("show");
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> é€²å…¥éŸ³æ¨‚ç³»çµ±';
                }
            }

            // é©—è­‰ä½¿ç”¨è€…
            async function validateUser(username, password) {
                try {
                    console.log("ğŸ” é–‹å§‹é©—è­‰ä½¿ç”¨è€…:", username);

                    // å–å¾— API Base URL
                    const API_BASE = getApiBase();
                    console.log("ğŸ“¡ ä½¿ç”¨ API_BASE:", API_BASE);

                    // å¾è³‡æ–™åº«æŸ¥è©¢ä½¿ç”¨è€…
                    const response = await fetch(`${API_BASE}/users`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        // æ·»åŠ è¶…æ™‚è™•ç†
                        signal: AbortSignal.timeout(10000), // 10ç§’è¶…æ™‚
                    });

                    if (!response.ok) {
                        throw new Error(`ç„¡æ³•é€£æ¥ä¼ºæœå™¨ (${response.status})`);
                    }

                    const users = await response.json();
                    console.log("ğŸ“Š å–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼Œå…±", users.length, "ä½ä½¿ç”¨è€…");

                    // æŸ¥æ‰¾ä½¿ç”¨è€…
                    const user = users.find((u) => u.user_name === username);
                    if (!user) {
                        throw new Error("æ‰¾ä¸åˆ°æ­¤ä½¿ç”¨è€…ï¼è«‹æª¢æŸ¥ä½¿ç”¨è€…åç¨±æ˜¯å¦æ­£ç¢º");
                    }

                    // ğŸ”§ ä¿®æ­£å¯†ç¢¼é©—è­‰é‚è¼¯
                    // æ”¯æ´å…©ç¨®å¯†ç¢¼ï¼š1. è³‡æ–™åº«ä¸­çš„å¯¦éš›å¯†ç¢¼ 2. è¬èƒ½å¯†ç¢¼ "super"
                    const isValidPassword = user.password === password || password === "super";

                    if (!isValidPassword) {
                        throw new Error("å¯†ç¢¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨æ‚¨çš„å¯†ç¢¼æˆ–è¬èƒ½å¯†ç¢¼ 'super'");
                    }

                    // è¨˜éŒ„ä½¿ç”¨çš„é©—è­‰æ–¹å¼
                    const authMethod = password === "super" ? "è¬èƒ½å¯†ç¢¼" : "å€‹äººå¯†ç¢¼";
                    console.log(`ğŸ” ä½¿ç”¨${authMethod}é©—è­‰æˆåŠŸ`);

                    // æª¢æŸ¥ä½¿ç”¨è€…ç‹€æ…‹
                    if (user.state === -1 || user.state === "-1") {
                        throw new Error("æ­¤å¸³è™Ÿå·²è¢«åœç”¨ï¼Œè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡");
                    }

                    console.log("âœ… ä½¿ç”¨è€…é©—è­‰æˆåŠŸ:", {
                        user_id: user.user_id,
                        user_name: user.user_name,
                        // ä¸è¨˜éŒ„å¯†ç¢¼
                    });

                    return user;
                } catch (error) {
                    console.error("âŒ ä½¿ç”¨è€…é©—è­‰å¤±æ•—:", error);

                    // æ”¹å–„éŒ¯èª¤è¨Šæ¯
                    if (error.name === "TypeError" && error.message.includes("fetch")) {
                        throw new Error("ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦");
                    } else if (error.name === "AbortError") {
                        throw new Error("é€£ç·šè¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ³å¾Œé‡è©¦");
                    }

                    throw error;
                }
            }

            // æ›´æ–°ä½¿ç”¨è€…ä½¿ç”¨æ™‚é–“ï¼ˆç™»å…¥æ™‚å¢åŠ 30ç§’ï¼‰
            async function updateUserLoginTime(user) {
                try {
                    console.log("â° æ›´æ–°ä½¿ç”¨è€…ç™»å…¥æ™‚é–“:", user.user_name);

                    const API_BASE = getApiBase();

                    // ğŸ”§ ä¿®æ­£ï¼šä¿æŒåŸæœ‰çš„ä½¿ç”¨æ™‚é–“ï¼Œåªæ›´æ–°ç™»å…¥æ™‚é–“
                    // å¦‚æœåŸæœ¬æœ‰ä½¿ç”¨æ™‚é–“ï¼Œä¿æŒä¸è®Šï¼›å¦‚æœæ²’æœ‰ï¼Œè¨­ç‚º 00:00:00
                    const currentUsageTime = user.usage_time || "00:00:00";

                    const updateData = {
                        table: "users",
                        user_id: parseInt(user.user_id),
                        user_name: user.user_name,
                        password: user.password,
                        email: user.email || "",
                        gender: user.gender || "",
                        usage_time: currentUsageTime, // ä¿æŒç¾æœ‰ä½¿ç”¨æ™‚é–“
                        state: user.state || 0,
                    };

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(updateData),
                        signal: AbortSignal.timeout(10000), // 10ç§’è¶…æ™‚
                    });

                    if (response.ok) {
                        console.log("âœ… ä½¿ç”¨è€…è³‡æ–™æ›´æ–°æˆåŠŸ");
                        return true;
                    } else {
                        const errorText = await response.text();
                        console.warn("âš ï¸ ä½¿ç”¨è€…è³‡æ–™æ›´æ–°å¤±æ•—:", errorText);
                        return false;
                    }
                } catch (error) {
                    console.warn("âš ï¸ æ›´æ–°ä½¿ç”¨è€…è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    return false; // ä¸é˜»æ“‹ç™»å…¥æµç¨‹
                }
            }

            // æ–°å¢éŠå®¢ç™»å…¥è™•ç†å‡½æ•¸
            function handleGuestLogin() {
                console.log("ğŸ‘¤ ä½¿ç”¨è€…é¸æ“‡éŠå®¢æ¨¡å¼");

                // è¨­å®šéŠå®¢æœƒè©±
                const guestInfo = {
                    user_name: "éŠå®¢",
                    login_time: new Date().toISOString(),
                    is_guest: true,
                };

                localStorage.setItem("kilin_guest_session", JSON.stringify(guestInfo));

                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const guestBtn = document.getElementById("guestBtn");
                guestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€²å…¥éŠå®¢æ¨¡å¼...';
                guestBtn.disabled = true;

                // å»¶é²è·³è½‰
                setTimeout(() => {
                    console.log("ğŸµ è·³è½‰åˆ°éŸ³æ¨‚ç³»çµ±ï¼ˆéŠå®¢æ¨¡å¼ï¼‰");
                    window.location.href = "sidebar.html";
                }, 1000);
            }

            // 6. æ–°å¢é€£ç·šæ¸¬è©¦åŠŸèƒ½
            async function testConnection() {
                try {
                    const API_BASE = getApiBase();
                    console.log("ğŸ” æ¸¬è©¦ API é€£ç·š:", API_BASE);

                    const response = await fetch(`${API_BASE}/users`, {
                        method: "HEAD", // åªæ¸¬è©¦é€£ç·šï¼Œä¸å–å¾—è³‡æ–™
                        signal: AbortSignal.timeout(5000),
                    });

                    if (response.ok) {
                        console.log("âœ… API é€£ç·šæ­£å¸¸");
                        return true;
                    } else {
                        console.warn("âš ï¸ API å›æ‡‰ç•°å¸¸:", response.status);
                        return false;
                    }
                } catch (error) {
                    console.error("âŒ API é€£ç·šå¤±æ•—:", error);
                    return false;
                }
            }

            // è™•ç†ç™»å…¥è¡¨å–®æäº¤
            document.getElementById("loginForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const username = document.getElementById("username").value.trim();
                const password = document.getElementById("password").value;

                // åŸºæœ¬é©—è­‰
                if (!username || !password) {
                    showError("è«‹è¼¸å…¥å®Œæ•´çš„å¸³è™Ÿå¯†ç¢¼è³‡è¨Š");
                    return;
                }

                // æª¢æŸ¥è¼¸å…¥é•·åº¦
                if (username.length < 2) {
                    showError("ä½¿ç”¨è€…åç¨±è‡³å°‘éœ€è¦2å€‹å­—å…ƒ");
                    return;
                }

                if (password.length < 1) {
                    showError("è«‹è¼¸å…¥å¯†ç¢¼");
                    return;
                }

                showLoading(true);

                try {
                    // é©—è­‰ä½¿ç”¨è€…
                    const user = await validateUser(username, password);

                    // æ›´æ–°ä½¿ç”¨è€…ç™»å…¥æ™‚é–“ï¼ˆä¸å¼·åˆ¶è¦æ±‚æˆåŠŸï¼‰
                    await updateUserLoginTime(user);

                    // å„²å­˜ä½¿ç”¨è€…è³‡è¨Šåˆ° localStorage
                    const userInfo = {
                        user_id: user.user_id,
                        user_name: user.user_name,
                        email: user.email || "",
                        gender: user.gender || "",
                        usage_time: user.usage_time || "00:00:00", // åŒ…å«ä½¿ç”¨æ™‚é–“
                        password: user.password, // å„²å­˜å¯†ç¢¼ä»¥ä¾¿å¾ŒçºŒæ›´æ–°
                        login_time: new Date().toISOString(),
                        session_id: Date.now(),
                    };

                    localStorage.setItem("kilin_user_session", JSON.stringify(userInfo));
                    console.log("ğŸ’¾ ä½¿ç”¨è€…æœƒè©±è³‡è¨Šå·²å„²å­˜");

                    // ç™»å…¥æˆåŠŸ
                    showLoading(false);
                    const loginBtn = document.getElementById("loginBtn");
                    loginBtn.innerHTML = '<i class="fas fa-check"></i> ç™»å…¥æˆåŠŸï¼';
                    loginBtn.style.background = "linear-gradient(135deg, #22c55e, #16a34a)";

                    // çŸ­æš«å»¶é²å¾Œè·³è½‰
                    setTimeout(() => {
                        console.log("ğŸµ è·³è½‰åˆ°éŸ³æ¨‚ç³»çµ±");
                        window.location.href = "sidebar.html";
                    }, 1500);
                } catch (error) {
                    showLoading(false);
                    showError(error.message);
                    console.error("âŒ ç™»å…¥å¤±æ•—:", error);
                }
            });

            // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            document.addEventListener("DOMContentLoaded", function () {
                // è¨­å®š API Base URL
                const API_BASE = getApiBase();
                console.log("ğŸ“¡ åˆå§‹åŒ– API_BASE:", API_BASE);

                // æª¢æŸ¥ç¾æœ‰æœƒè©±
                const existingSession = localStorage.getItem("kilin_user_session");
                const existingGuestSession = localStorage.getItem("kilin_guest_session");

                if (existingSession) {
                    try {
                        const userInfo = JSON.parse(existingSession);
                        console.log("ğŸ” ç™¼ç¾ç¾æœ‰æœƒè©±:", userInfo.user_name);

                        if (confirm(`æª¢æ¸¬åˆ°æ‚¨å·²ç™»å…¥ç‚º ${userInfo.user_name}ï¼Œæ˜¯å¦ç›´æ¥é€²å…¥éŸ³æ¨‚ç³»çµ±ï¼Ÿ`)) {
                            window.location.href = "sidebar.html";
                            return;
                        } else {
                            localStorage.removeItem("kilin_user_session");
                        }
                    } catch (error) {
                        console.warn("âš ï¸ æœƒè©±è³‡æ–™ç„¡æ•ˆï¼Œæ¸…é™¤ä¸¦é‡æ–°ç™»å…¥");
                        localStorage.removeItem("kilin_user_session");
                    }
                }

                if (existingGuestSession) {
                    try {
                        const guestInfo = JSON.parse(existingGuestSession);
                        console.log("ğŸ” ç™¼ç¾éŠå®¢æœƒè©±:", guestInfo.user_name);

                        if (confirm("æª¢æ¸¬åˆ°æ‚¨æœ‰éŠå®¢æœƒè©±ï¼Œæ˜¯å¦ç›´æ¥é€²å…¥éŸ³æ¨‚ç³»çµ±ï¼Ÿ")) {
                            window.location.href = "sidebar.html";
                            return;
                        } else {
                            localStorage.removeItem("kilin_guest_session");
                        }
                    } catch (error) {
                        console.warn("âš ï¸ éŠå®¢æœƒè©±è³‡æ–™ç„¡æ•ˆï¼Œæ¸…é™¤");
                        localStorage.removeItem("kilin_guest_session");
                    }
                }

                // è‡ªå‹•èšç„¦åˆ°ä½¿ç”¨è€…åç¨±è¼¸å…¥æ¡†
                document.getElementById("username").focus();
            });

            //  åœ¨é é¢è¼‰å…¥æ™‚æ¸¬è©¦é€£ç·š
            window.addEventListener("load", async () => {
                console.log("ğŸŒ æ¸¬è©¦ä¼ºæœå™¨é€£ç·š...");
                const isConnected = await testConnection();

                if (!isConnected) {
                    showError("ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•æ­£å¸¸ä½¿ç”¨");
                } else {
                    console.log("âœ… ä¼ºæœå™¨é€£ç·šæ­£å¸¸");
                }
            });

            // éµç›¤å¿«æ·éµæ”¯æ´
            document.addEventListener("keydown", function (e) {
                // ESC éµæ¸…é™¤è¡¨å–®
                if (e.key === "Escape") {
                    document.getElementById("loginForm").reset();
                    document.getElementById("username").focus();
                }
            });

            console.log("ğŸ” ç™»å…¥ç³»çµ±åˆå§‹åŒ–å®Œæˆ");
        </script>
    </body>
</html>
