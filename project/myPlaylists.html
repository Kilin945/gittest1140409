<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>我的播放清單</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: #222;
                color: white;
            }
            .playlist {
                border: 1px solid #444;
                margin: 10px 0;
                padding: 15px;
                border-radius: 5px;
            }
            .playlist h3 {
                margin: 0 0 10px 0;
                color: #ff6b35;
            }
            .songs {
                margin-left: 20px;
            }
            .song {
                padding: 5px 0;
                border-bottom: 1px solid #333;
            }
            .loading {
                text-align: center;
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <h1>我的播放清單</h1>
        <div id="content">載入中...</div>

        <script>
            // API 設定
            const API_BASE = "http://localhost:8000/api";

            // 動態取得當前登入使用者 ID
            const USER_ID = (() => {
                if (window.currentUserSession && window.currentUserSession.user_id) {
                    return String(window.currentUserSession.user_id); // 轉成字串
                }
                return "1"; // 預設值，測試用
            })();

            console.log("當前使用者 ID:", USER_ID);

            async function loadData() {
                try {
                    // 載入播放清單
                    const playlistsRes = await fetch(`${API_BASE}/playlists`);
                    const allPlaylists = await playlistsRes.json();
                    // 強制轉換為字串比較，確保過濾正確
                    const userPlaylists = allPlaylists.filter((p) => String(p.user_id) === String(USER_ID));

                    console.log(`所有播放清單數量: ${allPlaylists.length}`);
                    console.log(`使用者 ${USER_ID} 的播放清單數量: ${userPlaylists.length}`);

                    // 載入歌手資料
                    const artistsRes = await fetch(`${API_BASE}/artists`);
                    const artists = await artistsRes.json();
                    const artistMap = {};
                    artists.forEach((a) => (artistMap[a.artist_id] = a.artist_name));

                    // 載入歌曲資料
                    const songsRes = await fetch(`${API_BASE}/songs`);
                    const allSongs = await songsRes.json();

                    let html = "";

                    for (const playlist of userPlaylists) {
                        // 取得這個播放清單的歌曲
                        const playlistSongsRes = await fetch(
                            `${API_BASE}/playlist_songs?playlist_id=${playlist.playlist_id}`
                        );
                        const playlistSongs = await playlistSongsRes.json();

                        html += `<div class="playlist">`;
                        html += `<h3>${playlist.playlist_name} (${playlistSongs.length} 首歌)</h3>`;
                        html += `<div class="songs">`;

                        if (playlistSongs.length === 0) {
                            html += `<div class="song">沒有歌曲</div>`;
                        } else {
                            playlistSongs.forEach((ps) => {
                                const song = allSongs.find((s) => s.song_id == ps.song_id);
                                if (song) {
                                    const artistName = artistMap[song.artist_id] || "未知歌手";
                                    html += `<div class="song">${song.song_name} - ${artistName}</div>`;
                                }
                            });
                        }

                        html += `</div></div>`;
                    }

                    if (userPlaylists.length === 0) {
                        html = "<p>沒有播放清單</p>";
                    }

                    document.getElementById("content").innerHTML = html;
                } catch (error) {
                    document.getElementById("content").innerHTML = `錯誤: ${error.message}`;
                }
            }

            // 頁面載入後執行
            loadData();
        </script>
    </body>
</html>
