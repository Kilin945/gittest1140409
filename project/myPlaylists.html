<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>我的播放清單</title>
        <!-- Font Awesome 圖標庫 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            /* 播放清單卡片樣式 */
            .playlist-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .playlist-card {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 107, 53, 0.3);
                border-radius: 12px;
                padding: 20px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }

            .playlist-card::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(135deg, #ff6b35, #ff8c69);
                transform: scaleY(0);
                transition: transform 0.3s ease;
            }

            .playlist-card:hover {
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                border-color: #ff6b35;
            }

            .playlist-card:hover::before {
                transform: scaleY(1);
            }

            .playlist-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 15px;
            }

            .playlist-title {
                font-size: 1.3rem;
                font-weight: 700;
                color: #ffffff;
                margin: 0;
                flex: 1;
                word-break: break-word;
            }

            .playlist-privacy {
                background: rgba(255, 107, 53, 0.2);
                color: #ff6b35;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.8rem;
                font-weight: 600;
                margin-left: 10px;
                white-space: nowrap;
            }

            .playlist-privacy.public {
                background: rgba(76, 175, 80, 0.2);
                color: #4caf50;
            }

            .playlist-stats {
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
                font-size: 0.9rem;
                color: rgba(255, 255, 255, 0.7);
            }

            .stat-item {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .playlist-actions {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .action-btn {
                padding: 8px 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: 600;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 6px;
                flex: 1;
                justify-content: center;
                min-width: 80px;
            }

            .btn-play {
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
                color: white;
            }

            .btn-play:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            }

            .btn-edit {
                background: rgba(33, 150, 243, 0.8);
                color: white;
            }

            .btn-edit:hover {
                background: rgba(33, 150, 243, 1);
                transform: scale(1.05);
            }

            .btn-delete {
                background: rgba(244, 67, 54, 0.8);
                color: white;
            }

            .btn-delete:hover {
                background: rgba(244, 67, 54, 1);
                transform: scale(1.05);
            }

            /* 空狀態樣式 */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: rgba(255, 255, 255, 0.7);
            }

            .empty-state i {
                font-size: 4rem;
                margin-bottom: 20px;
                opacity: 0.3;
            }

            .empty-state h3 {
                color: #ffffff;
                margin-bottom: 15px;
            }

            .create-playlist-btn {
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                cursor: pointer;
                font-weight: 600;
                margin-top: 20px;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .create-playlist-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            }

            /* 載入狀態 */
            .loading {
                text-align: center;
                padding: 40px;
                color: rgba(255, 255, 255, 0.7);
            }

            .loading i {
                font-size: 2rem;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }

            /* 頁面標題 */
            .page-header {
                text-align: center;
                margin-bottom: 30px;
                padding: 20px 0;
            }

            .page-title {
                font-size: 2.5rem;
                font-weight: 700;
                color: #ffffff;
                background: linear-gradient(135deg, #ff6b35, #ff8c69);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin: 0 0 10px 0;
            }

            .page-subtitle {
                color: rgba(255, 255, 255, 0.7);
                font-size: 1.1rem;
                margin: 0;
            }

            /* 統計資訊 */
            .stats-bar {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 107, 53, 0.3);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 30px;
                display: flex;
                justify-content: space-around;
                gap: 20px;
                flex-wrap: wrap;
            }

            .stat-box {
                text-align: center;
                flex: 1;
                min-width: 120px;
            }

            .stat-number {
                font-size: 2rem;
                font-weight: 700;
                color: #ff6b35;
                display: block;
            }

            .stat-label {
                color: rgba(255, 255, 255, 0.7);
                font-size: 0.9rem;
                margin-top: 5px;
            }

            /* 響應式設計 */
            @media (max-width: 768px) {
                .playlist-grid {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }

                .page-title {
                    font-size: 2rem;
                }

                .stats-bar {
                    flex-direction: column;
                    gap: 15px;
                }

                .playlist-actions {
                    flex-direction: column;
                }

                .action-btn {
                    flex: none;
                }
            }

            /* 遊客模式提示 */
            .guest-notice {
                background: linear-gradient(135deg, #6c757d, #495057);
                color: white;
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 30px;
                text-align: center;
                border: 1px solid rgba(108, 117, 125, 0.3);
            }

            .guest-notice i {
                font-size: 2rem;
                margin-bottom: 15px;
                opacity: 0.8;
            }

            .guest-notice h3 {
                margin: 0 0 10px 0;
                font-size: 1.3rem;
            }

            .guest-notice p {
                margin: 0;
                opacity: 0.9;
            }
        </style>
    </head>
    <body>
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-headphones"></i>
                我的播放清單
            </h1>
            <p class="page-subtitle">管理和播放您的音樂收藏</p>
        </div>

        <!-- 遊客模式提示 -->
        <div class="guest-notice" id="guestNotice" style="display: none">
            <i class="fas fa-info-circle"></i>
            <h3>遊客模式</h3>
            <p>您目前以遊客身份瀏覽，無法查看個人播放清單。請註冊並登入以享受完整功能。</p>
        </div>

        <!-- 統計資訊欄 -->
        <div class="stats-bar" id="statsBar" style="display: none">
            <div class="stat-box">
                <span class="stat-number" id="totalPlaylists">0</span>
                <div class="stat-label">播放清單</div>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="totalSongs">0</span>
                <div class="stat-label">總歌曲數</div>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="publicPlaylists">0</span>
                <div class="stat-label">公開清單</div>
            </div>
        </div>

        <!-- 載入狀態 -->
        <div class="loading" id="loadingState">
            <i class="fas fa-spinner"></i>
            <p>載入播放清單中...</p>
        </div>

        <!-- 播放清單網格 -->
        <div class="playlist-grid" id="playlistGrid" style="display: none"></div>

        <!-- 空狀態 -->
        <div class="empty-state" id="emptyState" style="display: none">
            <i class="fas fa-music"></i>
            <h3>還沒有播放清單</h3>
            <p>建立您的第一個播放清單，開始收藏喜愛的音樂</p>
            <button class="create-playlist-btn" onclick="createNewPlaylist()">
                <i class="fas fa-plus"></i>
                建立播放清單
            </button>
        </div>

        <script>
            console.log("🎵 我的播放清單頁面初始化");

            // 🔧 動態設定 API Base URL
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("☁️ GitHub Pages 環境，使用 Railway 後端");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                API_BASE = "http://localhost:8000/api";
                console.log("🏠 本地開發環境");
            } else if (currentHostname.includes("railway.app")) {
                API_BASE = currentOrigin + "/api";
                console.log("🚂 Railway 環境，使用相對路徑");
            } else {
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("🌐 未知環境，預設使用 Railway 後端");
            }

            console.log("📡 最終 API_BASE:", API_BASE);

            // 全域變數
            let currentUser = null;
            let isGuestMode = false;
            let allPlaylists = [];
            let allSongs = [];

            // 從父頁面注入的使用者資訊
            if (window.currentUser) {
                currentUser = window.currentUser;
                isGuestMode = window.isGuestMode || false;
            } else {
                try {
                    const sessionData = localStorage.getItem("kilin_user_session");
                    const guestData = localStorage.getItem("kilin_guest_session");

                    if (guestData) {
                        isGuestMode = true;
                        currentUser = JSON.parse(guestData);
                    } else if (sessionData) {
                        isGuestMode = false;
                        currentUser = JSON.parse(sessionData);
                    }
                } catch (error) {
                    console.error("讀取使用者資訊失敗:", error);
                }
            }

            // 初始化頁面
            async function initializePage() {
                if (isGuestMode || !currentUser || currentUser.is_guest) {
                    showGuestNotice();
                    return;
                }

                try {
                    await loadAllData();

                    const userPlaylists = allPlaylists.filter(
                        (playlist) => String(playlist.user_id) === String(currentUser.user_id)
                    );

                    if (userPlaylists.length === 0) {
                        updateStatistics(userPlaylists);
                        displayPlaylists(userPlaylists);
                        return;
                    }

                    await loadPlaylistSongCounts(userPlaylists);
                    updateStatistics(userPlaylists);
                    displayPlaylists(userPlaylists);
                } catch (error) {
                    showError("載入播放清單失敗");
                }
            }

            // 顯示遊客模式提示
            function showGuestNotice() {
                document.getElementById("loadingState").style.display = "none";
                document.getElementById("guestNotice").style.display = "block";
            }

            // 載入所有必要資料
            async function loadAllData() {
                const playlistsResponse = await fetch(`${API_BASE}/playlists`);
                if (!playlistsResponse.ok) throw new Error("載入播放清單失敗");
                allPlaylists = await playlistsResponse.json();

                try {
                    const songsResponse = await fetch(`${API_BASE}/songs`);
                    if (songsResponse.ok) {
                        allSongs = await songsResponse.json();
                    } else {
                        allSongs = [];
                    }
                } catch (error) {
                    allSongs = [];
                }
            }

            // 載入播放清單歌曲數量
            async function loadPlaylistSongCounts(userPlaylists) {
                for (const playlist of userPlaylists) {
                    try {
                        const response = await fetch(`${API_BASE}/playlist_songs?playlist_id=${playlist.playlist_id}`);

                        if (response.ok) {
                            const responseText = await response.text();

                            if (responseText.trim() === "") {
                                playlist.songCount = 0;
                            } else {
                                try {
                                    const songs = JSON.parse(responseText);
                                    playlist.songCount = songs.length;
                                } catch (jsonError) {
                                    playlist.songCount = 0;
                                }
                            }
                        } else {
                            playlist.songCount = 0;
                        }
                    } catch (error) {
                        playlist.songCount = 0;
                    }

                    await new Promise((resolve) => setTimeout(resolve, 100));
                }
            }

            // 更新統計資訊
            function updateStatistics(userPlaylists) {
                const totalPlaylists = userPlaylists.length;
                const totalSongs = userPlaylists.reduce((sum, playlist) => sum + (playlist.songCount || 0), 0);
                const publicPlaylists = userPlaylists.filter(
                    (playlist) => playlist.is_public === "true" || playlist.is_public === true
                ).length;

                document.getElementById("totalPlaylists").textContent = totalPlaylists;
                document.getElementById("totalSongs").textContent = totalSongs;
                document.getElementById("publicPlaylists").textContent = publicPlaylists;

                if (totalPlaylists > 0) {
                    document.getElementById("statsBar").style.display = "flex";
                }
            }

            // 顯示播放清單
            function displayPlaylists(userPlaylists) {
                const loadingState = document.getElementById("loadingState");
                const playlistGrid = document.getElementById("playlistGrid");
                const emptyState = document.getElementById("emptyState");

                loadingState.style.display = "none";

                if (userPlaylists.length === 0) {
                    emptyState.style.display = "block";
                    playlistGrid.style.display = "none";
                    return;
                }

                emptyState.style.display = "none";
                playlistGrid.style.display = "grid";
                playlistGrid.innerHTML = "";

                userPlaylists.forEach((playlist) => {
                    const playlistCard = createPlaylistCard(playlist);
                    playlistGrid.appendChild(playlistCard);
                });
            }

            // 建立播放清單卡片
            function createPlaylistCard(playlist) {
                const card = document.createElement("div");
                card.className = "playlist-card";
                card.dataset.playlistId = playlist.playlist_id;

                const isPublic = playlist.is_public === "true" || playlist.is_public === true;
                const privacyIcon = isPublic ? "🌐" : "🔒";
                const privacyText = isPublic ? "公開" : "私人";
                const privacyClass = isPublic ? "public" : "private";

                card.innerHTML = `
                    <div class="playlist-header">
                        <h3 class="playlist-title">${escapeHtml(playlist.playlist_name)}</h3>
                        <span class="playlist-privacy ${privacyClass}">
                            ${privacyIcon} ${privacyText}
                        </span>
                    </div>
                    
                    <div class="playlist-stats">
                        <div class="stat-item">
                            <i class="fas fa-music"></i>
                            <span>${playlist.songCount || 0} 首歌曲</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-calendar"></i>
                            <span>播放清單 #${playlist.playlist_id}</span>
                        </div>
                    </div>
                    
                    <div class="playlist-actions">
                        <button class="action-btn btn-play" onclick="playPlaylist(${playlist.playlist_id})" 
                                ${(playlist.songCount || 0) === 0 ? "disabled" : ""}>
                            <i class="fas fa-play"></i>
                            播放
                        </button>
                        <button class="action-btn btn-edit" onclick="editPlaylist(${playlist.playlist_id})">
                            <i class="fas fa-edit"></i>
                            編輯
                        </button>
                        <button class="action-btn btn-delete" onclick="deletePlaylist(${
                            playlist.playlist_id
                        }, '${escapeHtml(playlist.playlist_name)}')">
                            <i class="fas fa-trash"></i>
                            刪除
                        </button>
                    </div>
                `;

                return card;
            }

            // HTML 轉義函數
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // 播放播放清單
            function playPlaylist(playlistId) {
                const playUrl = `sidebar.html?target=playMusic.html&playlist=${playlistId}`;
                window.location.href = playUrl;
            }

            // 編輯播放清單
            function editPlaylist(playlistId) {
                alert("編輯功能開發中，敬請期待！");
            }

            // 刪除播放清單
            async function deletePlaylist(playlistId, playlistName) {
                const confirmMessage = `確定要刪除播放清單「${playlistName}」嗎？\n\n此操作無法復原！`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    const playlistToDelete = allPlaylists.find((p) => p.playlist_id == playlistId);
                    if (!playlistToDelete) {
                        throw new Error("找不到要刪除的播放清單");
                    }

                    const updateData = {
                        table: "playlists",
                        playlist_id: parseInt(playlistId),
                        playlist_name: playlistName,
                        user_id: parseInt(currentUser.user_id),
                        is_public: playlistToDelete.is_public === "true" || playlistToDelete.is_public === true,
                        state: "-1",
                    };

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(updateData),
                    });

                    if (response.ok) {
                        alert(`✅ 播放清單「${playlistName}」已刪除`);
                        await initializePage();
                    } else {
                        const errorText = await response.text();
                        throw new Error(`刪除失敗 (${response.status}): ${errorText}`);
                    }
                } catch (error) {
                    alert(`❌ 刪除失敗: ${error.message}`);
                }
            }

            // 建立新播放清單
            function createNewPlaylist() {
                window.location.href = "sidebar.html?target=insertPlaylists.html";
            }

            // 顯示錯誤訊息
            function showError(message) {
                const loadingState = document.getElementById("loadingState");
                loadingState.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: #ff6b35; animation: none;"></i>
                    <p style="color: #ff6b35;">${message}</p>
                    <button onclick="initializePage()" style="
                        background: #ff6b35; 
                        color: white; 
                        border: none; 
                        padding: 10px 20px; 
                        border-radius: 8px; 
                        cursor: pointer;
                        margin-top: 15px;
                    ">
                        <i class="fas fa-redo"></i> 重新載入
                    </button>
                `;
            }

            // 頁面載入後初始化
            document.addEventListener("DOMContentLoaded", () => {
                setTimeout(() => {
                    initializePage();
                }, 500);
            });
        </script>
    </body>
</html>
