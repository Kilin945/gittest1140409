<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>æˆ‘çš„æ’­æ”¾æ¸…å–®</title>
        <!-- Font Awesome åœ–æ¨™åº« -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="main.css" />
        <style>
            /* æ’­æ”¾æ¸…å–®å¡ç‰‡æ¨£å¼ */
            .playlist-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .playlist-card {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 107, 53, 0.3);
                border-radius: 12px;
                padding: 20px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }

            .playlist-card::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(135deg, #ff6b35, #ff8c69);
                transform: scaleY(0);
                transition: transform 0.3s ease;
            }

            .playlist-card:hover {
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                border-color: #ff6b35;
            }

            .playlist-card:hover::before {
                transform: scaleY(1);
            }

            .playlist-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 15px;
            }

            .playlist-title {
                font-size: 1.3rem;
                font-weight: 700;
                color: #ffffff;
                margin: 0;
                flex: 1;
                word-break: break-word;
            }

            .playlist-privacy {
                background: rgba(255, 107, 53, 0.2);
                color: #ff6b35;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.8rem;
                font-weight: 600;
                margin-left: 10px;
                white-space: nowrap;
            }

            .playlist-privacy.public {
                background: rgba(76, 175, 80, 0.2);
                color: #4caf50;
            }

            .playlist-stats {
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
                font-size: 0.9rem;
                color: rgba(255, 255, 255, 0.7);
            }

            .stat-item {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .playlist-actions {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .action-btn {
                padding: 8px 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: 600;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 6px;
                flex: 1;
                justify-content: center;
                min-width: 80px;
            }

            .btn-play {
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
                color: white;
            }

            .btn-play:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            }

            .btn-edit {
                background: rgba(33, 150, 243, 0.8);
                color: white;
            }

            .btn-edit:hover {
                background: rgba(33, 150, 243, 1);
                transform: scale(1.05);
            }

            .btn-delete {
                background: rgba(244, 67, 54, 0.8);
                color: white;
            }

            .btn-delete:hover {
                background: rgba(244, 67, 54, 1);
                transform: scale(1.05);
            }

            /* ç©ºç‹€æ…‹æ¨£å¼ */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: rgba(255, 255, 255, 0.7);
            }

            .empty-state i {
                font-size: 4rem;
                margin-bottom: 20px;
                opacity: 0.3;
            }

            .empty-state h3 {
                color: #ffffff;
                margin-bottom: 15px;
            }

            .create-playlist-btn {
                background: linear-gradient(135deg, #ff6b35, #e55a2e);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                cursor: pointer;
                font-weight: 600;
                margin-top: 20px;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .create-playlist-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            }

            /* è¼‰å…¥ç‹€æ…‹ */
            .loading {
                text-align: center;
                padding: 40px;
                color: rgba(255, 255, 255, 0.7);
            }

            .loading i {
                font-size: 2rem;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }

            /* é é¢æ¨™é¡Œ */
            .page-header {
                text-align: center;
                margin-bottom: 30px;
                padding: 20px 0;
            }

            .page-title {
                font-size: 2.5rem;
                font-weight: 700;
                color: #ffffff;
                background: linear-gradient(135deg, #ff6b35, #ff8c69);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin: 0 0 10px 0;
            }

            .page-subtitle {
                color: rgba(255, 255, 255, 0.7);
                font-size: 1.1rem;
                margin: 0;
            }

            /* çµ±è¨ˆè³‡è¨Š */
            .stats-bar {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 107, 53, 0.3);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 30px;
                display: flex;
                justify-content: space-around;
                gap: 20px;
                flex-wrap: wrap;
            }

            .stat-box {
                text-align: center;
                flex: 1;
                min-width: 120px;
            }

            .stat-number {
                font-size: 2rem;
                font-weight: 700;
                color: #ff6b35;
                display: block;
            }

            .stat-label {
                color: rgba(255, 255, 255, 0.7);
                font-size: 0.9rem;
                margin-top: 5px;
            }

            /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
            @media (max-width: 768px) {
                .playlist-grid {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }

                .page-title {
                    font-size: 2rem;
                }

                .stats-bar {
                    flex-direction: column;
                    gap: 15px;
                }

                .playlist-actions {
                    flex-direction: column;
                }

                .action-btn {
                    flex: none;
                }
            }

            /* éŠå®¢æ¨¡å¼æç¤º */
            .guest-notice {
                background: linear-gradient(135deg, #6c757d, #495057);
                color: white;
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 30px;
                text-align: center;
                border: 1px solid rgba(108, 117, 125, 0.3);
            }

            .guest-notice i {
                font-size: 2rem;
                margin-bottom: 15px;
                opacity: 0.8;
            }

            .guest-notice h3 {
                margin: 0 0 10px 0;
                font-size: 1.3rem;
            }

            .guest-notice p {
                margin: 0;
                opacity: 0.9;
            }
        </style>
    </head>
    <body>
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-headphones"></i>
                æˆ‘çš„æ’­æ”¾æ¸…å–®
            </h1>
            <p class="page-subtitle">ç®¡ç†å’Œæ’­æ”¾æ‚¨çš„éŸ³æ¨‚æ”¶è—</p>
        </div>

        <!-- éŠå®¢æ¨¡å¼æç¤º -->
        <div class="guest-notice" id="guestNotice" style="display: none">
            <i class="fas fa-info-circle"></i>
            <h3>éŠå®¢æ¨¡å¼</h3>
            <p>æ‚¨ç›®å‰ä»¥éŠå®¢èº«ä»½ç€è¦½ï¼Œç„¡æ³•æŸ¥çœ‹å€‹äººæ’­æ”¾æ¸…å–®ã€‚è«‹è¨»å†Šä¸¦ç™»å…¥ä»¥äº«å—å®Œæ•´åŠŸèƒ½ã€‚</p>
        </div>

        <!-- çµ±è¨ˆè³‡è¨Šæ¬„ -->
        <div class="stats-bar" id="statsBar" style="display: none">
            <div class="stat-box">
                <span class="stat-number" id="totalPlaylists">0</span>
                <div class="stat-label">æ’­æ”¾æ¸…å–®</div>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="totalSongs">0</span>
                <div class="stat-label">ç¸½æ­Œæ›²æ•¸</div>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="publicPlaylists">0</span>
                <div class="stat-label">å…¬é–‹æ¸…å–®</div>
            </div>
        </div>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div class="loading" id="loadingState">
            <i class="fas fa-spinner"></i>
            <p>è¼‰å…¥æ’­æ”¾æ¸…å–®ä¸­...</p>
        </div>

        <!-- æ’­æ”¾æ¸…å–®ç¶²æ ¼ -->
        <div class="playlist-grid" id="playlistGrid" style="display: none"></div>

        <!-- ç©ºç‹€æ…‹ -->
        <div class="empty-state" id="emptyState" style="display: none">
            <i class="fas fa-music"></i>
            <h3>é‚„æ²’æœ‰æ’­æ”¾æ¸…å–®</h3>
            <p>å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹æ’­æ”¾æ¸…å–®ï¼Œé–‹å§‹æ”¶è—å–œæ„›çš„éŸ³æ¨‚</p>
            <button class="create-playlist-btn" onclick="createNewPlaylist()">
                <i class="fas fa-plus"></i>
                å»ºç«‹æ’­æ”¾æ¸…å–®
            </button>
        </div>

        <script>
            console.log("ğŸµ æˆ‘çš„æ’­æ”¾æ¸…å–®é é¢åˆå§‹åŒ–");

            // ğŸ”§ å‹•æ…‹è¨­å®š API Base URL
            const currentHostname = window.location.hostname;
            const currentOrigin = window.location.origin;

            let API_BASE;
            if (currentHostname.includes("github.io")) {
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("â˜ï¸ GitHub Pages ç’°å¢ƒï¼Œä½¿ç”¨ Railway å¾Œç«¯");
            } else if (currentHostname === "localhost" || currentHostname === "127.0.0.1") {
                API_BASE = "http://localhost:8000/api";
                console.log("ğŸ  æœ¬åœ°é–‹ç™¼ç’°å¢ƒ");
            } else if (currentHostname.includes("railway.app")) {
                API_BASE = currentOrigin + "/api";
                console.log("ğŸš‚ Railway ç’°å¢ƒï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘");
            } else {
                API_BASE = "https://1140412connectproject-production.up.railway.app/api";
                console.log("ğŸŒ æœªçŸ¥ç’°å¢ƒï¼Œé è¨­ä½¿ç”¨ Railway å¾Œç«¯");
            }

            console.log("ğŸ“¡ æœ€çµ‚ API_BASE:", API_BASE);

            // å…¨åŸŸè®Šæ•¸
            let currentUser = null;
            let isGuestMode = false;
            let allPlaylists = [];
            let allSongs = [];

            // å¾çˆ¶é é¢æ³¨å…¥çš„ä½¿ç”¨è€…è³‡è¨Š
            if (window.currentUser) {
                currentUser = window.currentUser;
                isGuestMode = window.isGuestMode || false;
            } else {
                try {
                    const sessionData = localStorage.getItem("kilin_user_session");
                    const guestData = localStorage.getItem("kilin_guest_session");

                    if (guestData) {
                        isGuestMode = true;
                        currentUser = JSON.parse(guestData);
                    } else if (sessionData) {
                        isGuestMode = false;
                        currentUser = JSON.parse(sessionData);
                    }
                } catch (error) {
                    console.error("è®€å–ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:", error);
                }
            }

            // åˆå§‹åŒ–é é¢
            async function initializePage() {
                if (isGuestMode || !currentUser || currentUser.is_guest) {
                    showGuestNotice();
                    return;
                }

                try {
                    await loadAllData();

                    const userPlaylists = allPlaylists.filter(
                        (playlist) => String(playlist.user_id) === String(currentUser.user_id)
                    );

                    if (userPlaylists.length === 0) {
                        updateStatistics(userPlaylists);
                        displayPlaylists(userPlaylists);
                        return;
                    }

                    await loadPlaylistSongCounts(userPlaylists);
                    updateStatistics(userPlaylists);
                    displayPlaylists(userPlaylists);
                } catch (error) {
                    showError("è¼‰å…¥æ’­æ”¾æ¸…å–®å¤±æ•—");
                }
            }

            // é¡¯ç¤ºéŠå®¢æ¨¡å¼æç¤º
            function showGuestNotice() {
                document.getElementById("loadingState").style.display = "none";
                document.getElementById("guestNotice").style.display = "block";
            }

            // è¼‰å…¥æ‰€æœ‰å¿…è¦è³‡æ–™
            async function loadAllData() {
                const playlistsResponse = await fetch(`${API_BASE}/playlists`);
                if (!playlistsResponse.ok) throw new Error("è¼‰å…¥æ’­æ”¾æ¸…å–®å¤±æ•—");
                allPlaylists = await playlistsResponse.json();

                try {
                    const songsResponse = await fetch(`${API_BASE}/songs`);
                    if (songsResponse.ok) {
                        allSongs = await songsResponse.json();
                    } else {
                        allSongs = [];
                    }
                } catch (error) {
                    allSongs = [];
                }
            }

            // è¼‰å…¥æ’­æ”¾æ¸…å–®æ­Œæ›²æ•¸é‡
            async function loadPlaylistSongCounts(userPlaylists) {
                for (const playlist of userPlaylists) {
                    try {
                        const response = await fetch(`${API_BASE}/playlist_songs?playlist_id=${playlist.playlist_id}`);

                        if (response.ok) {
                            const responseText = await response.text();

                            if (responseText.trim() === "") {
                                playlist.songCount = 0;
                            } else {
                                try {
                                    const songs = JSON.parse(responseText);
                                    playlist.songCount = songs.length;
                                } catch (jsonError) {
                                    playlist.songCount = 0;
                                }
                            }
                        } else {
                            playlist.songCount = 0;
                        }
                    } catch (error) {
                        playlist.songCount = 0;
                    }

                    await new Promise((resolve) => setTimeout(resolve, 100));
                }
            }

            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            function updateStatistics(userPlaylists) {
                const totalPlaylists = userPlaylists.length;
                const totalSongs = userPlaylists.reduce((sum, playlist) => sum + (playlist.songCount || 0), 0);
                const publicPlaylists = userPlaylists.filter(
                    (playlist) => playlist.is_public === "true" || playlist.is_public === true
                ).length;

                document.getElementById("totalPlaylists").textContent = totalPlaylists;
                document.getElementById("totalSongs").textContent = totalSongs;
                document.getElementById("publicPlaylists").textContent = publicPlaylists;

                if (totalPlaylists > 0) {
                    document.getElementById("statsBar").style.display = "flex";
                }
            }

            // é¡¯ç¤ºæ’­æ”¾æ¸…å–®
            function displayPlaylists(userPlaylists) {
                const loadingState = document.getElementById("loadingState");
                const playlistGrid = document.getElementById("playlistGrid");
                const emptyState = document.getElementById("emptyState");

                loadingState.style.display = "none";

                if (userPlaylists.length === 0) {
                    emptyState.style.display = "block";
                    playlistGrid.style.display = "none";
                    return;
                }

                emptyState.style.display = "none";
                playlistGrid.style.display = "grid";
                playlistGrid.innerHTML = "";

                userPlaylists.forEach((playlist) => {
                    const playlistCard = createPlaylistCard(playlist);
                    playlistGrid.appendChild(playlistCard);
                });
            }

            // å»ºç«‹æ’­æ”¾æ¸…å–®å¡ç‰‡
            function createPlaylistCard(playlist) {
                const card = document.createElement("div");
                card.className = "playlist-card";
                card.dataset.playlistId = playlist.playlist_id;

                const isPublic = playlist.is_public === "true" || playlist.is_public === true;
                const privacyIcon = isPublic ? "ğŸŒ" : "ğŸ”’";
                const privacyText = isPublic ? "å…¬é–‹" : "ç§äºº";
                const privacyClass = isPublic ? "public" : "private";

                card.innerHTML = `
                    <div class="playlist-header">
                        <h3 class="playlist-title">${escapeHtml(playlist.playlist_name)}</h3>
                        <span class="playlist-privacy ${privacyClass}">
                            ${privacyIcon} ${privacyText}
                        </span>
                    </div>
                    
                    <div class="playlist-stats">
                        <div class="stat-item">
                            <i class="fas fa-music"></i>
                            <span>${playlist.songCount || 0} é¦–æ­Œæ›²</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-calendar"></i>
                            <span>æ’­æ”¾æ¸…å–® #${playlist.playlist_id}</span>
                        </div>
                    </div>
                    
                    <div class="playlist-actions">
                        <button class="action-btn btn-play" onclick="playPlaylist(${playlist.playlist_id})" 
                                ${(playlist.songCount || 0) === 0 ? "disabled" : ""}>
                            <i class="fas fa-play"></i>
                            æ’­æ”¾
                        </button>
                        <button class="action-btn btn-edit" onclick="editPlaylist(${playlist.playlist_id})">
                            <i class="fas fa-edit"></i>
                            ç·¨è¼¯
                        </button>
                        <button class="action-btn btn-delete" onclick="deletePlaylist(${
                            playlist.playlist_id
                        }, '${escapeHtml(playlist.playlist_name)}')">
                            <i class="fas fa-trash"></i>
                            åˆªé™¤
                        </button>
                    </div>
                `;

                return card;
            }

            // HTML è½‰ç¾©å‡½æ•¸
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // æ’­æ”¾æ’­æ”¾æ¸…å–®
            function playPlaylist(playlistId) {
                const playUrl = `sidebar.html?target=playMusic.html&playlist=${playlistId}`;
                window.location.href = playUrl;
            }

            // ç·¨è¼¯æ’­æ”¾æ¸…å–®
            function editPlaylist(playlistId) {
                alert("ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼");
            }

            // åˆªé™¤æ’­æ”¾æ¸…å–®
            async function deletePlaylist(playlistId, playlistName) {
                const confirmMessage = `ç¢ºå®šè¦åˆªé™¤æ’­æ”¾æ¸…å–®ã€Œ${playlistName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    const playlistToDelete = allPlaylists.find((p) => p.playlist_id == playlistId);
                    if (!playlistToDelete) {
                        throw new Error("æ‰¾ä¸åˆ°è¦åˆªé™¤çš„æ’­æ”¾æ¸…å–®");
                    }

                    const updateData = {
                        table: "playlists",
                        playlist_id: parseInt(playlistId),
                        playlist_name: playlistName,
                        user_id: parseInt(currentUser.user_id),
                        is_public: playlistToDelete.is_public === "true" || playlistToDelete.is_public === true,
                        state: "-1",
                    };

                    const response = await fetch(`${API_BASE}/2/update`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(updateData),
                    });

                    if (response.ok) {
                        alert(`âœ… æ’­æ”¾æ¸…å–®ã€Œ${playlistName}ã€å·²åˆªé™¤`);
                        await initializePage();
                    } else {
                        const errorText = await response.text();
                        throw new Error(`åˆªé™¤å¤±æ•— (${response.status}): ${errorText}`);
                    }
                } catch (error) {
                    alert(`âŒ åˆªé™¤å¤±æ•—: ${error.message}`);
                }
            }

            // å»ºç«‹æ–°æ’­æ”¾æ¸…å–®
            function createNewPlaylist() {
                window.location.href = "sidebar.html?target=insertPlaylists.html";
            }

            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            function showError(message) {
                const loadingState = document.getElementById("loadingState");
                loadingState.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: #ff6b35; animation: none;"></i>
                    <p style="color: #ff6b35;">${message}</p>
                    <button onclick="initializePage()" style="
                        background: #ff6b35; 
                        color: white; 
                        border: none; 
                        padding: 10px 20px; 
                        border-radius: 8px; 
                        cursor: pointer;
                        margin-top: 15px;
                    ">
                        <i class="fas fa-redo"></i> é‡æ–°è¼‰å…¥
                    </button>
                `;
            }

            // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
            document.addEventListener("DOMContentLoaded", () => {
                setTimeout(() => {
                    initializePage();
                }, 500);
            });
        </script>
    </body>
</html>
